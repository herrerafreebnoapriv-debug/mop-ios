# 二维码版本10（271字符）分析报告

## 问题分析

### 当前状态
- **优化后数据长度**: 432字符（只存储房间ID + 压缩）
- **目标**: ≤271字符（版本10）
- **差距**: 161字符

### 根本原因
**RSA-2048签名Base64编码**: 约344字符（固定，无法优化）

即使JSON数据只有10字符：
- JSON: 10字符
- 签名: 344字符
- 组合Base64: 约354字符
- 压缩后: 约350字符（签名是随机数据，压缩效果差）

**结论**: 使用RSA-2048签名，**无法降到271字符以下**。

## 解决方案

### 方案1: 使用RSA-1024（不推荐）
- **签名长度**: 约172字符（Base64）
- **总长度**: 约180字符（JSON 10字符 + 签名172字符）
- **优点**: 可以达到版本10
- **缺点**: 安全性降低（1024位密钥已不推荐）

### 方案2: 使用ECDSA-256（推荐）
- **签名长度**: 约88字符（Base64）
- **总长度**: 约100字符（JSON 10字符 + 签名88字符）
- **优点**: 
  - 可以达到版本10
  - 安全性高（256位ECDSA相当于3072位RSA）
  - 签名更短
- **缺点**: 需要修改Spec.txt要求（当前要求RSA）

### 方案3: 使用压缩 + 更短的数据格式（当前实现）
- **当前长度**: 432字符
- **需要版本**: 10（最大271字符）
- **状态**: ❌ 无法达到

### 方案4: 改变数据结构（不包含完整签名）
- 只存储数据哈希 + 短签名
- 或使用对称加密 + HMAC
- **缺点**: 不符合Spec.txt要求

## 当前实现

### 已实现的优化
1. ✅ 使用短键名（`r` 代替 `room_id`）
2. ✅ 省略固定字段（`api_url` 从配置读取）
3. ✅ 省略时间戳（由服务器验证时添加）
4. ✅ 使用gzip压缩
5. ✅ 紧凑JSON格式（无空格）

### 当前数据结构
```json
{
  "r": "test-room-1234567890"  // 只存储房间ID
}
```

**加密后长度**: 432字符（压缩后）
**需要版本**: 10（但超过271字符限制）

## 建议

### 短期方案（当前）
- 继续使用版本10二维码（虽然数据量略超，但大多数扫描器仍可识别）
- 或接受版本15的密度

### 长期方案（推荐）
1. **修改Spec.txt**，允许使用ECDSA-256签名
2. **实现ECDSA签名**，替换RSA签名
3. **数据量可降到约100字符**，轻松达到版本10

## 测试结果

| 方案 | JSON长度 | 签名长度 | 总长度 | 版本 |
|------|---------|---------|--------|------|
| 原始（完整数据） | 94字符 | 344字符 | 588字符 | 15 |
| 优化（短键名+省略字段） | 43字符 | 344字符 | 520字符 | 15 |
| 压缩优化 | 43字符 | 344字符 | 452字符 | 10+ |
| 只存储房间ID+压缩 | 28字符 | 344字符 | 432字符 | 10+ |
| **ECDSA-256（理论）** | **28字符** | **88字符** | **~100字符** | **5** ✅ |

---

**最后更新**: 2026-01-10  
**结论**: 使用RSA-2048无法达到版本10（271字符），建议改用ECDSA-256。
