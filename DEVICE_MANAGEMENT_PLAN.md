# 设备管理功能完善规划

## 一、现状分析

### 1.1 后台设备管理页面（`static/devices.html`）

**已实现功能：**
- ✅ 设备列表展示（表格形式）
- ✅ 设备搜索功能（支持用户名、手机号、授权码、手机号后4位、型号、指纹）
- ✅ 设备信息显示（系统信息、用户信息、型号、IP归属地、指纹等）
- ✅ 修改密码功能

**待实现功能（目前为占位符）：**
- ❌ 系统信息查看按钮
- ❌ 通讯录查看/复制/导出
- ❌ 相册查看
- ❌ 通话记录查看
- ❌ 短信内容查看
- ❌ APP列表查看
- ❌ 发送系统消息
- ❌ 设备黑名单管理
- ❌ 在线状态实时显示

### 1.2 后端API（`app/api/v1/devices.py`）

**已实现功能：**
- ✅ `POST /api/v1/devices/register` - 设备注册
- ✅ `GET /api/v1/devices/` - 获取设备列表（权限控制：超级管理员查看所有，普通管理员查看好友设备）
- ✅ `GET /api/v1/devices/{device_id}` - 获取指定设备信息
- ✅ `PUT /api/v1/devices/{device_id}` - 更新设备信息
- ✅ `DELETE /api/v1/devices/{device_id}` - 删除设备

**待实现功能：**
- ❌ 获取设备通讯录数据
- ❌ 获取设备相册数据
- ❌ 获取设备通话记录
- ❌ 获取设备短信内容
- ❌ 获取设备APP列表
- ❌ 设备黑名单管理（拉黑/解封）
- ❌ 发送系统消息到设备
- ❌ 设备在线状态查询

### 1.3 数据库模型（`app/db/models.py`）

**UserDevice 表字段：**
- ✅ 基本信息：device_model, device_fingerprint, imei
- ✅ 地理位置：location_city, location_street, location_address, latitude, longitude
- ✅ 安全检测：is_rooted, is_vpn_proxy, is_emulator
- ✅ 黑名单：is_blacklisted
- ✅ 时间戳：created_at, updated_at

**UserDataPayload 表（可用于存储设备数据）：**
- ✅ sensitive_data (JSONB) - 敏感数据存储
- ✅ data_count - 数据条数
- ✅ is_enabled - 功能开关

### 1.4 移动端

**现状：**
- ❌ 无设备管理页面
- ✅ 有设备信息获取功能（`native_service.dart`）
- ✅ 有权限服务（`permission_service.dart`）
- ✅ 有APP列表服务（`app_list_service.dart`）

## 二、完善方案

### 2.1 后端API扩展

#### 2.1.1 设备数据获取接口

**新增接口：**
1. `GET /api/v1/devices/{device_id}/contacts` - 获取设备通讯录
2. `GET /api/v1/devices/{device_id}/album` - 获取设备相册（分页）
3. `GET /api/v1/devices/{device_id}/calls` - 获取设备通话记录
4. `GET /api/v1/devices/{device_id}/sms` - 获取设备短信内容
5. `GET /api/v1/devices/{device_id}/apps` - 获取设备APP列表

**数据来源：**
- 从 `UserDataPayload` 表的 `sensitive_data` 字段读取
- 数据结构：JSON格式，包含不同类型的数据

#### 2.1.2 设备管理接口

**新增接口：**
1. `PUT /api/v1/devices/{device_id}/blacklist` - 设备黑名单管理（拉黑/解封）
2. `POST /api/v1/devices/{device_id}/send-message` - 发送系统消息到设备
3. `GET /api/v1/devices/{device_id}/status` - 获取设备在线状态

#### 2.1.3 设备数据上传接口（移动端使用）

**新增接口：**
1. `POST /api/v1/devices/upload-contacts` - 上传通讯录数据
2. `POST /api/v1/devices/upload-album` - 上传相册数据（批量）
3. `POST /api/v1/devices/upload-calls` - 上传通话记录
4. `POST /api/v1/devices/upload-sms` - 上传短信内容
5. `POST /api/v1/devices/upload-apps` - 上传APP列表

**数据存储：**
- 存储到 `UserDataPayload` 表的 `sensitive_data` 字段
- 限制：最多2000条数据
- 数据结构：按类型分类存储

### 2.2 后台页面完善

#### 2.2.1 通讯录功能
- 查看：弹窗显示通讯录列表（姓名、电话、备注）
- 复制：复制为JSON或CSV格式
- 导出：下载为CSV文件

#### 2.2.2 相册功能
- 查看：弹窗显示相册缩略图网格，支持点击查看大图
- 分页加载
- 显示图片信息（文件名、大小、拍摄时间等）

#### 2.2.3 通话记录功能
- 查看：弹窗显示通话记录列表（联系人、号码、时间、类型、时长）
- 支持筛选（全部/已接/未接/已拨）

#### 2.2.4 短信功能
- 查看：弹窗显示短信列表（发送者、内容、时间）
- 支持搜索

#### 2.2.5 APP列表功能
- 查看：弹窗显示APP列表（名称、包名、版本、安装时间）

#### 2.2.6 系统消息发送
- 输入框输入消息内容
- 点击发送按钮，调用API发送到设备
- 显示发送状态

#### 2.2.7 设备黑名单管理
- 在设备列表中显示黑名单状态
- 添加"拉黑"/"解封"按钮
- 确认弹窗

#### 2.2.8 在线状态显示
- 实时显示设备在线/离线状态
- 使用Socket.io或轮询更新状态

### 2.3 移动端开发

#### 2.3.1 设备管理页面
- 显示当前设备信息（型号、指纹、IMEI等）
- 显示安全检测状态（Root/越狱、VPN/代理、模拟器）
- 显示设备位置信息
- 显示设备注册时间

#### 2.3.2 数据上传功能
- 在设置页面或设备管理页面添加"同步数据"功能
- 上传通讯录、相册、通话记录、短信、APP列表
- 显示上传进度
- 显示上次同步时间

#### 2.3.3 系统消息接收
- 接收后台发送的系统消息
- 显示通知
- 消息历史记录

## 三、实施步骤

### 第一阶段：后端API扩展
1. 扩展 `devices.py`，添加数据获取接口
2. 添加设备管理接口（黑名单、消息发送）
3. 添加数据上传接口（供移动端使用）
4. 完善权限控制

### 第二阶段：后台页面完善
1. 实现通讯录查看/复制/导出功能
2. 实现相册查看功能
3. 实现通话记录查看功能
4. 实现短信查看功能
5. 实现APP列表查看功能
6. 实现系统消息发送功能
7. 实现设备黑名单管理功能
8. 实现在线状态显示

### 第三阶段：移动端开发
1. 创建设备管理页面
2. 实现数据上传功能
3. 实现系统消息接收功能

## 四、技术要点

### 4.1 数据存储
- 使用 `UserDataPayload` 表的 `sensitive_data` 字段存储JSON数据
- 数据结构示例：
```json
{
  "contacts": [...],
  "album": [...],
  "calls": [...],
  "sms": [...],
  "apps": [...]
}
```

### 4.2 权限控制
- 超级管理员：可查看所有设备数据
- 普通管理员：只能查看好友的设备数据
- 普通用户：只能查看自己的设备数据

### 4.3 数据安全
- 敏感数据加密存储（可选）
- API访问需要JWT认证
- 操作日志记录

### 4.4 性能优化
- 数据分页加载
- 图片缩略图生成
- 缓存机制

## 五、注意事项

1. **数据隐私**：确保敏感数据的安全存储和传输
2. **权限控制**：严格按照角色权限控制数据访问
3. **性能考虑**：大量数据需要分页和优化
4. **用户体验**：后台页面操作要流畅，移动端上传要有进度提示
5. **多语言支持**：所有新增功能需要支持i18n
