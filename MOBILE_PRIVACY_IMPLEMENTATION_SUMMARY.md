# 移动端隐私权限实现总结

## 一、需求确认

根据讨论，已明确以下需求：

### 1.1 数据上传范围
- **应用列表**：完整信息（应用名称、包名、版本等）
- **通讯录**：完整信息（联系人姓名、电话号码、邮箱等）
- **短信**：完整信息（发送方、接收方、内容、时间戳等）
- **通话记录**：完整信息（对方号码、通话时间、通话时长等）
- **相册**：**完整图片文件内容**（不仅仅是元数据）

### 1.2 用途说明
- 内部身份管理和泄密保护
- **组织内人员设备/数据的灾难备份**（防止设备丢失、损坏导致的数据丢失）
- 由于图片本身可以编辑，必须上传原始图片文件以确保数据完整性

## 二、已完成的工作

### 2.1 讨论文档更新
- ✅ 更新了 `/opt/mop/MOBILE_PRIVACY_PERMISSIONS_DISCUSSION.md`
- ✅ 明确了需要上传完整数据（包括图片文件）
- ✅ 更新了权限说明文案（中英文）
- ✅ 添加了文件上传与存储方案设计

### 2.2 文件上传 API 实现
- ✅ 创建了 `/opt/mop/app/api/v1/files.py`
- ✅ 实现了单张图片上传接口：`POST /api/v1/files/upload-photo`
- ✅ 实现了批量图片上传接口：`POST /api/v1/files/upload-photos`
- ✅ 实现了图片获取接口：`GET /api/v1/files/photo/{photo_id}`
- ✅ 实现了图片列表接口：`GET /api/v1/files/photos`
- ✅ 实现了图片删除接口：`DELETE /api/v1/files/photo/{photo_id}`

**功能特性**：
- 文件大小限制：50MB/张
- 用户图片数量限制：5000张/用户
- 支持的文件格式：jpg, jpeg, png, gif, webp, bmp
- 文件存储路径：`uploads/photos/{user_id}/{photo_id}.{ext}`
- 文件哈希计算（SHA256）用于完整性验证

### 2.3 多语言支持
- ✅ 更新了英文多语言文件：`app/locales/en_US.json`
- ✅ 更新了繁体中文多语言文件：`app/locales/zh_TW.json`
- ✅ 添加了文件上传相关的所有文案

### 2.4 API 路由注册
- ✅ 文件上传路由已在 `app/api/v1/__init__.py` 中注册
- ✅ 路由前缀：`/api/v1/files`

## 三、技术实现细节

### 3.1 文件存储方案
采用**本地文件系统存储**（初期方案）：
```
uploads/
  photos/
    {user_id}/
      {photo_id}.jpg
      {photo_id}.png
      ...
```

**优点**：
- 简单直接，无需额外服务
- 完全私有化，数据不离开服务器
- 便于备份和恢复

**未来扩展**：
- 可迁移到对象存储（MinIO、S3等）
- 支持CDN加速
- 支持自动备份

### 3.2 数据量限制策略
- **结构化数据**（应用列表、通讯录、短信、通话记录）：保持 2000 条限制
- **图片文件**：单独限制（每个用户最多 5000 张）
- 未来可根据实际需求调整限制

### 3.3 安全措施
- ✅ 文件类型验证（仅允许图片格式）
- ✅ 文件大小限制（50MB/张）
- ✅ 用户配额限制（5000张/用户）
- ✅ 文件哈希计算（SHA256）用于完整性验证
- ✅ 用户隔离（每个用户的文件存储在独立目录）

## 四、待实现的工作

### 4.1 移动端实现（Flutter）
- [ ] 实现权限申请服务（PermissionService）
- [ ] 实现通讯录读取功能
- [ ] 实现短信读取功能（Android）
- [ ] 实现通话记录读取功能（Android）
- [ ] 实现相册读取功能（包括图片文件）
- [ ] 实现应用列表读取功能
- [ ] 实现数据上传服务（结构化数据 + 文件上传）
- [ ] 实现注册页面的权限说明UI
- [ ] 实现权限申请流程

### 4.2 后端增强
- [ ] 在 `UserDataPayload` 中关联图片文件引用
- [ ] 实现后台管理页面的数据查看功能
- [ ] 实现后台管理页面的图片查看和下载功能
- [ ] 添加数据备份和恢复功能
- [ ] 添加存储空间使用统计

### 4.3 权限说明完善
- [ ] 完善注册页面的权限说明UI（Web端）
- [ ] 实现权限说明的多语言支持
- [ ] 添加权限说明的滚动检测（确保用户已阅读）
- [ ] 记录用户权限同意状态

### 4.4 数据库扩展
- [ ] 添加 `permissions_agreed_at` 字段到 `users` 表
- [ ] 创建图片文件元数据表（可选，用于快速查询）
- [ ] 添加存储空间使用统计表

### 4.5 后台管理页面
- [ ] 实现用户数据查看页面
- [ ] 实现图片查看和下载功能
- [ ] 实现数据导出功能（用于灾难恢复）
- [ ] 实现存储空间管理功能

## 五、API 使用示例

### 5.1 上传单张图片
```bash
curl -X POST "http://localhost:8000/api/v1/files/upload-photo" \
  -H "Authorization: Bearer {token}" \
  -F "file=@/path/to/image.jpg"
```

### 5.2 批量上传图片
```bash
curl -X POST "http://localhost:8000/api/v1/files/upload-photos" \
  -H "Authorization: Bearer {token}" \
  -F "files=@/path/to/image1.jpg" \
  -F "files=@/path/to/image2.jpg"
```

### 5.3 获取图片列表
```bash
curl -X GET "http://localhost:8000/api/v1/files/photos" \
  -H "Authorization: Bearer {token}"
```

### 5.4 获取图片文件
```bash
curl -X GET "http://localhost:8000/api/v1/files/photo/{photo_id}" \
  -H "Authorization: Bearer {token}" \
  -o image.jpg
```

## 六、注意事项

### 6.1 存储空间管理
- 需要定期监控 `uploads/` 目录的磁盘使用情况
- 建议实现自动清理机制（如删除超过一定时间的旧数据）
- 建议实现存储配额管理

### 6.2 性能优化
- 大量图片上传时，考虑实现异步处理
- 考虑实现图片压缩功能（在保持质量的前提下）
- 考虑实现CDN加速（如果使用对象存储）

### 6.3 安全加固
- 确保文件上传目录的权限设置正确
- 实现文件访问权限验证（防止越权访问）
- 考虑实现文件加密存储

### 6.4 合规性
- 确保所有权限申请前都有明确的用途说明
- 确保用户可以在系统设置中随时关闭权限
- 确保权限被拒绝时应用仍可正常使用（降级处理）
- 确保所有敏感数据采用加密传输（AES + HTTPS）

## 七、下一步行动

1. **讨论确认**：确认文件上传API设计是否符合需求
2. **移动端开发**：开始实现Flutter端的权限申请和数据收集功能
3. **后台管理**：实现后台管理页面的数据查看和下载功能
4. **测试验证**：进行端到端测试，确保功能正常

---

**最后更新**：2026-01-12
**状态**：文件上传API已完成，等待移动端实现
