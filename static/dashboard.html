<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>MOP - ä¸»æ§åˆ¶å°</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico?v=20260112">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            max-width: 100%;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header h1 {
            font-size: 1.5em;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .user-name {
            font-weight: 500;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        /* Header ä¸­çš„æŒ‰é’®æ ·å¼ */
        .header .btn-primary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .header .btn-primary:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* é€šç”¨ btn-primary æ ·å¼ï¼ˆç”¨äºå†…å®¹åŒºåŸŸï¼‰ */
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #5568d3 0%, #653a91 100%);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        /* ä¸»å¸ƒå±€ï¼šå·¦ä¾§èœå• + å³ä¾§å†…å®¹ */
        .main-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        /* å·¦ä¾§èœå•ï¼ˆå®½åº¦ç¼©å‡ 1/3ï¼Œä¸å„é¡µç»Ÿä¸€ï¼‰ */
        .sidebar {
            width: 147px;
            min-width: 147px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.08);
            padding: 16px 0;
            overflow-y: auto;
            position: sticky;
            top: 0;
            height: calc(100vh - 80px);
        }
        
        .sidebar-menu {
            list-style: none;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-menu-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            cursor: pointer;
            transition: background 0.2s;
            color: white;
            text-decoration: none;
            font-size: 13px;
            border-left: 3px solid transparent;
        }
        
        .sidebar-menu-item:hover {
            background: rgba(255,255,255,0.15);
        }
        
        .sidebar-menu-item.active {
            background: rgba(255,255,255,0.25);
            font-weight: 600;
            border-left-color: rgba(255,255,255,0.5);
        }
        
        .sidebar-menu-item-icon {
            font-size: 1em;
        }
        
        /* å³ä¾§ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            height: calc(100vh - 80px);
        }
        
        /* 4åˆ— Grid å¸ƒå±€ - å››åˆ—å¹³å‡åˆ†é…ç©ºé—´ */
        .cards-grid {
            display: grid;
            grid-template-columns: 1fr;
            grid-auto-rows: min-content; /* è¡Œé«˜åº¦æ ¹æ®å†…å®¹è‡ªåŠ¨è°ƒæ•´ */
            gap: 20px;
            margin-bottom: 30px;
            align-items: start; /* æ‰€æœ‰å¡ç‰‡ä»é¡¶éƒ¨å¯¹é½ */
        }
        
        /* ç¡®ä¿æ‰€æœ‰åˆ—å¹³å‡åˆ†é… */
        .cards-grid > * {
            min-width: 0; /* é˜²æ­¢å†…å®¹æº¢å‡º */
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            height: fit-content; /* é«˜åº¦é€‚åº”å†…å®¹ */
            display: flex;
            flex-direction: column;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .card h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-icon {
            font-size: 1.5em;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn-block {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .btn-block:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-block:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .room-list {
            list-style: none;
            margin-top: 15px;
        }
        
        .room-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 15px;
        }
        
        .room-info {
            flex: 1;
            min-width: 0; /* é˜²æ­¢å†…å®¹æº¢å‡º */
        }
        
        .room-actions {
            display: flex !important;
            flex-direction: column !important;
            gap: 5px !important;
            flex-shrink: 0 !important; /* é˜²æ­¢æŒ‰é’®åŒºåŸŸè¢«å‹ç¼© */
            min-width: 80px !important; /* ç¡®ä¿æŒ‰é’®æœ‰è¶³å¤Ÿå®½åº¦ */
            width: 80px !important; /* å›ºå®šå®½åº¦ç¡®ä¿æ˜¾ç¤º */
        }
        
        .room-actions .btn {
            display: block !important;
            width: 100% !important;
            margin: 0 !important;
            padding: 6px 12px !important;
            font-size: 12px !important;
            white-space: nowrap !important;
        }
        
        /* æˆ¿é—´æ“ä½œæŒ‰é’®çš„ä¸“é—¨æ ·å¼ */
        .room-actions .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            border: none !important;
            font-weight: 500 !important;
        }
        
        .room-actions .btn-primary:hover {
            background: linear-gradient(135deg, #5568d3 0%, #653a91 100%) !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4) !important;
        }
        
        .room-actions .btn-danger {
            background: #e74c3c !important;
            color: white !important;
            border: none !important;
            font-weight: 500 !important;
        }
        
        .room-actions .btn-danger:hover {
            background: #c0392b !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.4) !important;
        }
        
        .room-actions .btn-warning {
            background: #f39c12 !important;
            color: white !important;
            border: none !important;
            font-weight: 500 !important;
        }
        
        .room-actions .btn-warning:hover {
            background: #e67e22 !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 2px 8px rgba(243, 156, 18, 0.4) !important;
        }
        
        .room-actions .btn-success {
            background: #27ae60 !important;
            color: white !important;
            border: none !important;
            font-weight: 500 !important;
        }
        
        .room-actions .btn-success:hover {
            background: #229954 !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 2px 8px rgba(39, 174, 96, 0.4) !important;
        }
        
        .room-actions .btn:disabled {
            opacity: 0.5 !important;
            cursor: not-allowed !important;
            transform: none !important;
        }
        
        .room-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .room-meta {
            font-size: 12px;
            color: #666;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-online {
            background: #d4edda;
            color: #155724;
        }
        
        .status-offline {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* æ¶ˆæ¯å®¹å™¨ - å›ºå®šåœ¨é¡µé¢ä¸­é—´ */
        #messages {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10000;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .message {
            padding: 16px 24px;
            border-radius: 8px;
            display: none;
            min-width: 300px;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            pointer-events: auto;
            animation: messageSlideIn 0.3s ease-out;
        }
        
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .message-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .qrcode-container {
            text-align: center;
            margin-top: 15px;
        }
        
        .qrcode-container img {
            max-width: 200px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #666;
        }
        
        /* å¡ç‰‡ Grid ä½ç½®å®šä¹‰ - ä¸¤åˆ—å¸ƒå±€ */
        /* ç¬¬1åˆ—ï¼šç”¨æˆ·ä¿¡æ¯ï¼ˆåŒ…å«ç³»ç»Ÿç»Ÿè®¡ï¼‰ */
        #user-info-card {
            grid-column: 1;
            grid-row: 1;
            align-self: start;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .cards-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .main-layout {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                min-width: unset;
                height: auto;
                position: relative;
                display: none;
            }
            
            .sidebar.mobile-open {
                display: block;
            }
            
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .cards-grid {
                grid-template-columns: 1fr;
            }
            
            #user-info-card,
            #stats-card {
                grid-column: 1;
                grid-row: auto;
            }
            
            .main-content {
                height: auto;
            }
            
            /* ç§»åŠ¨ç«¯æ¶ˆæ¯æ ·å¼è°ƒæ•´ */
            .message {
                min-width: 280px;
                max-width: 90vw;
                padding: 14px 20px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div style="display: flex; align-items: center; gap: 10px;">
                <button class="btn btn-primary" id="mobile-menu-btn" onclick="toggleMobileMenu()" style="display: none; padding: 8px 12px;">â˜°</button>
                <h1>ğŸ  MOP ä¸»æ§åˆ¶å°</h1>
            </div>
            <div class="user-info">
                <span class="user-name" id="user-name">åŠ è½½ä¸­...</span>
                <span class="status-badge status-offline" id="connection-status">æœªè¿æ¥</span>
                <button class="btn btn-primary" onclick="refreshData()">åˆ·æ–°</button>
                <button class="btn btn-danger" onclick="logout()">é€€å‡º</button>
            </div>
        </div>
    </div>
    
    <div class="main-layout">
        <!-- å·¦ä¾§èœå•ï¼ˆå„é¡µç»Ÿä¸€ï¼‰ -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-title" style="padding: 0 12px 12px; font-size: 12px; color: rgba(255,255,255,0.7);">å·¦ä¾§èœå•</div>
            <div class="sidebar-menu">
                <a href="/static/dashboard.html" class="sidebar-menu-item active"><span class="sidebar-menu-item-icon">ğŸ‘¤</span>ç”¨æˆ·ä¿¡æ¯</a>
                <a href="#" class="sidebar-menu-item" id="menu-change-pwd"><span class="sidebar-menu-item-icon">ğŸ”‘</span>ä¿®æ”¹å¯†ç </a>
                <a href="/static/devices.html" class="sidebar-menu-item"><span class="sidebar-menu-item-icon">ğŸ“±</span>è®¾å¤‡ç®¡ç†</a>
                <a href="/static/user_management.html" class="sidebar-menu-item"><span class="sidebar-menu-item-icon">ğŸ‘¥</span>ç”¨æˆ·ç®¡ç†</a>
                <a href="/static/invitation_management.html" class="sidebar-menu-item"><span class="sidebar-menu-item-icon">ğŸ«</span>é‚€è¯·ç ç®¡ç†</a>
                <a href="/static/qrcode_settings.html" class="sidebar-menu-item"><span class="sidebar-menu-item-icon">âš™ï¸</span>æ‰«ç é…ç½®</a>
            </div>
        </aside>
        
        <!-- å³ä¾§ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <div id="messages"></div>
            
            <div class="cards-grid">
            <!-- ç”¨æˆ·ä¿¡æ¯ï¼ˆåŒ…å«ç³»ç»Ÿç»Ÿè®¡ï¼‰ -->
            <div class="card" id="user-info-card">
                <h2><span class="card-icon">ğŸ‘¤</span> ç”¨æˆ·ä¿¡æ¯</h2>
                <div id="user-details">
                    <p style="color: #999; text-align: center; padding: 20px;">åŠ è½½ä¸­...</p>
                </div>
                <hr style="margin: 20px 0; border: none; border-top: 1px solid #e0e0e0;">
                <h3 style="font-size: 1.1em; margin-bottom: 15px; color: #333;"><span class="card-icon">ğŸ“Š</span> ç³»ç»Ÿç»Ÿè®¡</h3>
                <div id="stats-container">
                    <p style="color: #999; text-align: center; padding: 20px;">åŠ è½½ä¸­...</p>
                </div>
            </div>
            
            </div>
        </main>
    </div>
    
    <!-- ä¿®æ”¹å¯†ç å¼¹çª— -->
    <div id="modal-change-pwd" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 24px; width: 90%; max-width: 400px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
            <h3 style="margin-bottom: 16px; color: #333;">ä¿®æ”¹å¯†ç </h3>
            <div style="margin-bottom: 14px;"><label style="display: block; margin-bottom: 6px; font-size: 14px; color: #555;">æ—§å¯†ç </label><input type="password" id="pwd-old" placeholder="è¯·è¾“å…¥æ—§å¯†ç " style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;"></div>
            <div style="margin-bottom: 14px;"><label style="display: block; margin-bottom: 6px; font-size: 14px; color: #555;">æ–°å¯†ç </label><input type="password" id="pwd-new" placeholder="è‡³å°‘6ä½" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;"></div>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" class="btn" style="background: #e0e0e0; color: #333; padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer;" onclick="closeChangePwdModal()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="submitChangePwd()">ç¡®å®š</button>
            </div>
        </div>
    </div>
    
    <script>
        function openChangePwdModal() {
            var m = document.getElementById('modal-change-pwd');
            if (m) { m.style.display = 'flex'; document.getElementById('pwd-old').value = ''; document.getElementById('pwd-new').value = ''; }
        }
        function closeChangePwdModal() {
            var m = document.getElementById('modal-change-pwd');
            if (m) m.style.display = 'none';
        }
        async function submitChangePwd() {
            var oldP = document.getElementById('pwd-old').value, newP = document.getElementById('pwd-new').value;
            if (!oldP || !newP) { showMessage('è¯·å¡«å†™æ—§å¯†ç å’Œæ–°å¯†ç ', 'error'); return; }
            if (newP.length < 6) { showMessage('æ–°å¯†ç è‡³å°‘6ä½', 'error'); return; }
            try {
                var res = await fetch(API_BASE + '/users/me/change-password', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + getToken() }, body: JSON.stringify({ old_password: oldP, new_password: newP }) });
                if (!res.ok) { var err = await res.json().catch(function() { return {}; }); throw new Error(err.detail || 'ä¿®æ”¹å¤±è´¥'); }
                showMessage('å¯†ç å·²ä¿®æ”¹', 'success');
                closeChangePwdModal();
            } catch (e) { showMessage('ä¿®æ”¹å¯†ç å¤±è´¥: ' + (e.message || e), 'error'); }
        }
        document.addEventListener('DOMContentLoaded', function() {
            var el = document.getElementById('menu-change-pwd');
            if (el) el.addEventListener('click', function(e) { e.preventDefault(); openChangePwdModal(); });
        });
        // æ‰“å¼€å®æ—¶é€šè®¯ç®¡ç†é¡µé¢ï¼ˆä»…è¶…çº§ç®¡ç†å‘˜ï¼‰
        function openChatAdmin() {
            const token = getToken();
            if (!token) {
                showMessage('è¯·å…ˆç™»å½•', 'error');
                return;
            }
            // åœ¨æ–°çª—å£æ‰“å¼€å®æ—¶é€šè®¯ç®¡ç†é¡µé¢
            const chatAdminUrl = `/static/chat_admin.html?token=${encodeURIComponent(token)}`;
            window.open(chatAdminUrl, '_blank', 'width=1200,height=800');
        }
        
        function scrollToCard(cardId) {
            const card = document.getElementById(cardId);
            if (card) {
                card.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // æ›´æ–°èœå•é¡¹æ¿€æ´»çŠ¶æ€
                document.querySelectorAll('.sidebar-menu-item').forEach(item => {
                    item.classList.remove('active');
                });
                event.target.closest('.sidebar-menu-item')?.classList.add('active');
            }
        }
        
        // ç§»åŠ¨ç«¯èœå•åˆ‡æ¢
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('mobile-open');
        }
        
        // æ˜¾ç¤º/éšè—ç§»åŠ¨ç«¯èœå•æŒ‰é’®
        function updateMobileMenuButton() {
            const menuBtn = document.getElementById('mobile-menu-btn');
            if (window.innerWidth <= 768) {
                menuBtn.style.display = 'block';
            } else {
                menuBtn.style.display = 'none';
                document.getElementById('sidebar').classList.remove('mobile-open');
            }
        }
        
        // ç›‘å¬çª—å£å¤§å°å˜åŒ–
        window.addEventListener('resize', updateMobileMenuButton);
        // åŸŸåæ£€æŸ¥ï¼šdashboard.html åº”è¯¥åªåœ¨ä¸»åŸŸåä½¿ç”¨
        const hostname = window.location.hostname;
        if (hostname === 'log.chat5202ol.xyz') {
            // å¦‚æœåœ¨ log åŸŸåè®¿é—®ï¼Œé‡å®šå‘åˆ°å³æ—¶é€šè®¯
            window.location.href = '/chat';
            throw new Error('Redirecting to chat');
        }
        
        // è‡ªåŠ¨æ£€æµ‹ API åŸºç¡€è·¯å¾„
        function getApiBase() {
            const hostname = window.location.hostname;
            const protocol = window.location.protocol;
            
            // ä¸»åŸŸåï¼ˆwww.chat5202ol.xyzï¼‰ç”¨äºåå°ç®¡ç†ç³»ç»Ÿï¼Œä½¿ç”¨ api.chat5202ol.xyz
            if (hostname === 'www.chat5202ol.xyz' || hostname === 'chat5202ol.xyz' || hostname === 'app.chat5202ol.xyz') {
                return 'https://api.chat5202ol.xyz/api/v1';
            }
            
            // å¦‚æœæ˜¯ api åŸŸåæœ¬èº«ï¼Œç›´æ¥ä½¿ç”¨å½“å‰åŸŸåçš„ /api/v1
            if (hostname === 'api.chat5202ol.xyz') {
                return `${protocol}//${hostname}/api/v1`;
            }
            
            // æœ¬åœ°å¼€å‘ç¯å¢ƒ
            return '/api/v1';
        }
        
        const API_BASE = getApiBase();
        let currentUser = null;
        let socket = null;
        
        // è·å–Token
        function getToken() {
            return localStorage.getItem('access_token');
        }
        
        // ç»Ÿä¸€çš„APIè¯·æ±‚å‡½æ•°ï¼Œè‡ªåŠ¨å¤„ç†401é”™è¯¯
        async function apiRequest(url, options = {}) {
            const token = getToken();
            if (!token) {
                showMessage('æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•', 'error');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
                throw new Error('æœªç™»å½•');
            }
            
            // ç¡®ä¿æœ‰headers
            if (!options.headers) {
                options.headers = {};
            }
            
            // æ·»åŠ Authorizationå¤´
            options.headers['Authorization'] = `Bearer ${token}`;
            
            // ç¡®ä¿æœ‰ Content-Typeï¼ˆå¦‚æœéœ€è¦å‘é€æ•°æ®ï¼‰
            if (options.body && !options.headers['Content-Type']) {
                options.headers['Content-Type'] = 'application/json';
            }
            
            // æ·»åŠ  credentials é€‰é¡¹ï¼ˆæ”¯æŒ CORS è®¤è¯ï¼‰
            if (!options.credentials) {
                options.credentials = 'include';
            }
            
            const response = await fetch(url, options);
            
            // å¤„ç†401é”™è¯¯
            if (response.status === 401) {
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                showMessage('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
                throw new Error('ç™»å½•å·²è¿‡æœŸ');
            }
            
            return response;
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const message = document.createElement('div');
            message.className = `message message-${type}`;
            message.textContent = text;
            message.style.display = 'block';
            messagesDiv.appendChild(message);
            
            // å»¶è¿Ÿåæ·»åŠ æ·¡å‡ºåŠ¨ç”»å¹¶ç§»é™¤
            setTimeout(() => {
                message.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
                message.style.opacity = '0';
                message.style.transform = 'translateY(-20px)';
                setTimeout(() => {
                    message.remove();
                }, 300);
            }, 5000);
        }
        
        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        async function loadUserInfo() {
            try {
                const token = getToken();
                if (!token) {
                    showMessage('æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•', 'error');
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                    return;
                }
                
                const response = await fetch(`${API_BASE}/auth/me`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('access_token');
                        showMessage('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                        setTimeout(() => {
                            window.location.href = '/login';
                        }, 2000);
                        return;
                    }
                    const errorData = await response.json().catch(() => ({ detail: 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥' }));
                    throw new Error(errorData.detail || `HTTP ${response.status}: è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥`);
                }
                
                currentUser = await response.json();
                
                // è°ƒè¯•æ—¥å¿—
                console.log('ç”¨æˆ·ä¿¡æ¯åŠ è½½:', currentUser);
                console.log('is_admin:', currentUser.is_admin, typeof currentUser.is_admin);
                console.log('role:', currentUser.role, typeof currentUser.role);
                
                document.getElementById('user-name').textContent = currentUser.nickname || currentUser.username;
                
                // æ˜¾ç¤ºç”¨æˆ·è¯¦æƒ…
                const userDetails = document.getElementById('user-details');
                
                // ç¡®å®šç®¡ç†å‘˜çŠ¶æ€å’Œè§’è‰²æ˜¾ç¤º
                const isAdmin = currentUser.is_admin === true || 
                               currentUser.is_admin === 'true' || 
                               currentUser.role === 'super_admin';
                const roleDisplay = currentUser.role === 'super_admin' ? 'è¶…çº§ç®¡ç†å‘˜' : 
                                    currentUser.role === 'room_owner' ? 'æˆ¿ä¸»' : 
                                    currentUser.role === 'user' ? 'æ™®é€šç”¨æˆ·' : 
                                    (currentUser.role || 'æœªçŸ¥');
                
                userDetails.innerHTML = `
                    <div style="line-height: 1.8;">
                        <div><strong>ç”¨æˆ·å:</strong> ${currentUser.username || 'æœªè®¾ç½®'}</div>
                        <div><strong>æ‰‹æœºå·:</strong> ${currentUser.phone || 'æœªè®¾ç½®'}</div>
                        <div><strong>æ˜µç§°:</strong> ${currentUser.nickname || 'æœªè®¾ç½®'}</div>
                        <div><strong>è¯­è¨€:</strong> ${currentUser.language || 'zh_CN'}</div>
                        <div><strong>è§’è‰²:</strong> ${roleDisplay}</div>
                        <div><strong>ç®¡ç†å‘˜:</strong> ${isAdmin ? 'æ˜¯' : 'å¦'}</div>
                    </div>
                `;
                
                // æ›´æ–°å…¨å±€ç”¨æˆ·å¯¹è±¡ï¼Œç¡®ä¿æƒé™æ£€æŸ¥æ­£ç¡®
                // ä¿ç•™åŸå§‹å€¼ï¼ŒåŒæ—¶è®¾ç½®è®¡ç®—åçš„å€¼
                currentUser.is_admin = isAdmin;
                currentUser.role = currentUser.role || 'user';
                
                // ç¡®ä¿æ‰€æœ‰æƒé™æ£€æŸ¥å‡½æ•°éƒ½èƒ½æ­£ç¡®å·¥ä½œ
                console.log('æ›´æ–°åçš„ç”¨æˆ·å¯¹è±¡:', currentUser);
                console.log('ç®¡ç†å‘˜çŠ¶æ€æ£€æŸ¥:', {
                    'is_admin === true': currentUser.is_admin === true,
                    'is_admin å€¼': currentUser.is_admin,
                    'role === super_admin': currentUser.role === 'super_admin',
                    'role å€¼': currentUser.role
                });
                
                const statsMenuItem = document.getElementById('stats-menu-item');
                if (statsMenuItem) statsMenuItem.style.display = 'block';
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                showMessage('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ' + (error.message || 'ç½‘ç»œé”™è¯¯'), 'error');
                const userDetails = document.getElementById('user-details');
                if (userDetails) {
                    userDetails.innerHTML = '<p style="color: #e74c3c; text-align: center; padding: 20px;">åŠ è½½å¤±è´¥ï¼Œè¯·<a href="javascript:loadUserInfo()">é‡è¯•</a></p>';
                }
            }
        }
        
        // åŠ è½½æˆ¿é—´åˆ—è¡¨
        async function loadRooms() {
            try {
                const token = getToken();
                if (!token) {
                    return;
                }
                
                const response = await fetch(`${API_BASE}/rooms/`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('access_token');
                        window.location.href = '/login';
                        return;
                    }
                    const errorData = await response.json().catch(() => ({ detail: 'è·å–æˆ¿é—´åˆ—è¡¨å¤±è´¥' }));
                    throw new Error(errorData.detail || `HTTP ${response.status}: è·å–æˆ¿é—´åˆ—è¡¨å¤±è´¥`);
                }
                
                const rooms = await response.json();
                const roomsList = document.getElementById('rooms-list');
                
                if (rooms.length === 0) {
                    roomsList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">æš‚æ— æˆ¿é—´ï¼Œè¯·åˆ›å»ºæˆ¿é—´</p>';
                    return;
                }
                
                roomsList.innerHTML = rooms.map(room => `
                    <div class="room-item">
                        <div class="room-info">
                            <div class="room-name">${room.room_name || room.room_id}</div>
                            <div class="room-meta">
                                æˆ¿é—´ID: ${room.room_id}<br>
                                äººæ•°: ${room.participant_count}/${room.max_occupants} | 
                                çŠ¶æ€: <span class="status-badge ${room.is_active ? 'status-online' : 'status-offline'}">${room.is_active ? 'æ´»è·ƒ' : 'å·²å…³é—­'}</span><br>
                                åˆ›å»ºæ—¶é—´: ${new Date(room.created_at).toLocaleString('zh-CN')}
                            </div>
                        </div>
                        <div class="room-actions">
                            <button class="btn ${room.is_active ? 'btn-warning' : 'btn-success'}" onclick="toggleRoomStatus('${room.room_id}', ${room.is_active})" style="padding: 6px 12px; font-size: 12px; width: 100%; white-space: nowrap;" title="${room.is_active ? 'ç¦ç”¨æˆ¿é—´' : 'å¼€å¯æˆ¿é—´'}">${room.is_active ? 'ç¦ç”¨' : 'å¼€å¯'}</button>
                            <button class="btn btn-danger" onclick="deleteRoom('${room.room_id}')" style="padding: 6px 12px; font-size: 12px; width: 100%; white-space: nowrap;" title="åˆ é™¤æˆ¿é—´">åˆ é™¤</button>
                            <button class="btn btn-primary" onclick="editRoom('${room.room_id}')" style="padding: 6px 12px; font-size: 12px; width: 100%; white-space: nowrap;" title="ä¿®æ”¹æˆ¿é—´">ä¿®æ”¹</button>
                            <button class="btn btn-primary" onclick="joinRoom('${room.room_id}')" style="padding: 6px 12px; font-size: 12px; width: 100%; white-space: nowrap;" title="åŠ å…¥æˆ¿é—´" ${!room.is_active ? 'disabled' : ''}>åŠ å…¥</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½æˆ¿é—´åˆ—è¡¨å¤±è´¥:', error);
                showMessage('åŠ è½½æˆ¿é—´åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
                const roomsList = document.getElementById('rooms-list');
                if (roomsList) {
                    roomsList.innerHTML = '<p style="color: #e74c3c; text-align: center; padding: 20px;">åŠ è½½å¤±è´¥ï¼Œè¯·<a href="javascript:loadRooms()">é‡è¯•</a></p>';
                }
            }
        }
        
        // åŠ å…¥æˆ¿é—´
        async function joinRoom(roomId) {
            try {
                const response = await fetch(`${API_BASE}/rooms/${roomId}/join`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify({
                        display_name: currentUser?.nickname || currentUser?.username
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || 'åŠ å…¥æˆ¿é—´å¤±è´¥');
                }
                
                // è·³è½¬åˆ°Jitsiæˆ¿é—´é¡µé¢ï¼Œä½¿ç”¨åç«¯è¿”å›çš„ room_urlï¼ˆå·²åŒ…å« JWT Tokenï¼‰
                showMessage('æ­£åœ¨è·³è½¬åˆ°æˆ¿é—´...', 'success');
                // ä½¿ç”¨åç«¯è¿”å›çš„å®Œæ•´ room_urlï¼Œè€Œä¸æ˜¯é‡æ–°æ„å»º
                const roomPageUrl = data.room_url || `/room/${data.room_id}?jwt=${encodeURIComponent(data.jitsi_token)}&server=${encodeURIComponent(data.jitsi_server_url)}`;
                setTimeout(() => {
                    window.open(roomPageUrl, '_blank');
                }, 500);
            } catch (error) {
                showMessage('åŠ å…¥æˆ¿é—´å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ˜¾ç¤ºæˆ¿é—´äºŒç»´ç 
        async function showQRCode(roomId) {
            document.getElementById('qrcode-room-id').value = roomId;
            await generateQRCode();
        }
        
        // æŸ¥çœ‹æˆ¿é—´å‚ä¸è€…
        async function viewParticipants(roomId) {
            try {
                const response = await fetch(`${API_BASE}/rooms/${roomId}/participants`, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('è·å–å‚ä¸è€…åˆ—è¡¨å¤±è´¥');
                }
                
                const participants = await response.json();
                
                if (participants.length === 0) {
                    showMessage('æˆ¿é—´æš‚æ— å‚ä¸è€…', 'info');
                    return;
                }
                
                const participantList = participants.map(p => 
                    `${p.user_nickname || p.display_name || 'æœªçŸ¥'}${p.is_moderator ? ' (ä¸»æŒäºº)' : ''}`
                ).join(', ');
                
                showMessage(`å‚ä¸è€… (${participants.length}): ${participantList}`, 'info');
            } catch (error) {
                showMessage('è·å–å‚ä¸è€…åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // åˆ›å»ºæˆ¿é—´ï¼ˆå·²ç§»é™¤UIï¼Œæ­¤ä»£ç å·²ç¦ç”¨ï¼‰
        // æ³¨æ„ï¼šcreate-room-form å…ƒç´ å·²åˆ é™¤ï¼Œæ­¤äº‹ä»¶ç›‘å¬å™¨ä¼šæŠ¥é”™ï¼Œå·²æ³¨é‡Š
        /*
        const createRoomForm = document.getElementById('create-room-form');
        if (createRoomForm) {
            createRoomForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const roomName = document.getElementById('room-name').value;
            const maxOccupants = parseInt(document.getElementById('max-occupants').value) || 10;
            
            try {
                const response = await apiRequest(`${API_BASE}/rooms/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        room_name: roomName || null,
                        max_occupants: maxOccupants
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || 'åˆ›å»ºæˆ¿é—´å¤±è´¥');
                }
                
                showMessage(`æˆ¿é—´åˆ›å»ºæˆåŠŸï¼æˆ¿é—´ID: ${data.room_id}`, 'success');
                document.getElementById('room-name').value = '';
                document.getElementById('max-occupants').value = '10';
                document.getElementById('qrcode-room-id').value = data.room_id;
                await loadRooms();
                // è‡ªåŠ¨ç”ŸæˆäºŒç»´ç 
                setTimeout(() => generateQRCode(), 500);
            } catch (error) {
                showMessage('åˆ›å»ºæˆ¿é—´å¤±è´¥: ' + error.message, 'error');
            }
            });
        }
        */
        
        // ç”ŸæˆäºŒç»´ç ï¼ˆä¾›å…¶ä»–åŠŸèƒ½è°ƒç”¨ï¼Œä¸ä¾èµ–å·²åˆ é™¤çš„UIå…ƒç´ ï¼‰
        async function generateQRCode(roomId) {
            if (!roomId) {
                showMessage('è¯·æä¾›æˆ¿é—´ID', 'error');
                return null;
            }
            
            try {
                const response = await apiRequest(`${API_BASE}/qrcode/room/${roomId}/image`, {
                    method: 'GET'
                });
                
                if (!response.ok) {
                    throw new Error('è·å–äºŒç»´ç å¤±è´¥');
                }
                
                const blob = await response.blob();
                return URL.createObjectURL(blob);
            } catch (error) {
                console.error('ç”ŸæˆäºŒç»´ç å¼‚å¸¸:', error);
                showMessage('ç”ŸæˆäºŒç»´ç å¤±è´¥: ' + error.message, 'error');
                return null;
            }
        }
        
        // æ˜¾ç¤ºæˆ¿é—´äºŒç»´ç ï¼ˆä¾›å…¶ä»–åŠŸèƒ½è°ƒç”¨ï¼‰
        async function showQRCode(roomId) {
            const qrUrl = await generateQRCode(roomId);
            if (qrUrl) {
                console.log('äºŒç»´ç å·²ç”Ÿæˆ');
            }
        }
        
        // åŠ è½½å¥½å‹åˆ—è¡¨
        async function loadFriends() {
            try {
                const statusFilter = document.getElementById('friend-status-filter')?.value || '';
                const url = `${API_BASE}/friends/list${statusFilter ? '?status_filter=' + encodeURIComponent(statusFilter) : ''}`;
                
                const response = await apiRequest(url, {
                    method: 'GET'
                });
                
                if (!response.ok) {
                    throw new Error('è·å–å¥½å‹åˆ—è¡¨å¤±è´¥');
                }
                
                const data = await response.json();
                const friendsList = document.getElementById('friends-list');
                
                if (!data.friends || data.friends.length === 0) {
                    friendsList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">æš‚æ— å¥½å‹</p>';
                    return;
                }
                
                friendsList.innerHTML = data.friends.map(friend => {
                    const statusText = {
                        'accepted': 'å·²æ¥å—',
                        'pending': 'å¾…ç¡®è®¤',
                        'blocked': 'å·²å±è”½'
                    }[friend.status] || friend.status;
                    
                    const statusClass = friend.status === 'accepted' ? 'status-online' : 
                                      friend.status === 'pending' ? 'status-offline' : 'status-offline';
                    
                    const isPending = friend.status === 'pending';
                    const isAccepted = friend.status === 'accepted';
                    
                    return `
                        <div class="room-item" style="margin-bottom: 10px;">
                            <div class="room-info">
                                <div class="room-name">${friend.note || friend.nickname || friend.username || friend.phone || 'æœªçŸ¥ç”¨æˆ·'}</div>
                                <div class="room-meta">
                                    ${friend.note ? `<div>å¤‡æ³¨: ${friend.note}</div>` : ''}
                                    ${friend.username ? `<div>ç”¨æˆ·å: ${friend.username}</div>` : ''}
                                    çŠ¶æ€: <span class="status-badge ${statusClass}">${statusText}</span> |
                                    ${friend.is_online ? '<span style="color: green;">â— åœ¨çº¿</span>' : '<span style="color: #999;">â—‹ ç¦»çº¿</span>'}
                                </div>
                            </div>
                            <div class="room-actions">
                                ${isPending ? `
                                    <button class="btn btn-success" onclick="acceptFriendRequest(${friend.user_id})" style="padding: 6px 12px; font-size: 12px; width: 100%; white-space: nowrap;">æ¥å—</button>
                                    <button class="btn btn-danger" onclick="rejectFriendRequest(${friend.user_id})" style="padding: 6px 12px; font-size: 12px; width: 100%; white-space: nowrap;">æ‹’ç»</button>
                                ` : isAccepted ? `
                                    <button class="btn btn-danger" onclick="removeFriend(${friend.user_id})" style="padding: 6px 12px; font-size: 12px; width: 100%; white-space: nowrap;">åˆ é™¤</button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('åŠ è½½å¥½å‹åˆ—è¡¨å¤±è´¥:', error);
                showMessage('åŠ è½½å¥½å‹åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
                document.getElementById('friends-list').innerHTML = '<p style="color: #e74c3c; text-align: center; padding: 20px;">åŠ è½½å¤±è´¥</p>';
            }
        }
        
        // æœç´¢ç”¨æˆ·
        async function searchUsers() {
            const keyword = document.getElementById('friend-search')?.value?.trim();
            if (!keyword) {
                showMessage('è¯·è¾“å…¥æœç´¢å…³é”®è¯', 'error');
                return;
            }
            
            try {
                const response = await apiRequest(`${API_BASE}/friends/search?keyword=${encodeURIComponent(keyword)}`, {
                    method: 'GET'
                });
                
                if (!response.ok) {
                    throw new Error('æœç´¢ç”¨æˆ·å¤±è´¥');
                }
                
                const users = await response.json();
                const searchResults = document.getElementById('search-results');
                
                if (users.length === 0) {
                    searchResults.innerHTML = '<p style="color: #999; text-align: center; padding: 10px;">æœªæ‰¾åˆ°ç”¨æˆ·</p>';
                    searchResults.style.display = 'block';
                    return;
                }
                
                searchResults.innerHTML = users.map(user => {
                    const statusText = {
                        'none': 'æœªæ·»åŠ ',
                        'pending': 'å¾…ç¡®è®¤',
                        'accepted': 'å·²æ˜¯å¥½å‹',
                        'blocked': 'å·²å±è”½'
                    }[user.status] || user.status;
                    
                    const canAdd = user.status === 'none';
                    
                    return `
                        <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">${user.nickname || user.username || user.phone || 'æœªçŸ¥ç”¨æˆ·'}</div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                    ${user.username ? `ç”¨æˆ·å: ${user.username} | ` : ''}
                                    ${user.is_online ? '<span style="color: green;">â— åœ¨çº¿</span>' : '<span style="color: #999;">â—‹ ç¦»çº¿</span>'} |
                                    çŠ¶æ€: ${statusText}
                                </div>
                            </div>
                            <div>
                                ${canAdd ? `
                                    <button class="btn btn-primary" onclick="addFriend(${user.user_id})" style="padding: 6px 12px; font-size: 12px;">æ·»åŠ å¥½å‹</button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                searchResults.style.display = 'block';
            } catch (error) {
                console.error('æœç´¢ç”¨æˆ·å¤±è´¥:', error);
                showMessage('æœç´¢ç”¨æˆ·å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ·»åŠ å¥½å‹
        async function addFriend(friendId) {
            if (!confirm('ç¡®å®šè¦æ·»åŠ æ­¤ç”¨æˆ·ä¸ºå¥½å‹å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await apiRequest(`${API_BASE}/friends/add`, {
                    method: 'POST',
                    body: JSON.stringify({
                        friend_id: friendId
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || 'æ·»åŠ å¥½å‹å¤±è´¥');
                }
                
                showMessage(data.message || 'å¥½å‹è¯·æ±‚å·²å‘é€', 'success');
                // æ¸…ç©ºæœç´¢æ¡†å’Œç»“æœ
                document.getElementById('friend-search').value = '';
                document.getElementById('search-results').style.display = 'none';
                // åˆ·æ–°å¥½å‹åˆ—è¡¨
                await loadFriends();
            } catch (error) {
                console.error('æ·»åŠ å¥½å‹å¤±è´¥:', error);
                showMessage('æ·»åŠ å¥½å‹å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ¥å—å¥½å‹è¯·æ±‚
        async function acceptFriendRequest(friendId) {
            try {
                const response = await apiRequest(`${API_BASE}/friends/update`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        friend_id: friendId,
                        status: 'accepted'
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || 'æ¥å—å¥½å‹è¯·æ±‚å¤±è´¥');
                }
                
                showMessage(data.message || 'å·²æ¥å—å¥½å‹è¯·æ±‚', 'success');
                await loadFriends();
            } catch (error) {
                console.error('æ¥å—å¥½å‹è¯·æ±‚å¤±è´¥:', error);
                showMessage('æ¥å—å¥½å‹è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ‹’ç»å¥½å‹è¯·æ±‚
        async function rejectFriendRequest(friendId) {
            if (!confirm('ç¡®å®šè¦æ‹’ç»æ­¤å¥½å‹è¯·æ±‚å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await apiRequest(`${API_BASE}/friends/remove/${friendId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || 'æ‹’ç»å¥½å‹è¯·æ±‚å¤±è´¥');
                }
                
                showMessage(data.message || 'å·²æ‹’ç»å¥½å‹è¯·æ±‚', 'success');
                await loadFriends();
            } catch (error) {
                console.error('æ‹’ç»å¥½å‹è¯·æ±‚å¤±è´¥:', error);
                showMessage('æ‹’ç»å¥½å‹è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // åˆ é™¤å¥½å‹
        async function removeFriend(friendId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤å¥½å‹å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await apiRequest(`${API_BASE}/friends/remove/${friendId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || 'åˆ é™¤å¥½å‹å¤±è´¥');
                }
                
                showMessage(data.message || 'å·²åˆ é™¤å¥½å‹', 'success');
                await loadFriends();
            } catch (error) {
                console.error('åˆ é™¤å¥½å‹å¤±è´¥:', error);
                showMessage('åˆ é™¤å¥½å‹å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // åŠ è½½è®¾å¤‡åˆ—è¡¨ï¼ˆä¸ /api/v1/devices/ è¿”å›çš„ DeviceWithUserResponse ä¸€è‡´ï¼‰
        async function loadDevices() {
            const devicesList = document.getElementById('devices-list');
            if (!devicesList) return;
            try {
                const response = await apiRequest(`${API_BASE}/devices/`, { method: 'GET' });
                if (!response.ok) throw new Error('è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥');
                let devices = await response.json();
                if (!Array.isArray(devices)) devices = [];
                devices.sort((a, b) => {
                    const ta = (a.updated_at || a.created_at || '').replace('Z', '');
                    const tb = (b.updated_at || b.created_at || '').replace('Z', '');
                    return tb.localeCompare(ta);
                });
                if (devices.length === 0) {
                    devicesList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">æš‚æ— è®¾å¤‡</p>';
                    return;
                }
                const esc = (s) => (s == null ? '' : String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'));
                devicesList.innerHTML = devices.map(device => {
                    const name = device.user_phone || device.user_username || device.user_nickname || device.device_model || ('è®¾å¤‡#' + (device.id || ''));
                    const updated = device.updated_at || device.created_at || '';
                    const timeStr = updated ? new Date(updated).toLocaleString('zh-CN') : 'â€”';
                    const online = device.is_online === true;
                    const statusCls = online ? 'status-online' : 'status-offline';
                    const statusText = online ? 'åœ¨çº¿' : 'ç¦»çº¿';
                    return `<div class="room-item">
                        <div class="room-info">
                            <div class="room-name">${esc(name)}</div>
                            <div class="room-meta">
                                è®¾å¤‡ID: ${esc(device.id)} Â· ${timeStr}<br>
                                <span class="status-badge ${statusCls}">${statusText}</span>
                                ${device.user_invitation_code ? ' Â· ' + esc(device.user_invitation_code) : ''}
                            </div>
                        </div>
                    </div>`;
                }).join('');
            } catch (error) {
                showMessage('åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
                devicesList.innerHTML = '<p style="color: #e74c3c; text-align: center; padding: 20px;">åŠ è½½å¤±è´¥ï¼Œè¯·<a href="javascript:loadDevices()">é‡è¯•</a>æˆ–<a href="/static/devices.html">è¿›å…¥å®Œæ•´è®¾å¤‡ç®¡ç†</a></p>';
            }
        }
        
        // åŠ è½½ç³»ç»Ÿç»Ÿè®¡ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
        async function loadStats() {
            // æ£€æŸ¥ç®¡ç†å‘˜æƒé™ï¼šis_admin ä¸º true æˆ– role ä¸º super_admin
            const isAdmin = currentUser && (
                currentUser.is_admin === true || 
                currentUser.is_admin === 'true' ||
                currentUser.role === 'super_admin'
            );
            
            console.log('loadStats - currentUser:', currentUser);
            console.log('loadStats - isAdmin:', isAdmin);
            
            if (!isAdmin) {
                document.getElementById('stats-container').innerHTML = '<p style="color: #999;">ä»…ç®¡ç†å‘˜å¯è§</p>';
                return;
            }
            
            try {
                const response = await apiRequest(`${API_BASE}/admin/stats`, { method: 'GET' });
                if (!response.ok) throw new Error('è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥');
                const stats = await response.json();
                const container = document.getElementById('stats-container');
                container.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value">${stats.total_users || 0}</div>
                            <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${stats.total_devices || 0}</div>
                            <div class="stat-label">æ€»è®¾å¤‡æ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${stats.online_users || 0}</div>
                            <div class="stat-label">åœ¨çº¿ç”¨æˆ·</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${stats.total_rooms || 0}</div>
                            <div class="stat-label">æ€»æˆ¿é—´æ•°</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
                const container = document.getElementById('stats-container');
                if (container) {
                    container.innerHTML = '<p style="color: #e74c3c; text-align: center; padding: 20px;">åŠ è½½å¤±è´¥ï¼Œè¯·<a href="javascript:loadStats()">é‡è¯•</a></p>';
                }
            }
        }
        
        // åŠ è½½æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨ï¼ˆä»…ç®¡ç†å‘˜ï¼›ç”¨æˆ·ç®¡ç†å·²è¿è‡³ç‹¬ç«‹é¡µï¼Œæœ¬å‡½æ•°ä»…é˜²æ®‹ç•™è°ƒç”¨æŠ¥é”™ï¼‰
        async function loadAllUsers() {
            const usersList = document.getElementById('users-list');
            if (!usersList) return;
            const isAdmin = currentUser && (
                currentUser.is_admin === true ||
                currentUser.is_admin === 'true' ||
                currentUser.role === 'super_admin'
            );
            if (!isAdmin) {
                showMessage('æƒé™ä¸è¶³', 'error');
                return;
            }
            try {
                const search = document.getElementById('user-search')?.value || '';
                const url = `${API_BASE}/users/?limit=100${search ? '&search=' + encodeURIComponent(search) : ''}`;
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                if (!response.ok) throw new Error('è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥');
                const data = await response.json();
                if (!data.users || data.users.length === 0) {
                    usersList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">æš‚æ— ç”¨æˆ·</p>';
                    return;
                }
                
                const roleDisplayMap = {
                    'super_admin': 'è¶…çº§ç®¡ç†å‘˜',
                    'room_owner': 'æˆ¿ä¸»',
                    'user': 'æ™®é€šç”¨æˆ·'
                };
                
                usersList.innerHTML = `
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${data.users.map(user => {
                            const roleText = roleDisplayMap[user.role] || user.role || 'æ™®é€šç”¨æˆ·';
                            const isCurrentUser = currentUser && currentUser.id === user.id;
                            const isSuperAdminUser = user.role === 'super_admin';
                            const userStatus = user.is_disabled ? 'ç¦ç”¨' : 'æ­£å¸¸';
                            const statusClass = user.is_disabled ? 'status-offline' : 'status-online';
                            return `
                            <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <strong>${user.nickname || user.username || user.phone}</strong>
                                        <span class="status-badge ${statusClass}">${userStatus}</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                        æ‰‹æœºå·: ${user.phone} | 
                                        ç”¨æˆ·å: ${user.username || 'æœªè®¾ç½®'} | 
                                        è§’è‰²: ${roleText} |
                                        çŠ¶æ€: <span class="status-badge ${statusClass}">${userStatus}</span> |
                                        ${user.is_online ? '<span style="color: green;">â— åœ¨çº¿</span>' : '<span style="color: #999;">â—‹ ç¦»çº¿</span>'}
                                        ${user.is_admin ? ' | <span style="color: orange;">ç®¡ç†å‘˜</span>' : ''}
                                    </div>
                                </div>
                                ${currentUser && currentUser.role === 'super_admin' ? `
                                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                        ${isCurrentUser || isSuperAdminUser ? `
                                            <button onclick="editUser(${user.id})" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px; white-space: nowrap;">ä¿®æ”¹</button>
                                        ` : `
                                            <button onclick="toggleUserStatus(${user.id}, ${user.is_disabled})" class="btn ${user.is_disabled ? 'btn-success' : 'btn-warning'}" style="padding: 6px 12px; font-size: 12px; white-space: nowrap;" title="${user.is_disabled ? 'å¯ç”¨ç”¨æˆ·' : 'ç¦ç”¨ç”¨æˆ·'}">${user.is_disabled ? 'å¼€å¯' : 'ç¦ç”¨'}</button>
                                            <button onclick="editUser(${user.id})" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px; white-space: nowrap;">ä¿®æ”¹</button>
                                        `}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                        }).join('')}
                    </div>
                    <div style="margin-top: 10px; text-align: center; color: #666; font-size: 12px;">
                        å…± ${data.total || 0} ä¸ªç”¨æˆ·
                    </div>
                `;
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
                showMessage('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
                if (usersList) usersList.innerHTML = '<p style="color: #e74c3c; text-align: center; padding: 20px;">åŠ è½½å¤±è´¥ï¼Œè¯·<a href="javascript:loadAllUsers()">é‡è¯•</a></p>';
            }
        }
        
        // åˆ‡æ¢ç”¨æˆ·çŠ¶æ€ï¼ˆç¦ç”¨/å¯ç”¨ï¼‰
        async function toggleUserStatus(userId, currentStatus) {
            const isSuperAdmin = currentUser && currentUser.role === 'super_admin';
            
            if (!isSuperAdmin) {
                showMessage('æƒé™ä¸è¶³ï¼Œä»…è¶…çº§ç®¡ç†å‘˜å¯ä»¥æ“ä½œç”¨æˆ·çŠ¶æ€', 'error');
                return;
            }
            
            // ä¸èƒ½æ“ä½œè‡ªå·±
            if (currentUser && currentUser.id === userId) {
                showMessage('ä¸èƒ½æ“ä½œè‡ªå·±çš„è´¦æˆ·çŠ¶æ€', 'error');
                return;
            }
            
            const action = currentStatus ? 'å¯ç”¨' : 'ç¦ç”¨';
            if (!confirm(`ç¡®å®šè¦${action}è¿™ä¸ªç”¨æˆ·å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                // ä½¿ç”¨æ›´æ–°åçš„APIï¼Œæ”¯æŒåˆ‡æ¢çŠ¶æ€
                const response = await fetch(`${API_BASE}/admin/users/${userId}/disable?is_disabled=${!currentStatus}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || `${action}ç”¨æˆ·å¤±è´¥`);
                }
                
                showMessage(`ç”¨æˆ·å·²${action}`, 'success');
                await loadAllUsers();
            } catch (error) {
                showMessage(`${action}ç”¨æˆ·å¤±è´¥: ` + error.message, 'error');
            }
        }
        
        // ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯
        async function editUser(userId) {
            const isSuperAdmin = currentUser && currentUser.role === 'super_admin';
            const isCurrentUser = currentUser && currentUser.id === userId;
            
            if (!isSuperAdmin && !isCurrentUser) {
                showMessage('æƒé™ä¸è¶³', 'error');
                return;
            }
            
            try {
                // è·å–ç”¨æˆ·ä¿¡æ¯
                const response = await fetch(`${API_BASE}/users/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
                }
                
                const user = await response.json();
                
                // å¼¹å‡ºä¿®æ”¹å¯¹è¯æ¡†
                const newNickname = prompt('ä¿®æ”¹æ˜µç§°ï¼ˆç•™ç©ºä¸ä¿®æ”¹ï¼‰:', user.nickname || '');
                if (newNickname === null) {
                    return; // ç”¨æˆ·å–æ¶ˆ
                }
                
                const newUsername = prompt('ä¿®æ”¹ç”¨æˆ·åï¼ˆç•™ç©ºä¸ä¿®æ”¹ï¼‰:', user.username || '');
                if (newUsername === null) {
                    return; // ç”¨æˆ·å–æ¶ˆ
                }
                
                // æ„å»ºæ›´æ–°æ•°æ®
                const updateData = {};
                if (newNickname !== '' && newNickname !== user.nickname) {
                    updateData.nickname = newNickname;
                }
                if (newUsername !== '' && newUsername !== user.username) {
                    updateData.username = newUsername;
                }
                
                // è¯¢é—®æ˜¯å¦ä¿®æ”¹å¯†ç 
                const changePassword = confirm('æ˜¯å¦ä¿®æ”¹å¯†ç ï¼Ÿ');
                if (changePassword) {
                    // æ‰€æœ‰ç”¨æˆ·ä¿®æ”¹å¯†ç éƒ½éœ€è¦éªŒè¯æ—§å¯†ç ï¼ˆå®‰å…¨æ€§è¦æ±‚ï¼‰
                    const oldPassword = prompt('è¯·è¾“å…¥æ—§å¯†ç :');
                    if (oldPassword === null || oldPassword === '') {
                        showMessage('ä¿®æ”¹å¯†ç å¿…é¡»æä¾›æ—§å¯†ç ', 'error');
                        return;
                    }
                    
                    const newPassword = prompt('è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰:');
                    if (newPassword === null || newPassword === '') {
                        return; // ç”¨æˆ·å–æ¶ˆ
                    }
                    
                    if (newPassword.length < 6) {
                        showMessage('æ–°å¯†ç é•¿åº¦è‡³å°‘6ä½', 'error');
                        return;
                    }
                    
                    // å¦‚æœæ˜¯å½“å‰ç”¨æˆ·ï¼Œä½¿ç”¨ä¿®æ”¹å¯†ç APIï¼ˆéœ€è¦æ—§å¯†ç ï¼‰
                    if (isCurrentUser) {
                        const passwordResponse = await fetch(`${API_BASE}/users/me/change-password`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${getToken()}`
                            },
                            body: JSON.stringify({
                                old_password: oldPassword,
                                new_password: newPassword
                            })
                        });
                        
                        if (!passwordResponse.ok) {
                            const error = await passwordResponse.json();
                            throw new Error(error.detail || 'ä¿®æ”¹å¯†ç å¤±è´¥');
                        }
                    } else {
                        // ç®¡ç†å‘˜ä¿®æ”¹å…¶ä»–ç”¨æˆ·å¯†ç æ—¶ï¼Œä¹Ÿéœ€è¦æä¾›æ—§å¯†ç ï¼ˆå®‰å…¨æ€§è¦æ±‚ï¼‰
                        updateData.password = newPassword;
                        updateData.old_password = oldPassword;
                    }
                }
                
                // å¦‚æœæ²¡æœ‰éœ€è¦æ›´æ–°çš„å†…å®¹
                if (Object.keys(updateData).length === 0) {
                    showMessage('æ²¡æœ‰éœ€è¦ä¿®æ”¹çš„å†…å®¹', 'info');
                    return;
                }
                
                // å‘é€æ›´æ–°è¯·æ±‚
                const updateResponse = await fetch(`${API_BASE}/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify(updateData)
                });
                
                if (!updateResponse.ok) {
                    const error = await updateResponse.json();
                    throw new Error(error.detail || 'ä¿®æ”¹ç”¨æˆ·å¤±è´¥');
                }
                
                showMessage('ç”¨æˆ·ä¿®æ”¹æˆåŠŸ', 'success');
                await loadAllUsers();
                
                // å¦‚æœä¿®æ”¹çš„æ˜¯å½“å‰ç”¨æˆ·ï¼Œåˆ·æ–°ç”¨æˆ·ä¿¡æ¯
                if (isCurrentUser) {
                    await loadUserInfo();
                }
            } catch (error) {
                showMessage('ä¿®æ”¹ç”¨æˆ·å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ˜¾ç¤ºåˆ›å»ºæˆ¿ä¸»è¡¨å•ï¼ˆä»…è¶…çº§ç®¡ç†å‘˜ï¼‰
        function showCreateRoomOwnerForm() {
            const form = prompt('åˆ›å»ºæˆ¿ä¸»\næ ¼å¼ï¼šæ‰‹æœºå·,ç”¨æˆ·å,å¯†ç ,æ˜µç§°,æœ€å¤§æˆ¿é—´æ•°(å¯é€‰)\nä¾‹å¦‚ï¼š13900000001,owner1,password123,æˆ¿ä¸»1,10');
            if (!form) return;
            
            const parts = form.split(',');
            if (parts.length < 4) {
                showMessage('æ ¼å¼é”™è¯¯', 'error');
                return;
            }
            
            const [phone, username, password, nickname, maxRooms] = parts;
            
            createRoomOwner({
                phone: phone.trim(),
                username: username.trim(),
                password: password.trim(),
                nickname: nickname.trim(),
                max_rooms: maxRooms ? parseInt(maxRooms.trim()) : null,
                default_max_occupants: 3
            });
        }
        
        // åˆ›å»ºæˆ¿ä¸»
        async function createRoomOwner(data) {
            try {
                const response = await fetch(`${API_BASE}/admin/room-owners`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'åˆ›å»ºæˆ¿ä¸»å¤±è´¥');
                }
                
                showMessage('æˆ¿ä¸»åˆ›å»ºæˆåŠŸ', 'success');
                await loadAllUsers();
            } catch (error) {
                showMessage('åˆ›å»ºæˆ¿ä¸»å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // åŠ è½½é‚€è¯·ç åˆ—è¡¨ï¼ˆä»…è¶…çº§ç®¡ç†å‘˜ï¼›é‚€è¯·ç ç®¡ç†å·²è¿è‡³ç‹¬ç«‹é¡µï¼Œæœ¬å‡½æ•°ä»…é˜²æ®‹ç•™è°ƒç”¨æŠ¥é”™ï¼‰
        async function loadInvitations() {
            const invitationsList = document.getElementById('invitations-list');
            if (!invitationsList) return;
            const isSuperAdmin = currentUser && currentUser.role === 'super_admin';
            if (!isSuperAdmin) {
                showMessage('æƒé™ä¸è¶³', 'error');
                return;
            }
            try {
                const response = await apiRequest(`${API_BASE}/invitations/?limit=50`, { method: 'GET' });
                if (!response.ok) {
                    let errorMessage = 'è·å–é‚€è¯·ç åˆ—è¡¨å¤±è´¥';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.detail || errorMessage;
                    } catch (e) {
                        errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }
                const data = await response.json();
                const codes = data.codes || data.invitations || [];
                if (!codes || codes.length === 0) {
                    invitationsList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">æš‚æ— é‚€è¯·ç </p>';
                    return;
                }
                invitationsList.innerHTML = `
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${codes.map(inv => `
                            <div style="padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: flex-start; gap: 10px;">
                                <div style="flex: 1;">
                                    <div style="margin-bottom: 5px;"><strong style="font-size: 14px;">${inv.code}</strong></div>
                                    <div style="font-size: 12px; color: #666; line-height: 1.6;">
                                        ä½¿ç”¨æ¬¡æ•°: ${inv.used_count}/${inv.max_uses} |
                                        ${inv.is_active ? '<span style="color: green;">æœ‰æ•ˆ</span>' : '<span style="color: red;">æ— æ•ˆ</span>'} |
                                        ${inv.is_revoked ? '<span style="color: red;">å·²æ’¤å›</span>' : ''}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px; flex-shrink: 0;">
                                    <button onclick="revokeInvitation(${inv.id})" class="btn btn-warning" style="padding: 6px 12px; font-size: 12px; white-space: nowrap;">æ’¤å›</button>
                                    <button onclick="deleteInvitation(${inv.id}, '${inv.code}')" class="btn btn-danger" style="padding: 6px 12px; font-size: 12px; white-space: nowrap; font-weight: 500;">åˆ é™¤</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('åŠ è½½é‚€è¯·ç åˆ—è¡¨å¤±è´¥:', error);
                showMessage('åŠ è½½é‚€è¯·ç åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
                if (invitationsList) invitationsList.innerHTML = '<p style="color: #e74c3c; text-align: center; padding: 20px;">åŠ è½½å¤±è´¥ï¼Œè¯·<a href="javascript:loadInvitations()">é‡è¯•</a></p>';
            }
        }
        
        // æ˜¾ç¤ºåˆ›å»ºé‚€è¯·ç è¡¨å•
        function showCreateInvitationForm() {
            const code = prompt('åˆ›å»ºé‚€è¯·ç \nè¾“å…¥é‚€è¯·ç ï¼ˆç•™ç©ºè‡ªåŠ¨ç”Ÿæˆï¼‰:');
            if (code === null) return;
            
            const maxUses = prompt('æœ€å¤§ä½¿ç”¨æ¬¡æ•°ï¼ˆé»˜è®¤1ï¼‰:') || '1';
            
            createInvitation({
                code: code.trim() || null,
                max_uses: parseInt(maxUses) || 1
            });
        }
        
        // åˆ›å»ºé‚€è¯·ç 
        async function createInvitation(data) {
            try {
                const response = await fetch(`${API_BASE}/invitations/create`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'åˆ›å»ºé‚€è¯·ç å¤±è´¥');
                }
                
                showMessage('é‚€è¯·ç åˆ›å»ºæˆåŠŸ', 'success');
                await loadInvitations();
            } catch (error) {
                showMessage('åˆ›å»ºé‚€è¯·ç å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ’¤å›é‚€è¯·ç 
        async function revokeInvitation(codeId) {
            if (!confirm('ç¡®å®šè¦æ’¤å›è¿™ä¸ªé‚€è¯·ç å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/invitations/${codeId}/revoke`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('æ’¤å›é‚€è¯·ç å¤±è´¥');
                }
                
                showMessage('é‚€è¯·ç å·²æ’¤å›', 'success');
                await loadInvitations();
            } catch (error) {
                showMessage('æ’¤å›é‚€è¯·ç å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // åˆ é™¤é‚€è¯·ç 
        async function deleteInvitation(codeId, code) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é‚€è¯·ç  "${code}" å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/invitations/${codeId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'åˆ é™¤é‚€è¯·ç å¤±è´¥' }));
                    throw new Error(errorData.detail || 'åˆ é™¤é‚€è¯·ç å¤±è´¥');
                }
                
                showMessage('é‚€è¯·ç å·²åˆ é™¤', 'success');
                await loadInvitations();
            } catch (error) {
                showMessage('åˆ é™¤é‚€è¯·ç å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // åŠ è½½äºŒç»´ç é…ç½®ï¼ˆä»…è¶…çº§ç®¡ç†å‘˜ï¼‰
        async function loadQRCodeConfigs() {
            const isSuperAdmin = currentUser && currentUser.role === 'super_admin';
            
            if (!isSuperAdmin) {
                showMessage('æƒé™ä¸è¶³ï¼Œä»…è¶…çº§ç®¡ç†å‘˜å¯ä»¥è®¿é—®', 'error');
                return;
            }
            
            const configsList = document.getElementById('qrcode-configs-list');
            if (!configsList) {
                console.error('æ‰¾ä¸åˆ° qrcode-configs-list å…ƒç´ ');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            configsList.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">åŠ è½½ä¸­...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/admin/system-configs`, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: `HTTP ${response.status}: è·å–é…ç½®å¤±è´¥` }));
                    throw new Error(errorData.detail || `HTTP ${response.status}: è·å–é…ç½®å¤±è´¥`);
                }
                
                const data = await response.json();
                console.log('è·å–åˆ°çš„é…ç½®æ•°æ®:', data);
                
                // ç­›é€‰äºŒç»´ç ç›¸å…³é…ç½®
                const qrcodeConfigs = (data.configs || []).filter(c => 
                    c.config_key && c.config_key.startsWith('qrcode.')
                );
                
                console.log('ç­›é€‰åçš„äºŒç»´ç é…ç½®:', qrcodeConfigs);
                
                if (qrcodeConfigs.length === 0) {
                    configsList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">æš‚æ— é…ç½®ï¼Œè¯·è¿è¡Œåˆå§‹åŒ–è„šæœ¬: <code>python3 scripts/init_qrcode_configs.py</code></p>';
                    return;
                }
                
                // é…ç½®é¡¹å‹å¥½åç§°æ˜ å°„
                const configDisplayNames = {
                    'qrcode.max_scans': 'æœ€å¤§æ‰«ç æ¬¡æ•°',
                    'qrcode.encrypted_enabled': 'åŠ å¯†æ¨¡å¼',
                    'qrcode.plain_enabled': 'æ˜æ–‡æ¨¡å¼',
                    'qrcode.encrypted_max_scans': 'åŠ å¯†æ¨¡å¼æœ€å¤§æ‰«ç æ¬¡æ•°',
                    'qrcode.plain_max_scans': 'æ˜æ–‡æ¨¡å¼æœ€å¤§æ‰«ç æ¬¡æ•°'
                };
                
                // è¿‡æ»¤æ‰å·²åºŸå¼ƒçš„æ—§é…ç½®é¡¹ï¼ˆä¿ç•™ç»Ÿä¸€çš„æ–°é…ç½®é¡¹ï¼‰
                const filteredConfigs = qrcodeConfigs.filter(c => 
                    c.config_key !== 'qrcode.plain_max_scans' && 
                    c.config_key !== 'qrcode.encrypted_max_scans'
                );
                
                if (filteredConfigs.length === 0) {
                    configsList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">æš‚æ— æœ‰æ•ˆé…ç½®é¡¹</p>';
                    return;
                }
                
                configsList.innerHTML = `
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${filteredConfigs.map(config => {
                            const isBoolean = config.config_key.includes('_enabled');
                            const isNumber = config.config_key === 'qrcode.max_scans' || config.config_key.includes('_max_scans');
                            const currentValue = config.config_value || '';
                            const displayName = configDisplayNames[config.config_key] || config.config_key;
                            return `
                            <div style="padding: 8px; border-bottom: 1px solid #ddd; font-size: 12px;">
                                <div style="margin-bottom: 6px;">
                                    <strong style="font-size: 12px; color: #333;">${displayName}</strong>
                                    ${config.description ? `<div style="font-size: 11px; color: #666; margin-top: 2px;">${config.description}</div>` : ''}
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 6px;">
                                    ${isBoolean ? `
                                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                            <input type="checkbox" ${currentValue.toLowerCase() === 'true' ? 'checked' : ''} 
                                                onchange="updateQRCodeConfig('${config.config_key}', this.checked ? 'true' : 'false')"
                                                style="width: 16px; height: 16px; cursor: pointer;">
                                            <span style="font-size: 11px;">${currentValue.toLowerCase() === 'true' ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}</span>
                                        </label>
                                    ` : isNumber ? `
                                        <div style="display: flex; gap: 4px; align-items: center; flex-wrap: nowrap;">
                                            <input type="number" id="config-${config.config_key}" value="${currentValue}" 
                                                min="0" style="padding: 4px 4px; border: 1px solid #ddd; border-radius: 4px; width: 45px; font-size: 11px; flex-shrink: 0;">
                                            <button onclick="updateQRCodeConfig('${config.config_key}', document.getElementById('config-${config.config_key}').value)" 
                                                class="btn btn-primary" style="padding: 4px 8px; font-size: 11px; white-space: nowrap; flex-shrink: 0;">ä¿å­˜</button>
                                        </div>
                                        <span style="font-size: 10px; color: #666; display: block; margin-top: 2px;">ï¼ˆ0è¡¨ç¤ºä¸é™åˆ¶ï¼‰</span>
                                    ` : `
                                        <div style="display: flex; gap: 6px; align-items: center;">
                                            <input type="text" id="config-${config.config_key}" value="${currentValue}" 
                                                style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; flex: 1; font-size: 11px;">
                                            <button onclick="updateQRCodeConfig('${config.config_key}', document.getElementById('config-${config.config_key}').value)" 
                                                class="btn btn-primary" style="padding: 4px 8px; font-size: 11px; white-space: nowrap;">ä¿å­˜</button>
                                        </div>
                                    `}
                                </div>
                            </div>
                        `;
                        }).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('åŠ è½½äºŒç»´ç é…ç½®å¤±è´¥:', error);
                const errorMsg = error.message || 'æœªçŸ¥é”™è¯¯';
                configsList.innerHTML = `<div style="color: #e74c3c; text-align: center; padding: 20px;">
                    <p>åŠ è½½é…ç½®å¤±è´¥: ${errorMsg}</p>
                    <p style="font-size: 0.9em; margin-top: 10px; color: #999;">è¯·æ£€æŸ¥ï¼š</p>
                    <ul style="text-align: left; display: inline-block; margin-top: 10px; color: #999;">
                        <li>æ˜¯å¦å·²è¿è¡Œåˆå§‹åŒ–è„šæœ¬: <code>python3 scripts/init_qrcode_configs.py</code></li>
                        <li>æ˜¯å¦æœ‰è¶…çº§ç®¡ç†å‘˜æƒé™</li>
                        <li>ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸</li>
                    </ul>
                </div>`;
                showMessage('åŠ è½½äºŒç»´ç é…ç½®å¤±è´¥: ' + errorMsg, 'error');
            }
        }
        
        // æ›´æ–°äºŒç»´ç é…ç½®
        async function updateQRCodeConfig(configKey, configValue) {
            const isSuperAdmin = currentUser && currentUser.role === 'super_admin';
            
            if (!isSuperAdmin) {
                showMessage('æƒé™ä¸è¶³ï¼Œä»…è¶…çº§ç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹é…ç½®', 'error');
                return;
            }
            
            try {
                // äº’æ–¥é€»è¾‘ï¼šå¦‚æœå¯ç”¨åŠ å¯†äºŒç»´ç ï¼Œåˆ™ç¦ç”¨æœªåŠ å¯†äºŒç»´ç ï¼›åä¹‹äº¦ç„¶
                if (configKey === 'qrcode.encrypted_enabled' && configValue === 'true') {
                    // å¯ç”¨åŠ å¯†äºŒç»´ç æ—¶ï¼Œç¦ç”¨æœªåŠ å¯†äºŒç»´ç 
                    await fetch(`${API_BASE}/admin/system-configs/qrcode.plain_enabled`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${getToken()}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            config_value: 'false'
                        })
                    });
                } else if (configKey === 'qrcode.plain_enabled' && configValue === 'true') {
                    // å¯ç”¨æœªåŠ å¯†äºŒç»´ç æ—¶ï¼Œç¦ç”¨åŠ å¯†äºŒç»´ç 
                    await fetch(`${API_BASE}/admin/system-configs/qrcode.encrypted_enabled`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${getToken()}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            config_value: 'false'
                        })
                    });
                }
                
                const response = await fetch(`${API_BASE}/admin/system-configs/${encodeURIComponent(configKey)}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        config_value: configValue
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json().catch(() => ({ detail: 'æ›´æ–°é…ç½®å¤±è´¥' }));
                    throw new Error(error.detail || 'æ›´æ–°é…ç½®å¤±è´¥');
                }
                
                showMessage('é…ç½®å·²æ›´æ–°', 'success');
                await loadQRCodeConfigs();
            } catch (error) {
                showMessage('æ›´æ–°é…ç½®å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // åˆ·æ–°æ‰€æœ‰æ•°æ®
        async function refreshData() {
            await loadUserInfo();
            await loadStats();
            showMessage('æ•°æ®å·²åˆ·æ–°', 'success');
        }
        
        // åˆ‡æ¢æˆ¿é—´çŠ¶æ€ï¼ˆç¦ç”¨/å¼€å¯ï¼‰
        async function toggleRoomStatus(roomId, currentStatus) {
            const isSuperAdmin = currentUser && currentUser.role === 'super_admin';
            
            if (!isSuperAdmin) {
                showMessage('æƒé™ä¸è¶³ï¼Œä»…è¶…çº§ç®¡ç†å‘˜å¯ä»¥æ“ä½œæˆ¿é—´çŠ¶æ€', 'error');
                return;
            }
            
            const action = currentStatus ? 'ç¦ç”¨' : 'å¼€å¯';
            if (!confirm(`ç¡®å®šè¦${action}è¿™ä¸ªæˆ¿é—´å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                // ä½¿ç”¨æ›´æ–°æˆ¿é—´APIæ¥åˆ‡æ¢çŠ¶æ€
                const response = await fetch(`${API_BASE}/rooms/${roomId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify({
                        is_active: !currentStatus
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || `${action}æˆ¿é—´å¤±è´¥`);
                }
                
                showMessage(`æˆ¿é—´å·²${action}`, 'success');
                await loadRooms();
            } catch (error) {
                showMessage(`${action}æˆ¿é—´å¤±è´¥: ` + error.message, 'error');
            }
        }
        
        // åˆ é™¤æˆ¿é—´
        async function deleteRoom(roomId) {
            const isSuperAdmin = currentUser && currentUser.role === 'super_admin';
            
            if (!isSuperAdmin) {
                showMessage('æƒé™ä¸è¶³ï¼Œä»…è¶…çº§ç®¡ç†å‘˜å¯ä»¥åˆ é™¤æˆ¿é—´', 'error');
                return;
            }
            
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæˆ¿é—´å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/rooms/${roomId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json().catch(() => ({ detail: 'åˆ é™¤æˆ¿é—´å¤±è´¥' }));
                    throw new Error(error.detail || 'åˆ é™¤æˆ¿é—´å¤±è´¥');
                }
                
                showMessage('æˆ¿é—´å·²åˆ é™¤', 'success');
                await loadRooms();
            } catch (error) {
                showMessage('åˆ é™¤æˆ¿é—´å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // ä¿®æ”¹æˆ¿é—´
        async function editRoom(roomId) {
            try {
                // è·å–æˆ¿é—´ä¿¡æ¯
                const response = await fetch(`${API_BASE}/rooms/${roomId}`, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('è·å–æˆ¿é—´ä¿¡æ¯å¤±è´¥');
                }
                
                const room = await response.json();
                
                // å¼¹å‡ºä¿®æ”¹å¯¹è¯æ¡†
                const newRoomName = prompt('ä¿®æ”¹æˆ¿é—´åç§°ï¼ˆç•™ç©ºä¸ä¿®æ”¹ï¼‰:', room.room_name || '');
                if (newRoomName === null) {
                    return; // ç”¨æˆ·å–æ¶ˆ
                }
                
                const newMaxOccupants = prompt('ä¿®æ”¹æœ€å¤§äººæ•°ï¼ˆç•™ç©ºä¸ä¿®æ”¹ï¼Œå½“å‰: ' + room.max_occupants + 'ï¼‰:', room.max_occupants);
                if (newMaxOccupants === null) {
                    return; // ç”¨æˆ·å–æ¶ˆ
                }
                
                // æ„å»ºæ›´æ–°æ•°æ®
                const updateData = {};
                if (newRoomName !== '' && newRoomName !== room.room_name) {
                    updateData.room_name = newRoomName;
                }
                if (newMaxOccupants !== '' && parseInt(newMaxOccupants) !== room.max_occupants) {
                    updateData.max_occupants = parseInt(newMaxOccupants);
                }
                
                // å¦‚æœæ²¡æœ‰éœ€è¦æ›´æ–°çš„å†…å®¹
                if (Object.keys(updateData).length === 0) {
                    showMessage('æ²¡æœ‰éœ€è¦ä¿®æ”¹çš„å†…å®¹', 'info');
                    return;
                }
                
                // å‘é€æ›´æ–°è¯·æ±‚
                const updateResponse = await fetch(`${API_BASE}/rooms/${roomId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify(updateData)
                });
                
                if (!updateResponse.ok) {
                    const error = await updateResponse.json();
                    throw new Error(error.detail || 'ä¿®æ”¹æˆ¿é—´å¤±è´¥');
                }
                
                showMessage('æˆ¿é—´ä¿®æ”¹æˆåŠŸ', 'success');
            } catch (error) {
                showMessage('ä¿®æ”¹æˆ¿é—´å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // é€€å‡ºç™»å½•
        async function logout() {
            try {
                await fetch(`${API_BASE}/auth/logout`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
            } catch (error) {
                console.error('é€€å‡ºå¤±è´¥:', error);
            }
            
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            window.location.href = '/login';
        }
        
        // åˆå§‹åŒ–Socket.ioè¿æ¥
        function initSocket() {
            try {
                const socketIOUrl = window.location.origin.replace(/^http/, 'ws') + '/socket.io/';
                // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦æ ¹æ®å®é™…çš„Socket.ioå®¢æˆ·ç«¯åº“æ¥å®ç°
                // æš‚æ—¶åªæ˜¾ç¤ºè¿æ¥çŠ¶æ€
                document.getElementById('connection-status').textContent = 'å·²è¿æ¥';
                document.getElementById('connection-status').className = 'status-badge status-online';
            } catch (error) {
                console.error('Socketè¿æ¥å¤±è´¥:', error);
                document.getElementById('connection-status').textContent = 'æœªè¿æ¥';
                document.getElementById('connection-status').className = 'status-badge status-offline';
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', async () => {
            // åˆå§‹åŒ–ç§»åŠ¨ç«¯èœå•æŒ‰é’®
            updateMobileMenuButton();
            const token = getToken();
            if (!token) {
                showMessage('æœªç™»å½•ï¼Œæ­£åœ¨è·³è½¬åˆ°ç™»å½•é¡µé¢...', 'info');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 1500);
                return;
            }
            
            // ä¾æ¬¡åŠ è½½æ•°æ®ï¼Œå³ä½¿æŸä¸ªå¤±è´¥ä¹Ÿç»§ç»­åŠ è½½å…¶ä»–æ•°æ®
            try {
                await loadUserInfo();
            } catch (e) {
                console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', e);
            }
            
            try {
                await loadStats();
            } catch (e) {
                console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', e);
            }
            
            // æ·»åŠ å¥½å‹æœç´¢æ¡†ç›‘å¬å™¨ï¼ˆå›è½¦é”®æœç´¢ï¼‰
            const friendSearchInput = document.getElementById('friend-search');
            if (friendSearchInput) {
                friendSearchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        searchUsers();
                    }
                });
            }
            
            try {
                initSocket();
            } catch (e) {
                console.error('åˆå§‹åŒ–Socketå¤±è´¥:', e);
            }
        });
    </script>
</body>
</html>
