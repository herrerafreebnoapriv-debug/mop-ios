<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>MOP - ä¸»æ§åˆ¶å°</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico?v=20260112">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            max-width: 100%;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header h1 {
            font-size: 1.5em;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .user-name {
            font-weight: 500;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        /* Header ä¸­çš„æŒ‰é’®æ ·å¼ */
        .header .btn-primary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .header .btn-primary:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* é€šç”¨ btn-primary æ ·å¼ï¼ˆç”¨äºå†…å®¹åŒºåŸŸï¼‰ */
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #5568d3 0%, #653a91 100%);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        /* ä¸»å¸ƒå±€ï¼šå·¦ä¾§èœå• + å³ä¾§å†…å®¹ */
        .main-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        /* å·¦ä¾§ç³»ç»Ÿèœå•æ  */
        .sidebar {
            width: 250px;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            padding: 20px 0;
            overflow-y: auto;
            position: sticky;
            top: 0;
            height: calc(100vh - 80px);
        }
        
        .sidebar-menu {
            list-style: none;
        }
        
        .sidebar-menu-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }
        
        .sidebar-menu-item:hover {
            background: #f5f7fa;
            border-left-color: #667eea;
        }
        
        .sidebar-menu-item.active {
            background: #f0f4ff;
            border-left-color: #667eea;
            color: #667eea;
            font-weight: 600;
        }
        
        .sidebar-menu-item-icon {
            margin-right: 10px;
            font-size: 1.2em;
        }
        
        /* å³ä¾§ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            height: calc(100vh - 80px);
        }
        
        /* 4åˆ— Grid å¸ƒå±€ - å››åˆ—å¹³å‡åˆ†é…ç©ºé—´ */
        .cards-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            grid-auto-rows: min-content; /* è¡Œé«˜åº¦æ ¹æ®å†…å®¹è‡ªåŠ¨è°ƒæ•´ */
            gap: 20px;
            margin-bottom: 30px;
            align-items: start; /* æ‰€æœ‰å¡ç‰‡ä»é¡¶éƒ¨å¯¹é½ */
        }
        
        /* ç¡®ä¿æ‰€æœ‰åˆ—å¹³å‡åˆ†é… */
        .cards-grid > * {
            min-width: 0; /* é˜²æ­¢å†…å®¹æº¢å‡º */
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            height: fit-content; /* é«˜åº¦é€‚åº”å†…å®¹ */
            display: flex;
            flex-direction: column;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        /* æˆ¿é—´åˆ—è¡¨å’Œè®¾å¤‡åˆ—è¡¨å¡ç‰‡éœ€è¦æ»šåŠ¨ */
        #rooms-list-card,
        #devices-card {
            max-height: calc(100vh - 200px); /* é™åˆ¶æœ€å¤§é«˜åº¦ */
            overflow-y: auto; /* å†…å®¹è¶…å‡ºæ—¶æ»šåŠ¨ */
        }
        
        #rooms-list-card .room-list,
        #devices-card #devices-list {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .card h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-icon {
            font-size: 1.5em;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn-block {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .btn-block:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-block:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .room-list {
            list-style: none;
            margin-top: 15px;
        }
        
        .room-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 15px;
        }
        
        .room-info {
            flex: 1;
            min-width: 0; /* é˜²æ­¢å†…å®¹æº¢å‡º */
        }
        
        .room-actions {
            display: flex !important;
            flex-direction: column !important;
            gap: 5px !important;
            flex-shrink: 0 !important; /* é˜²æ­¢æŒ‰é’®åŒºåŸŸè¢«å‹ç¼© */
            min-width: 80px !important; /* ç¡®ä¿æŒ‰é’®æœ‰è¶³å¤Ÿå®½åº¦ */
            width: 80px !important; /* å›ºå®šå®½åº¦ç¡®ä¿æ˜¾ç¤º */
        }
        
        .room-actions .btn {
            display: block !important;
            width: 100% !important;
            margin: 0 !important;
            padding: 6px 12px !important;
            font-size: 12px !important;
            white-space: nowrap !important;
        }
        
        /* æˆ¿é—´æ“ä½œæŒ‰é’®çš„ä¸“é—¨æ ·å¼ */
        .room-actions .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            border: none !important;
            font-weight: 500 !important;
        }
        
        .room-actions .btn-primary:hover {
            background: linear-gradient(135deg, #5568d3 0%, #653a91 100%) !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4) !important;
        }
        
        .room-actions .btn-danger {
            background: #e74c3c !important;
            color: white !important;
            border: none !important;
            font-weight: 500 !important;
        }
        
        .room-actions .btn-danger:hover {
            background: #c0392b !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.4) !important;
        }
        
        .room-actions .btn-warning {
            background: #f39c12 !important;
            color: white !important;
            border: none !important;
            font-weight: 500 !important;
        }
        
        .room-actions .btn-warning:hover {
            background: #e67e22 !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 2px 8px rgba(243, 156, 18, 0.4) !important;
        }
        
        .room-actions .btn-success {
            background: #27ae60 !important;
            color: white !important;
            border: none !important;
            font-weight: 500 !important;
        }
        
        .room-actions .btn-success:hover {
            background: #229954 !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 2px 8px rgba(39, 174, 96, 0.4) !important;
        }
        
        .room-actions .btn:disabled {
            opacity: 0.5 !important;
            cursor: not-allowed !important;
            transform: none !important;
        }
        
        .room-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .room-meta {
            font-size: 12px;
            color: #666;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-online {
            background: #d4edda;
            color: #155724;
        }
        
        .status-offline {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* æ¶ˆæ¯å®¹å™¨ - å›ºå®šåœ¨é¡µé¢ä¸­é—´ */
        #messages {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10000;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .message {
            padding: 16px 24px;
            border-radius: 8px;
            display: none;
            min-width: 300px;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            pointer-events: auto;
            animation: messageSlideIn 0.3s ease-out;
        }
        
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .message-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .qrcode-container {
            text-align: center;
            margin-top: 15px;
        }
        
        .qrcode-container img {
            max-width: 200px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #666;
        }
        
        /* å¡ç‰‡ Grid ä½ç½®å®šä¹‰ - å››åˆ—å¹³å‡åˆ†é… */
        /* ç¬¬1åˆ—ï¼šç”¨æˆ·ä¿¡æ¯ï¼ˆåŒ…å«ç³»ç»Ÿç»Ÿè®¡ï¼‰ */
        #user-info-card {
            grid-column: 1;
            grid-row: 1;
            align-self: start;
        }
        
        /* ç¬¬2åˆ—ï¼šåˆ›å»ºæˆ¿é—´ï¼ˆåŒ…å«æˆ¿é—´äºŒç»´ç ï¼‰ */
        #create-room-card {
            grid-column: 2;
            grid-row: 1;
            align-self: start;
        }
        
        /* ç¬¬3åˆ—ï¼šæˆ‘çš„æˆ¿é—´ - å•ç‹¬ä¸€åˆ—ï¼Œè·¨2è¡Œï¼Œå…è®¸å†…å®¹æº¢å‡º */
        #rooms-list-card {
            grid-column: 3;
            grid-row: 1 / 3;
            align-self: start;
            overflow-y: auto;
            max-height: 100%;
        }
        
        /* ç¬¬4åˆ—ï¼šè®¾å¤‡ç®¡ç† - å•ç‹¬ä¸€åˆ—ï¼Œè·¨2è¡Œï¼Œå…è®¸å†…å®¹æº¢å‡º */
        #devices-card {
            grid-column: 4;
            grid-row: 1 / 3;
            align-self: start;
            overflow-y: auto;
            max-height: 100%;
        }
        
        #user-management-card {
            grid-column: 1 / 5;
            grid-row: 3;
        }
        
        #invitation-management-card {
            grid-column: 1 / 5;
            grid-row: 4;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1400px) {
            .cards-grid {
                grid-template-columns: 1fr 1fr 1fr 1fr;
            }
            
            #user-info-card {
                grid-column: 1;
                grid-row: 1;
            }
            
            /* ç¬¬2åˆ—ï¼šåˆ›å»ºæˆ¿é—´ï¼ˆåŒ…å«äºŒç»´ç ï¼‰ */
            #create-room-card {
                grid-column: 2;
                grid-row: 1;
            }
            
            /* ç¬¬3åˆ—ï¼šæˆ‘çš„æˆ¿é—´ - å•ç‹¬ä¸€åˆ— */
            #rooms-list-card {
                grid-column: 3;
                grid-row: 1 / 3;
            }
            
            /* ç¬¬4åˆ—ï¼šè®¾å¤‡ç®¡ç† - å•ç‹¬ä¸€åˆ— */
            #devices-card {
                grid-column: 4;
                grid-row: 1 / 3;
            }
            
            #user-management-card {
                grid-column: 1 / 5;
                grid-row: 3;
            }
            
            #invitation-management-card {
                grid-column: 1 / 5;
                grid-row: 4;
            }
        }
        
        @media (max-width: 1200px) {
            .cards-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            #user-info-card {
                grid-column: 1;
                grid-row: 1;
            }
            
            #create-room-card {
                grid-column: 2;
                grid-row: 1;
            }
            
            #rooms-list-card {
                grid-column: 1;
                grid-row: 2;
            }
            
            #devices-card {
                grid-column: 2;
                grid-row: 2;
            }
            
            #user-management-card {
                grid-column: 1 / 3;
                grid-row: 3;
            }
            
            #invitation-management-card {
                grid-column: 1 / 3;
                grid-row: 4;
            }
        }
        
        @media (max-width: 768px) {
            .main-layout {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                display: none;
            }
            
            .sidebar.mobile-open {
                display: block;
            }
            
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .cards-grid {
                grid-template-columns: 1fr;
            }
            
            #user-info-card,
            #create-room-card,
            #rooms-list-card,
            #devices-card,
            #stats-card,
            #qrcode-card,
            #user-management-card,
            #invitation-management-card {
                grid-column: 1;
                grid-row: auto;
            }
            
            .main-content {
                height: auto;
            }
            
            /* ç§»åŠ¨ç«¯æ¶ˆæ¯æ ·å¼è°ƒæ•´ */
            .message {
                min-width: 280px;
                max-width: 90vw;
                padding: 14px 20px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div style="display: flex; align-items: center; gap: 10px;">
                <button class="btn btn-primary" id="mobile-menu-btn" onclick="toggleMobileMenu()" style="display: none; padding: 8px 12px;">â˜°</button>
                <h1>ğŸ  MOP ä¸»æ§åˆ¶å°</h1>
            </div>
            <div class="user-info">
                <span class="user-name" id="user-name">åŠ è½½ä¸­...</span>
                <span class="status-badge status-offline" id="connection-status">æœªè¿æ¥</span>
                <button class="btn btn-primary" onclick="refreshData()">åˆ·æ–°</button>
                <button class="btn btn-danger" onclick="logout()">é€€å‡º</button>
            </div>
        </div>
    </div>
    
    <div class="main-layout">
        <!-- å·¦ä¾§ç³»ç»Ÿèœå•æ  -->
        <aside class="sidebar" id="sidebar">
            <ul class="sidebar-menu">
                <li class="sidebar-menu-item active" onclick="scrollToCard('user-info-card')">
                    <span class="sidebar-menu-item-icon">ğŸ‘¤</span>
                    ç”¨æˆ·ä¿¡æ¯
                </li>
                <li class="sidebar-menu-item" onclick="scrollToCard('create-room-card')">
                    <span class="sidebar-menu-item-icon">ğŸ </span>
                    åˆ›å»ºæˆ¿é—´
                </li>
                <li class="sidebar-menu-item" onclick="scrollToCard('rooms-list-card')">
                    <span class="sidebar-menu-item-icon">ğŸ“‹</span>
                    æˆ‘çš„æˆ¿é—´
                </li>
                <li class="sidebar-menu-item" onclick="scrollToCard('devices-card')">
                    <span class="sidebar-menu-item-icon">ğŸ“±</span>
                    è®¾å¤‡ç®¡ç†
                </li>
                <li class="sidebar-menu-item" onclick="scrollToCard('user-management-card')" id="user-management-menu-item" style="display: none;">
                    <span class="sidebar-menu-item-icon">ğŸ‘¥</span>
                    ç”¨æˆ·ç®¡ç†
                </li>
                <li class="sidebar-menu-item" onclick="scrollToCard('invitation-management-card')" id="invitation-management-menu-item" style="display: none;">
                    <span class="sidebar-menu-item-icon">ğŸ«</span>
                    é‚€è¯·ç ç®¡ç†
                </li>
            </ul>
            
            <!-- æ‰«ç é…ç½®ï¼ˆä»…è¶…çº§ç®¡ç†å‘˜å¯è§ï¼‰ -->
            <div id="qrcode-configs-sidebar" style="display: none; margin-top: 20px; padding: 0 20px;">
                <h3 style="font-size: 1em; margin-bottom: 10px; color: #333; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                    <span>âš™ï¸</span> æ‰«ç é…ç½®
                </h3>
                <button class="btn btn-primary" onclick="loadQRCodeConfigs()" style="width: 100%; padding: 8px 12px; font-size: 13px; margin-bottom: 10px;">åˆ·æ–°é…ç½®</button>
                <div id="qrcode-configs-list" style="max-height: 400px; overflow-y: auto; background: #f8f9fa; border-radius: 6px; padding: 10px;">
                    <p style="color: #999; text-align: center; padding: 10px; font-size: 12px;">ç‚¹å‡»"åˆ·æ–°é…ç½®"åŠ è½½</p>
                </div>
            </div>
        </aside>
        
        <!-- å³ä¾§ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <div id="messages"></div>
            
            <div class="cards-grid">
            <!-- ç”¨æˆ·ä¿¡æ¯ï¼ˆåŒ…å«ç³»ç»Ÿç»Ÿè®¡ï¼‰ -->
            <div class="card" id="user-info-card">
                <h2><span class="card-icon">ğŸ‘¤</span> ç”¨æˆ·ä¿¡æ¯</h2>
                <div id="user-details">
                    <p style="color: #999; text-align: center; padding: 20px;">åŠ è½½ä¸­...</p>
                </div>
                <hr style="margin: 20px 0; border: none; border-top: 1px solid #e0e0e0;">
                <h3 style="font-size: 1.1em; margin-bottom: 15px; color: #333;"><span class="card-icon">ğŸ“Š</span> ç³»ç»Ÿç»Ÿè®¡</h3>
                <div id="stats-container">
                    <p style="color: #999; text-align: center; padding: 20px;">åŠ è½½ä¸­...</p>
                </div>
            </div>
            
            <!-- åˆ›å»ºæˆ¿é—´ï¼ˆåŒ…å«æˆ¿é—´äºŒç»´ç ï¼‰ -->
            <div class="card" id="create-room-card">
                <h2><span class="card-icon">ğŸ </span> åˆ›å»ºæˆ¿é—´</h2>
                <form id="create-room-form">
                    <div class="form-group">
                        <label>æˆ¿é—´åç§°</label>
                        <input type="text" id="room-name" placeholder="è¾“å…¥æˆ¿é—´åç§°ï¼ˆå¯é€‰ï¼‰">
                    </div>
                    <div class="form-group">
                        <label>æœ€å¤§äººæ•°</label>
                        <input type="number" id="max-occupants" value="10" min="1" max="100">
                    </div>
                    <button type="submit" class="btn-block">åˆ›å»ºæˆ¿é—´</button>
                </form>
                <hr style="margin: 20px 0; border: none; border-top: 1px solid #e0e0e0;">
                <h3 style="font-size: 1.1em; margin-bottom: 15px; color: #333;"><span class="card-icon">ğŸ“±</span> æˆ¿é—´äºŒç»´ç </h3>
                <div class="form-group">
                    <label>æˆ¿é—´ID</label>
                    <input type="text" id="qrcode-room-id" placeholder="è¾“å…¥æˆ¿é—´ID">
                </div>
                <button class="btn-block" onclick="generateQRCode()">ç”ŸæˆäºŒç»´ç </button>
                <div class="qrcode-container" id="qrcode-container"></div>
            </div>
            
            <!-- æˆ‘çš„æˆ¿é—´åˆ—è¡¨ -->
            <div class="card" id="rooms-list-card">
                <h2><span class="card-icon">ğŸ“‹</span> æˆ‘çš„æˆ¿é—´</h2>
                <div id="rooms-list">
                    <p style="color: #999; text-align: center; padding: 20px;">åŠ è½½ä¸­...</p>
                </div>
            </div>
            
            <!-- è®¾å¤‡ç®¡ç† -->
            <div class="card" id="devices-card">
                <h2><span class="card-icon">ğŸ“±</span> è®¾å¤‡ç®¡ç†</h2>
                <div id="devices-list">
                    <p style="color: #999; text-align: center; padding: 20px;">åŠ è½½ä¸­...</p>
                </div>
                <button class="btn-block" onclick="loadDevices()">åˆ·æ–°è®¾å¤‡åˆ—è¡¨</button>
            </div>
            
            <!-- ç”¨æˆ·ç®¡ç†ï¼ˆä»…ç®¡ç†å‘˜å¯è§ï¼‰ -->
            <div class="card" id="user-management-card" style="display: none;">
                <h2><span class="card-icon">ğŸ‘¥</span> ç”¨æˆ·ç®¡ç†</h2>
                <div style="margin-bottom: 15px;">
                    <input type="text" id="user-search" placeholder="æœç´¢ç”¨æˆ·ï¼ˆæ‰‹æœºå·/ç”¨æˆ·åï¼‰" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button class="btn-block" onclick="loadAllUsers()" style="flex: 1;">åˆ·æ–°ç”¨æˆ·åˆ—è¡¨</button>
                        <button class="btn-block" onclick="showCreateRoomOwnerForm()" id="create-room-owner-btn" style="flex: 1; display: none;">åˆ›å»ºæˆ¿ä¸»</button>
                    </div>
                </div>
                <div id="users-list">
                    <p style="color: #999; text-align: center; padding: 20px;">ç‚¹å‡»"åˆ·æ–°ç”¨æˆ·åˆ—è¡¨"åŠ è½½</p>
                </div>
            </div>
            
            <!-- é‚€è¯·ç ç®¡ç†ï¼ˆä»…è¶…çº§ç®¡ç†å‘˜å¯è§ï¼‰ -->
            <div class="card" id="invitation-management-card" style="display: none;">
                <h2><span class="card-icon">ğŸ«</span> é‚€è¯·ç ç®¡ç†</h2>
                <div style="margin-bottom: 15px;">
                    <button class="btn-block" onclick="showCreateInvitationForm()">åˆ›å»ºé‚€è¯·ç </button>
                    <button class="btn-block" onclick="loadInvitations()" style="margin-top: 10px;">åˆ·æ–°é‚€è¯·ç åˆ—è¡¨</button>
                </div>
                <div id="invitations-list">
                    <p style="color: #999; text-align: center; padding: 20px;">ç‚¹å‡»"åˆ·æ–°é‚€è¯·ç åˆ—è¡¨"åŠ è½½</p>
                </div>
            </div>
            
            </div>
        </main>
    </div>
    
    <script>
        // æ»šåŠ¨åˆ°æŒ‡å®šå¡ç‰‡
        function scrollToCard(cardId) {
            const card = document.getElementById(cardId);
            if (card) {
                card.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // æ›´æ–°èœå•é¡¹æ¿€æ´»çŠ¶æ€
                document.querySelectorAll('.sidebar-menu-item').forEach(item => {
                    item.classList.remove('active');
                });
                event.target.closest('.sidebar-menu-item')?.classList.add('active');
            }
        }
        
        // ç§»åŠ¨ç«¯èœå•åˆ‡æ¢
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('mobile-open');
        }
        
        // æ˜¾ç¤º/éšè—ç§»åŠ¨ç«¯èœå•æŒ‰é’®
        function updateMobileMenuButton() {
            const menuBtn = document.getElementById('mobile-menu-btn');
            if (window.innerWidth <= 768) {
                menuBtn.style.display = 'block';
            } else {
                menuBtn.style.display = 'none';
                document.getElementById('sidebar').classList.remove('mobile-open');
            }
        }
        
        // ç›‘å¬çª—å£å¤§å°å˜åŒ–
        window.addEventListener('resize', updateMobileMenuButton);
        // è‡ªåŠ¨æ£€æµ‹ API åŸºç¡€è·¯å¾„
        function getApiBase() {
            const hostname = window.location.hostname;
            if (hostname === 'www.chat5202ol.xyz' || hostname === 'app.chat5202ol.xyz') {
                return 'https://api.chat5202ol.xyz/api/v1';
            }
            return '/api/v1';
        }
        
        const API_BASE = getApiBase();
        let currentUser = null;
        let socket = null;
        
        // è·å–Token
        function getToken() {
            return localStorage.getItem('access_token');
        }
        
        // ç»Ÿä¸€çš„APIè¯·æ±‚å‡½æ•°ï¼Œè‡ªåŠ¨å¤„ç†401é”™è¯¯
        async function apiRequest(url, options = {}) {
            const token = getToken();
            if (!token) {
                showMessage('æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•', 'error');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
                throw new Error('æœªç™»å½•');
            }
            
            // ç¡®ä¿æœ‰headers
            if (!options.headers) {
                options.headers = {};
            }
            
            // æ·»åŠ Authorizationå¤´
            options.headers['Authorization'] = `Bearer ${token}`;
            
            // å¦‚æœæ²¡æœ‰Content-Typeï¼Œé»˜è®¤è®¾ç½®ä¸ºapplication/json
            if (!options.headers['Content-Type'] && options.body && typeof options.body === 'string') {
                options.headers['Content-Type'] = 'application/json';
            }
            
            const response = await fetch(url, options);
            
            // å¤„ç†401é”™è¯¯
            if (response.status === 401) {
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                showMessage('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
                throw new Error('ç™»å½•å·²è¿‡æœŸ');
            }
            
            return response;
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const message = document.createElement('div');
            message.className = `message message-${type}`;
            message.textContent = text;
            message.style.display = 'block';
            messagesDiv.appendChild(message);
            
            // å»¶è¿Ÿåæ·»åŠ æ·¡å‡ºåŠ¨ç”»å¹¶ç§»é™¤
            setTimeout(() => {
                message.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
                message.style.opacity = '0';
                message.style.transform = 'translateY(-20px)';
                setTimeout(() => {
                    message.remove();
                }, 300);
            }, 5000);
        }
        
        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        async function loadUserInfo() {
            try {
                const token = getToken();
                if (!token) {
                    showMessage('æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•', 'error');
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                    return;
                }
                
                const response = await fetch(`${API_BASE}/auth/me`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('access_token');
                        showMessage('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                        setTimeout(() => {
                            window.location.href = '/login';
                        }, 2000);
                        return;
                    }
                    const errorData = await response.json().catch(() => ({ detail: 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥' }));
                    throw new Error(errorData.detail || `HTTP ${response.status}: è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥`);
                }
                
                currentUser = await response.json();
                
                // è°ƒè¯•æ—¥å¿—
                console.log('ç”¨æˆ·ä¿¡æ¯åŠ è½½:', currentUser);
                console.log('is_admin:', currentUser.is_admin, typeof currentUser.is_admin);
                console.log('role:', currentUser.role, typeof currentUser.role);
                
                document.getElementById('user-name').textContent = currentUser.nickname || currentUser.username;
                
                // æ˜¾ç¤ºç”¨æˆ·è¯¦æƒ…
                const userDetails = document.getElementById('user-details');
                
                // ç¡®å®šç®¡ç†å‘˜çŠ¶æ€å’Œè§’è‰²æ˜¾ç¤º
                const isAdmin = currentUser.is_admin === true || 
                               currentUser.is_admin === 'true' || 
                               currentUser.role === 'super_admin';
                const roleDisplay = currentUser.role === 'super_admin' ? 'è¶…çº§ç®¡ç†å‘˜' : 
                                    currentUser.role === 'room_owner' ? 'æˆ¿ä¸»' : 
                                    currentUser.role === 'user' ? 'æ™®é€šç”¨æˆ·' : 
                                    (currentUser.role || 'æœªçŸ¥');
                
                userDetails.innerHTML = `
                    <div style="line-height: 1.8;">
                        <div><strong>ç”¨æˆ·å:</strong> ${currentUser.username || 'æœªè®¾ç½®'}</div>
                        <div><strong>æ‰‹æœºå·:</strong> ${currentUser.phone || 'æœªè®¾ç½®'}</div>
                        <div><strong>æ˜µç§°:</strong> ${currentUser.nickname || 'æœªè®¾ç½®'}</div>
                        <div><strong>è¯­è¨€:</strong> ${currentUser.language || 'zh_CN'}</div>
                        <div><strong>è§’è‰²:</strong> ${roleDisplay}</div>
                        <div><strong>ç®¡ç†å‘˜:</strong> ${isAdmin ? 'æ˜¯' : 'å¦'}</div>
                    </div>
                `;
                
                // æ›´æ–°å…¨å±€ç”¨æˆ·å¯¹è±¡ï¼Œç¡®ä¿æƒé™æ£€æŸ¥æ­£ç¡®
                // ä¿ç•™åŸå§‹å€¼ï¼ŒåŒæ—¶è®¾ç½®è®¡ç®—åçš„å€¼
                currentUser.is_admin = isAdmin;
                currentUser.role = currentUser.role || 'user';
                
                // ç¡®ä¿æ‰€æœ‰æƒé™æ£€æŸ¥å‡½æ•°éƒ½èƒ½æ­£ç¡®å·¥ä½œ
                console.log('æ›´æ–°åçš„ç”¨æˆ·å¯¹è±¡:', currentUser);
                console.log('ç®¡ç†å‘˜çŠ¶æ€æ£€æŸ¥:', {
                    'is_admin === true': currentUser.is_admin === true,
                    'is_admin å€¼': currentUser.is_admin,
                    'role === super_admin': currentUser.role === 'super_admin',
                    'role å€¼': currentUser.role
                });
                
                // å¦‚æœæ˜¯ç®¡ç†å‘˜ï¼Œæ˜¾ç¤ºç®¡ç†å‘˜åŠŸèƒ½
                if (isAdmin) {
                    document.getElementById('user-management-card').style.display = 'block';
                    document.getElementById('user-management-menu-item').style.display = 'block';
                    // å¦‚æœæ˜¯è¶…çº§ç®¡ç†å‘˜ï¼Œæ˜¾ç¤ºåˆ›å»ºæˆ¿ä¸»æŒ‰é’®ã€é‚€è¯·ç ç®¡ç†ã€æ‰«ç é…ç½®
                    if (currentUser.role === 'super_admin') {
                        document.getElementById('create-room-owner-btn').style.display = 'block';
                        document.getElementById('invitation-management-card').style.display = 'block';
                        document.getElementById('invitation-management-menu-item').style.display = 'block';
                        document.getElementById('qrcode-configs-sidebar').style.display = 'block';
                        // è‡ªåŠ¨åŠ è½½æ‰«ç é…ç½®
                        loadQRCodeConfigs();
                    }
                    // ç³»ç»Ÿç»Ÿè®¡èœå•é¡¹ï¼ˆå¦‚æœå­˜åœ¨åˆ™æ˜¾ç¤ºï¼‰
                    const statsMenuItem = document.getElementById('stats-menu-item');
                    if (statsMenuItem) {
                        statsMenuItem.style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                showMessage('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ' + (error.message || 'ç½‘ç»œé”™è¯¯'), 'error');
            }
        }
        
        // åŠ è½½æˆ¿é—´åˆ—è¡¨
        async function loadRooms() {
            try {
                const token = getToken();
                if (!token) {
                    return;
                }
                
                const response = await fetch(`${API_BASE}/rooms/`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('access_token');
                        window.location.href = '/login';
                        return;
                    }
                    const errorData = await response.json().catch(() => ({ detail: 'è·å–æˆ¿é—´åˆ—è¡¨å¤±è´¥' }));
                    throw new Error(errorData.detail || `HTTP ${response.status}: è·å–æˆ¿é—´åˆ—è¡¨å¤±è´¥`);
                }
                
                const rooms = await response.json();
                const roomsList = document.getElementById('rooms-list');
                
                if (rooms.length === 0) {
                    roomsList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">æš‚æ— æˆ¿é—´ï¼Œè¯·åˆ›å»ºæˆ¿é—´</p>';
                    return;
                }
                
                roomsList.innerHTML = rooms.map(room => `
                    <div class="room-item">
                        <div class="room-info">
                            <div class="room-name">${room.room_name || room.room_id}</div>
                            <div class="room-meta">
                                æˆ¿é—´ID: ${room.room_id}<br>
                                äººæ•°: ${room.participant_count}/${room.max_occupants} | 
                                çŠ¶æ€: <span class="status-badge ${room.is_active ? 'status-online' : 'status-offline'}">${room.is_active ? 'æ´»è·ƒ' : 'å·²å…³é—­'}</span><br>
                                åˆ›å»ºæ—¶é—´: ${new Date(room.created_at).toLocaleString('zh-CN')}
                            </div>
                        </div>
                        <div class="room-actions">
                            <button class="btn ${room.is_active ? 'btn-warning' : 'btn-success'}" onclick="toggleRoomStatus('${room.room_id}', ${room.is_active})" style="padding: 6px 12px; font-size: 12px; width: 100%; white-space: nowrap;" title="${room.is_active ? 'ç¦ç”¨æˆ¿é—´' : 'å¼€å¯æˆ¿é—´'}">${room.is_active ? 'ç¦ç”¨' : 'å¼€å¯'}</button>
                            <button class="btn btn-danger" onclick="deleteRoom('${room.room_id}')" style="padding: 6px 12px; font-size: 12px; width: 100%; white-space: nowrap;" title="åˆ é™¤æˆ¿é—´">åˆ é™¤</button>
                            <button class="btn btn-primary" onclick="editRoom('${room.room_id}')" style="padding: 6px 12px; font-size: 12px; width: 100%; white-space: nowrap;" title="ä¿®æ”¹æˆ¿é—´">ä¿®æ”¹</button>
                            <button class="btn btn-primary" onclick="joinRoom('${room.room_id}')" style="padding: 6px 12px; font-size: 12px; width: 100%; white-space: nowrap;" title="åŠ å…¥æˆ¿é—´" ${!room.is_active ? 'disabled' : ''}>åŠ å…¥</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½æˆ¿é—´åˆ—è¡¨å¤±è´¥:', error);
                showMessage('åŠ è½½æˆ¿é—´åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // åŠ å…¥æˆ¿é—´
        async function joinRoom(roomId) {
            try {
                const response = await fetch(`${API_BASE}/rooms/${roomId}/join`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify({
                        display_name: currentUser?.nickname || currentUser?.username
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || 'åŠ å…¥æˆ¿é—´å¤±è´¥');
                }
                
                // è·³è½¬åˆ°Jitsiæˆ¿é—´é¡µé¢ï¼Œä½¿ç”¨åç«¯è¿”å›çš„ room_urlï¼ˆå·²åŒ…å« JWT Tokenï¼‰
                showMessage('æ­£åœ¨è·³è½¬åˆ°æˆ¿é—´...', 'success');
                // ä½¿ç”¨åç«¯è¿”å›çš„å®Œæ•´ room_urlï¼Œè€Œä¸æ˜¯é‡æ–°æ„å»º
                const roomPageUrl = data.room_url || `/room/${data.room_id}?jwt=${encodeURIComponent(data.jitsi_token)}&server=${encodeURIComponent(data.jitsi_server_url)}`;
                setTimeout(() => {
                    window.open(roomPageUrl, '_blank');
                }, 500);
            } catch (error) {
                showMessage('åŠ å…¥æˆ¿é—´å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ˜¾ç¤ºæˆ¿é—´äºŒç»´ç 
        async function showQRCode(roomId) {
            document.getElementById('qrcode-room-id').value = roomId;
            await generateQRCode();
        }
        
        // æŸ¥çœ‹æˆ¿é—´å‚ä¸è€…
        async function viewParticipants(roomId) {
            try {
                const response = await fetch(`${API_BASE}/rooms/${roomId}/participants`, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('è·å–å‚ä¸è€…åˆ—è¡¨å¤±è´¥');
                }
                
                const participants = await response.json();
                
                if (participants.length === 0) {
                    showMessage('æˆ¿é—´æš‚æ— å‚ä¸è€…', 'info');
                    return;
                }
                
                const participantList = participants.map(p => 
                    `${p.user_nickname || p.display_name || 'æœªçŸ¥'}${p.is_moderator ? ' (ä¸»æŒäºº)' : ''}`
                ).join(', ');
                
                showMessage(`å‚ä¸è€… (${participants.length}): ${participantList}`, 'info');
            } catch (error) {
                showMessage('è·å–å‚ä¸è€…åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // åˆ›å»ºæˆ¿é—´
        document.getElementById('create-room-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const roomName = document.getElementById('room-name').value;
            const maxOccupants = parseInt(document.getElementById('max-occupants').value) || 10;
            
            try {
                const response = await apiRequest(`${API_BASE}/rooms/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        room_name: roomName || null,
                        max_occupants: maxOccupants
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || 'åˆ›å»ºæˆ¿é—´å¤±è´¥');
                }
                
                showMessage(`æˆ¿é—´åˆ›å»ºæˆåŠŸï¼æˆ¿é—´ID: ${data.room_id}`, 'success');
                document.getElementById('room-name').value = '';
                document.getElementById('max-occupants').value = '10';
                document.getElementById('qrcode-room-id').value = data.room_id;
                await loadRooms();
                // è‡ªåŠ¨ç”ŸæˆäºŒç»´ç 
                setTimeout(() => generateQRCode(), 500);
            } catch (error) {
                showMessage('åˆ›å»ºæˆ¿é—´å¤±è´¥: ' + error.message, 'error');
            }
        });
        
        // ç”ŸæˆäºŒç»´ç 
        async function generateQRCode() {
            const roomId = document.getElementById('qrcode-room-id').value;
            if (!roomId) {
                showMessage('è¯·è¾“å…¥æˆ¿é—´ID', 'error');
                return;
            }
            
            try {
                console.log('å¼€å§‹ç”ŸæˆäºŒç»´ç ï¼Œæˆ¿é—´ID:', roomId);
                const response = await apiRequest(`${API_BASE}/qrcode/room/${roomId}/image`, {
                    method: 'GET'
                });
                
                if (!response.ok) {
                    // å°è¯•è·å–é”™è¯¯è¯¦æƒ…
                    let errorMessage = 'ç”ŸæˆäºŒç»´ç å¤±è´¥';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.detail || errorMessage;
                    } catch (e) {
                        errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    }
                    console.error('äºŒç»´ç ç”Ÿæˆå¤±è´¥:', errorMessage);
                    throw new Error(errorMessage);
                }
                
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const container = document.getElementById('qrcode-container');
                container.innerHTML = `<img src="${url}" alt="æˆ¿é—´äºŒç»´ç " style="max-width: 100%; height: auto;">`;
                console.log('äºŒç»´ç ç”ŸæˆæˆåŠŸ');
            } catch (error) {
                console.error('ç”ŸæˆäºŒç»´ç å¼‚å¸¸:', error);
                showMessage('ç”ŸæˆäºŒç»´ç å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // åŠ è½½è®¾å¤‡åˆ—è¡¨
        async function loadDevices() {
            try {
                const response = await fetch(`${API_BASE}/devices/`, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥');
                }
                
                const devices = await response.json();
                const devicesList = document.getElementById('devices-list');
                
                if (devices.length === 0) {
                    devicesList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">æš‚æ— è®¾å¤‡</p>';
                    return;
                }
                
                devicesList.innerHTML = devices.map(device => `
                    <div class="room-item">
                        <div class="room-info">
                            <div class="room-name">${device.device_name || 'æœªçŸ¥è®¾å¤‡'}</div>
                            <div class="room-meta">
                                è®¾å¤‡ID: ${device.device_id}<br>
                                æœ€åç™»å½•: ${device.last_login_at ? new Date(device.last_login_at).toLocaleString() : 'ä»æœªç™»å½•'}
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                showMessage('åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // åŠ è½½ç³»ç»Ÿç»Ÿè®¡ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
        async function loadStats() {
            // æ£€æŸ¥ç®¡ç†å‘˜æƒé™ï¼šis_admin ä¸º true æˆ– role ä¸º super_admin
            const isAdmin = currentUser && (
                currentUser.is_admin === true || 
                currentUser.is_admin === 'true' ||
                currentUser.role === 'super_admin'
            );
            
            console.log('loadStats - currentUser:', currentUser);
            console.log('loadStats - isAdmin:', isAdmin);
            
            if (!isAdmin) {
                document.getElementById('stats-container').innerHTML = '<p style="color: #999;">ä»…ç®¡ç†å‘˜å¯è§</p>';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/stats`, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥');
                }
                
                const stats = await response.json();
                const container = document.getElementById('stats-container');
                container.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value">${stats.total_users || 0}</div>
                            <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${stats.total_devices || 0}</div>
                            <div class="stat-label">æ€»è®¾å¤‡æ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${stats.online_users || 0}</div>
                            <div class="stat-label">åœ¨çº¿ç”¨æˆ·</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${stats.total_rooms || 0}</div>
                            <div class="stat-label">æ€»æˆ¿é—´æ•°</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
        async function loadAllUsers() {
            const isAdmin = currentUser && (
                currentUser.is_admin === true || 
                currentUser.is_admin === 'true' ||
                currentUser.role === 'super_admin'
            );
            
            if (!isAdmin) {
                showMessage('æƒé™ä¸è¶³', 'error');
                return;
            }
            
            try {
                const search = document.getElementById('user-search')?.value || '';
                const url = `${API_BASE}/users/?limit=100${search ? '&search=' + encodeURIComponent(search) : ''}`;
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥');
                }
                
                const data = await response.json();
                const usersList = document.getElementById('users-list');
                
                if (!data.users || data.users.length === 0) {
                    usersList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">æš‚æ— ç”¨æˆ·</p>';
                    return;
                }
                
                const roleDisplayMap = {
                    'super_admin': 'è¶…çº§ç®¡ç†å‘˜',
                    'room_owner': 'æˆ¿ä¸»',
                    'user': 'æ™®é€šç”¨æˆ·'
                };
                
                usersList.innerHTML = `
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${data.users.map(user => {
                            const roleText = roleDisplayMap[user.role] || user.role || 'æ™®é€šç”¨æˆ·';
                            const isCurrentUser = currentUser && currentUser.id === user.id;
                            const isSuperAdminUser = user.role === 'super_admin';
                            const userStatus = user.is_disabled ? 'ç¦ç”¨' : 'æ­£å¸¸';
                            const statusClass = user.is_disabled ? 'status-offline' : 'status-online';
                            return `
                            <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <strong>${user.nickname || user.username || user.phone}</strong>
                                        <span class="status-badge ${statusClass}">${userStatus}</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                        æ‰‹æœºå·: ${user.phone} | 
                                        ç”¨æˆ·å: ${user.username || 'æœªè®¾ç½®'} | 
                                        è§’è‰²: ${roleText} |
                                        çŠ¶æ€: <span class="status-badge ${statusClass}">${userStatus}</span> |
                                        ${user.is_online ? '<span style="color: green;">â— åœ¨çº¿</span>' : '<span style="color: #999;">â—‹ ç¦»çº¿</span>'}
                                        ${user.is_admin ? ' | <span style="color: orange;">ç®¡ç†å‘˜</span>' : ''}
                                    </div>
                                </div>
                                ${currentUser && currentUser.role === 'super_admin' ? `
                                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                        ${isCurrentUser || isSuperAdminUser ? `
                                            <button onclick="editUser(${user.id})" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px; white-space: nowrap;">ä¿®æ”¹</button>
                                        ` : `
                                            <button onclick="toggleUserStatus(${user.id}, ${user.is_disabled})" class="btn ${user.is_disabled ? 'btn-success' : 'btn-warning'}" style="padding: 6px 12px; font-size: 12px; white-space: nowrap;" title="${user.is_disabled ? 'å¯ç”¨ç”¨æˆ·' : 'ç¦ç”¨ç”¨æˆ·'}">${user.is_disabled ? 'å¼€å¯' : 'ç¦ç”¨'}</button>
                                            <button onclick="editUser(${user.id})" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px; white-space: nowrap;">ä¿®æ”¹</button>
                                        `}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                        }).join('')}
                    </div>
                    <div style="margin-top: 10px; text-align: center; color: #666; font-size: 12px;">
                        å…± ${data.total || 0} ä¸ªç”¨æˆ·
                    </div>
                `;
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
                showMessage('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // åˆ‡æ¢ç”¨æˆ·çŠ¶æ€ï¼ˆç¦ç”¨/å¯ç”¨ï¼‰
        async function toggleUserStatus(userId, currentStatus) {
            const isSuperAdmin = currentUser && currentUser.role === 'super_admin';
            
            if (!isSuperAdmin) {
                showMessage('æƒé™ä¸è¶³ï¼Œä»…è¶…çº§ç®¡ç†å‘˜å¯ä»¥æ“ä½œç”¨æˆ·çŠ¶æ€', 'error');
                return;
            }
            
            // ä¸èƒ½æ“ä½œè‡ªå·±
            if (currentUser && currentUser.id === userId) {
                showMessage('ä¸èƒ½æ“ä½œè‡ªå·±çš„è´¦æˆ·çŠ¶æ€', 'error');
                return;
            }
            
            const action = currentStatus ? 'å¯ç”¨' : 'ç¦ç”¨';
            if (!confirm(`ç¡®å®šè¦${action}è¿™ä¸ªç”¨æˆ·å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                // ä½¿ç”¨æ›´æ–°åçš„APIï¼Œæ”¯æŒåˆ‡æ¢çŠ¶æ€
                const response = await fetch(`${API_BASE}/admin/users/${userId}/disable?is_disabled=${!currentStatus}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || `${action}ç”¨æˆ·å¤±è´¥`);
                }
                
                showMessage(`ç”¨æˆ·å·²${action}`, 'success');
                await loadAllUsers();
            } catch (error) {
                showMessage(`${action}ç”¨æˆ·å¤±è´¥: ` + error.message, 'error');
            }
        }
        
        // ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯
        async function editUser(userId) {
            const isSuperAdmin = currentUser && currentUser.role === 'super_admin';
            const isCurrentUser = currentUser && currentUser.id === userId;
            
            if (!isSuperAdmin && !isCurrentUser) {
                showMessage('æƒé™ä¸è¶³', 'error');
                return;
            }
            
            try {
                // è·å–ç”¨æˆ·ä¿¡æ¯
                const response = await fetch(`${API_BASE}/users/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
                }
                
                const user = await response.json();
                
                // å¼¹å‡ºä¿®æ”¹å¯¹è¯æ¡†
                const newNickname = prompt('ä¿®æ”¹æ˜µç§°ï¼ˆç•™ç©ºä¸ä¿®æ”¹ï¼‰:', user.nickname || '');
                if (newNickname === null) {
                    return; // ç”¨æˆ·å–æ¶ˆ
                }
                
                const newUsername = prompt('ä¿®æ”¹ç”¨æˆ·åï¼ˆç•™ç©ºä¸ä¿®æ”¹ï¼‰:', user.username || '');
                if (newUsername === null) {
                    return; // ç”¨æˆ·å–æ¶ˆ
                }
                
                // æ„å»ºæ›´æ–°æ•°æ®
                const updateData = {};
                if (newNickname !== '' && newNickname !== user.nickname) {
                    updateData.nickname = newNickname;
                }
                if (newUsername !== '' && newUsername !== user.username) {
                    updateData.username = newUsername;
                }
                
                // è¯¢é—®æ˜¯å¦ä¿®æ”¹å¯†ç 
                const changePassword = confirm('æ˜¯å¦ä¿®æ”¹å¯†ç ï¼Ÿ');
                if (changePassword) {
                    // æ‰€æœ‰ç”¨æˆ·ä¿®æ”¹å¯†ç éƒ½éœ€è¦éªŒè¯æ—§å¯†ç ï¼ˆå®‰å…¨æ€§è¦æ±‚ï¼‰
                    const oldPassword = prompt('è¯·è¾“å…¥æ—§å¯†ç :');
                    if (oldPassword === null || oldPassword === '') {
                        showMessage('ä¿®æ”¹å¯†ç å¿…é¡»æä¾›æ—§å¯†ç ', 'error');
                        return;
                    }
                    
                    const newPassword = prompt('è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰:');
                    if (newPassword === null || newPassword === '') {
                        return; // ç”¨æˆ·å–æ¶ˆ
                    }
                    
                    if (newPassword.length < 6) {
                        showMessage('æ–°å¯†ç é•¿åº¦è‡³å°‘6ä½', 'error');
                        return;
                    }
                    
                    // å¦‚æœæ˜¯å½“å‰ç”¨æˆ·ï¼Œä½¿ç”¨ä¿®æ”¹å¯†ç APIï¼ˆéœ€è¦æ—§å¯†ç ï¼‰
                    if (isCurrentUser) {
                        const passwordResponse = await fetch(`${API_BASE}/users/me/change-password`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${getToken()}`
                            },
                            body: JSON.stringify({
                                old_password: oldPassword,
                                new_password: newPassword
                            })
                        });
                        
                        if (!passwordResponse.ok) {
                            const error = await passwordResponse.json();
                            throw new Error(error.detail || 'ä¿®æ”¹å¯†ç å¤±è´¥');
                        }
                    } else {
                        // ç®¡ç†å‘˜ä¿®æ”¹å…¶ä»–ç”¨æˆ·å¯†ç æ—¶ï¼Œä¹Ÿéœ€è¦æä¾›æ—§å¯†ç ï¼ˆå®‰å…¨æ€§è¦æ±‚ï¼‰
                        updateData.password = newPassword;
                        updateData.old_password = oldPassword;
                    }
                }
                
                // å¦‚æœæ²¡æœ‰éœ€è¦æ›´æ–°çš„å†…å®¹
                if (Object.keys(updateData).length === 0) {
                    showMessage('æ²¡æœ‰éœ€è¦ä¿®æ”¹çš„å†…å®¹', 'info');
                    return;
                }
                
                // å‘é€æ›´æ–°è¯·æ±‚
                const updateResponse = await fetch(`${API_BASE}/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify(updateData)
                });
                
                if (!updateResponse.ok) {
                    const error = await updateResponse.json();
                    throw new Error(error.detail || 'ä¿®æ”¹ç”¨æˆ·å¤±è´¥');
                }
                
                showMessage('ç”¨æˆ·ä¿®æ”¹æˆåŠŸ', 'success');
                await loadAllUsers();
                
                // å¦‚æœä¿®æ”¹çš„æ˜¯å½“å‰ç”¨æˆ·ï¼Œåˆ·æ–°ç”¨æˆ·ä¿¡æ¯
                if (isCurrentUser) {
                    await loadUserInfo();
                }
            } catch (error) {
                showMessage('ä¿®æ”¹ç”¨æˆ·å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ˜¾ç¤ºåˆ›å»ºæˆ¿ä¸»è¡¨å•ï¼ˆä»…è¶…çº§ç®¡ç†å‘˜ï¼‰
        function showCreateRoomOwnerForm() {
            const form = prompt('åˆ›å»ºæˆ¿ä¸»\næ ¼å¼ï¼šæ‰‹æœºå·,ç”¨æˆ·å,å¯†ç ,æ˜µç§°,æœ€å¤§æˆ¿é—´æ•°(å¯é€‰)\nä¾‹å¦‚ï¼š13900000001,owner1,password123,æˆ¿ä¸»1,10');
            if (!form) return;
            
            const parts = form.split(',');
            if (parts.length < 4) {
                showMessage('æ ¼å¼é”™è¯¯', 'error');
                return;
            }
            
            const [phone, username, password, nickname, maxRooms] = parts;
            
            createRoomOwner({
                phone: phone.trim(),
                username: username.trim(),
                password: password.trim(),
                nickname: nickname.trim(),
                max_rooms: maxRooms ? parseInt(maxRooms.trim()) : null,
                default_max_occupants: 3
            });
        }
        
        // åˆ›å»ºæˆ¿ä¸»
        async function createRoomOwner(data) {
            try {
                const response = await fetch(`${API_BASE}/admin/room-owners`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'åˆ›å»ºæˆ¿ä¸»å¤±è´¥');
                }
                
                showMessage('æˆ¿ä¸»åˆ›å»ºæˆåŠŸ', 'success');
                await loadAllUsers();
            } catch (error) {
                showMessage('åˆ›å»ºæˆ¿ä¸»å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // åŠ è½½é‚€è¯·ç åˆ—è¡¨ï¼ˆä»…è¶…çº§ç®¡ç†å‘˜ï¼‰
        async function loadInvitations() {
            const isSuperAdmin = currentUser && currentUser.role === 'super_admin';
            
            if (!isSuperAdmin) {
                showMessage('æƒé™ä¸è¶³', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/invitations/?limit=50`, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                
                if (!response.ok) {
                    let errorMessage = 'è·å–é‚€è¯·ç åˆ—è¡¨å¤±è´¥';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.detail || errorMessage;
                    } catch (e) {
                        errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                const invitationsList = document.getElementById('invitations-list');
                
                // APIè¿”å›çš„å­—æ®µæ˜¯ codes è€Œä¸æ˜¯ invitations
                const codes = data.codes || data.invitations || [];
                
                if (!codes || codes.length === 0) {
                    invitationsList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">æš‚æ— é‚€è¯·ç </p>';
                    return;
                }
                
                invitationsList.innerHTML = `
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${codes.map(inv => `
                            <div style="padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: flex-start; gap: 10px;">
                                <div style="flex: 1;">
                                    <div style="margin-bottom: 5px;"><strong style="font-size: 14px;">${inv.code}</strong></div>
                                    <div style="font-size: 12px; color: #666; line-height: 1.6;">
                                        ä½¿ç”¨æ¬¡æ•°: ${inv.used_count}/${inv.max_uses} |
                                        ${inv.is_active ? '<span style="color: green;">æœ‰æ•ˆ</span>' : '<span style="color: red;">æ— æ•ˆ</span>'} |
                                        ${inv.is_revoked ? '<span style="color: red;">å·²æ’¤å›</span>' : ''}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px; flex-shrink: 0;">
                                    <button onclick="revokeInvitation(${inv.id})" class="btn btn-warning" style="padding: 6px 12px; font-size: 12px; white-space: nowrap;">æ’¤å›</button>
                                    <button onclick="deleteInvitation(${inv.id}, '${inv.code}')" class="btn btn-danger" style="padding: 6px 12px; font-size: 12px; white-space: nowrap; font-weight: 500;">åˆ é™¤</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('åŠ è½½é‚€è¯·ç åˆ—è¡¨å¤±è´¥:', error);
                showMessage('åŠ è½½é‚€è¯·ç åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ˜¾ç¤ºåˆ›å»ºé‚€è¯·ç è¡¨å•
        function showCreateInvitationForm() {
            const code = prompt('åˆ›å»ºé‚€è¯·ç \nè¾“å…¥é‚€è¯·ç ï¼ˆç•™ç©ºè‡ªåŠ¨ç”Ÿæˆï¼‰:');
            if (code === null) return;
            
            const maxUses = prompt('æœ€å¤§ä½¿ç”¨æ¬¡æ•°ï¼ˆé»˜è®¤1ï¼‰:') || '1';
            
            createInvitation({
                code: code.trim() || null,
                max_uses: parseInt(maxUses) || 1
            });
        }
        
        // åˆ›å»ºé‚€è¯·ç 
        async function createInvitation(data) {
            try {
                const response = await fetch(`${API_BASE}/invitations/create`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'åˆ›å»ºé‚€è¯·ç å¤±è´¥');
                }
                
                showMessage('é‚€è¯·ç åˆ›å»ºæˆåŠŸ', 'success');
                await loadInvitations();
            } catch (error) {
                showMessage('åˆ›å»ºé‚€è¯·ç å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ’¤å›é‚€è¯·ç 
        async function revokeInvitation(codeId) {
            if (!confirm('ç¡®å®šè¦æ’¤å›è¿™ä¸ªé‚€è¯·ç å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/invitations/${codeId}/revoke`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('æ’¤å›é‚€è¯·ç å¤±è´¥');
                }
                
                showMessage('é‚€è¯·ç å·²æ’¤å›', 'success');
                await loadInvitations();
            } catch (error) {
                showMessage('æ’¤å›é‚€è¯·ç å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // åˆ é™¤é‚€è¯·ç 
        async function deleteInvitation(codeId, code) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é‚€è¯·ç  "${code}" å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/invitations/${codeId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'åˆ é™¤é‚€è¯·ç å¤±è´¥' }));
                    throw new Error(errorData.detail || 'åˆ é™¤é‚€è¯·ç å¤±è´¥');
                }
                
                showMessage('é‚€è¯·ç å·²åˆ é™¤', 'success');
                await loadInvitations();
            } catch (error) {
                showMessage('åˆ é™¤é‚€è¯·ç å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // åŠ è½½äºŒç»´ç é…ç½®ï¼ˆä»…è¶…çº§ç®¡ç†å‘˜ï¼‰
        async function loadQRCodeConfigs() {
            const isSuperAdmin = currentUser && currentUser.role === 'super_admin';
            
            if (!isSuperAdmin) {
                showMessage('æƒé™ä¸è¶³ï¼Œä»…è¶…çº§ç®¡ç†å‘˜å¯ä»¥è®¿é—®', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/system-configs`, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('è·å–é…ç½®å¤±è´¥');
                }
                
                const data = await response.json();
                const configsList = document.getElementById('qrcode-configs-list');
                
                // ç­›é€‰äºŒç»´ç ç›¸å…³é…ç½®
                const qrcodeConfigs = (data.configs || []).filter(c => 
                    c.config_key.startsWith('qrcode.')
                );
                
                if (qrcodeConfigs.length === 0) {
                    configsList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">æš‚æ— é…ç½®ï¼Œè¯·è¿è¡Œåˆå§‹åŒ–è„šæœ¬</p>';
                    return;
                }
                
                // é…ç½®é¡¹å‹å¥½åç§°æ˜ å°„
                const configDisplayNames = {
                    'qrcode.max_scans': 'æœ€å¤§æ‰«ç æ¬¡æ•°',
                    'qrcode.encrypted_enabled': 'åŠ å¯†æ¨¡å¼',
                    'qrcode.plain_enabled': 'æ˜æ–‡æ¨¡å¼',
                    'qrcode.encrypted_max_scans': 'åŠ å¯†æ¨¡å¼æœ€å¤§æ‰«ç æ¬¡æ•°',
                    'qrcode.plain_max_scans': 'æ˜æ–‡æ¨¡å¼æœ€å¤§æ‰«ç æ¬¡æ•°'
                };
                
                // è¿‡æ»¤æ‰å·²åºŸå¼ƒçš„æ—§é…ç½®é¡¹ï¼ˆä¿ç•™ç»Ÿä¸€çš„æ–°é…ç½®é¡¹ï¼‰
                const filteredConfigs = qrcodeConfigs.filter(c => 
                    c.config_key !== 'qrcode.plain_max_scans' && 
                    c.config_key !== 'qrcode.encrypted_max_scans'
                );
                
                configsList.innerHTML = `
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${filteredConfigs.map(config => {
                            const isBoolean = config.config_key.includes('_enabled');
                            const isNumber = config.config_key === 'qrcode.max_scans' || config.config_key.includes('_max_scans');
                            const currentValue = config.config_value || '';
                            const displayName = configDisplayNames[config.config_key] || config.config_key;
                            return `
                            <div style="padding: 8px; border-bottom: 1px solid #ddd; font-size: 12px;">
                                <div style="margin-bottom: 6px;">
                                    <strong style="font-size: 12px; color: #333;">${displayName}</strong>
                                    ${config.description ? `<div style="font-size: 11px; color: #666; margin-top: 2px;">${config.description}</div>` : ''}
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 6px;">
                                    ${isBoolean ? `
                                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                            <input type="checkbox" ${currentValue.toLowerCase() === 'true' ? 'checked' : ''} 
                                                onchange="updateQRCodeConfig('${config.config_key}', this.checked ? 'true' : 'false')"
                                                style="width: 16px; height: 16px; cursor: pointer;">
                                            <span style="font-size: 11px;">${currentValue.toLowerCase() === 'true' ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}</span>
                                        </label>
                                    ` : isNumber ? `
                                        <div style="display: flex; gap: 4px; align-items: center; flex-wrap: nowrap;">
                                            <input type="number" id="config-${config.config_key}" value="${currentValue}" 
                                                min="0" style="padding: 4px 4px; border: 1px solid #ddd; border-radius: 4px; width: 45px; font-size: 11px; flex-shrink: 0;">
                                            <button onclick="updateQRCodeConfig('${config.config_key}', document.getElementById('config-${config.config_key}').value)" 
                                                class="btn btn-primary" style="padding: 4px 8px; font-size: 11px; white-space: nowrap; flex-shrink: 0;">ä¿å­˜</button>
                                        </div>
                                        <span style="font-size: 10px; color: #666; display: block; margin-top: 2px;">ï¼ˆ0è¡¨ç¤ºä¸é™åˆ¶ï¼‰</span>
                                    ` : `
                                        <div style="display: flex; gap: 6px; align-items: center;">
                                            <input type="text" id="config-${config.config_key}" value="${currentValue}" 
                                                style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; flex: 1; font-size: 11px;">
                                            <button onclick="updateQRCodeConfig('${config.config_key}', document.getElementById('config-${config.config_key}').value)" 
                                                class="btn btn-primary" style="padding: 4px 8px; font-size: 11px; white-space: nowrap;">ä¿å­˜</button>
                                        </div>
                                    `}
                                </div>
                            </div>
                        `;
                        }).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('åŠ è½½äºŒç»´ç é…ç½®å¤±è´¥:', error);
                showMessage('åŠ è½½äºŒç»´ç é…ç½®å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ›´æ–°äºŒç»´ç é…ç½®
        async function updateQRCodeConfig(configKey, configValue) {
            const isSuperAdmin = currentUser && currentUser.role === 'super_admin';
            
            if (!isSuperAdmin) {
                showMessage('æƒé™ä¸è¶³ï¼Œä»…è¶…çº§ç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹é…ç½®', 'error');
                return;
            }
            
            try {
                // äº’æ–¥é€»è¾‘ï¼šå¦‚æœå¯ç”¨åŠ å¯†äºŒç»´ç ï¼Œåˆ™ç¦ç”¨æœªåŠ å¯†äºŒç»´ç ï¼›åä¹‹äº¦ç„¶
                if (configKey === 'qrcode.encrypted_enabled' && configValue === 'true') {
                    // å¯ç”¨åŠ å¯†äºŒç»´ç æ—¶ï¼Œç¦ç”¨æœªåŠ å¯†äºŒç»´ç 
                    await fetch(`${API_BASE}/admin/system-configs/qrcode.plain_enabled`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${getToken()}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            config_value: 'false'
                        })
                    });
                } else if (configKey === 'qrcode.plain_enabled' && configValue === 'true') {
                    // å¯ç”¨æœªåŠ å¯†äºŒç»´ç æ—¶ï¼Œç¦ç”¨åŠ å¯†äºŒç»´ç 
                    await fetch(`${API_BASE}/admin/system-configs/qrcode.encrypted_enabled`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${getToken()}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            config_value: 'false'
                        })
                    });
                }
                
                const response = await fetch(`${API_BASE}/admin/system-configs/${encodeURIComponent(configKey)}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        config_value: configValue
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json().catch(() => ({ detail: 'æ›´æ–°é…ç½®å¤±è´¥' }));
                    throw new Error(error.detail || 'æ›´æ–°é…ç½®å¤±è´¥');
                }
                
                showMessage('é…ç½®å·²æ›´æ–°', 'success');
                await loadQRCodeConfigs();
            } catch (error) {
                showMessage('æ›´æ–°é…ç½®å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // åˆ·æ–°æ‰€æœ‰æ•°æ®
        async function refreshData() {
            await loadUserInfo();
            await loadRooms();
            await loadDevices();
            await loadStats();
            if (currentUser && (currentUser.is_admin || currentUser.role === 'super_admin')) {
                await loadAllUsers();
            }
            if (currentUser && currentUser.role === 'super_admin') {
                await loadInvitations();
            }
            showMessage('æ•°æ®å·²åˆ·æ–°', 'success');
        }
        
        // åˆ‡æ¢æˆ¿é—´çŠ¶æ€ï¼ˆç¦ç”¨/å¼€å¯ï¼‰
        async function toggleRoomStatus(roomId, currentStatus) {
            const isSuperAdmin = currentUser && currentUser.role === 'super_admin';
            
            if (!isSuperAdmin) {
                showMessage('æƒé™ä¸è¶³ï¼Œä»…è¶…çº§ç®¡ç†å‘˜å¯ä»¥æ“ä½œæˆ¿é—´çŠ¶æ€', 'error');
                return;
            }
            
            const action = currentStatus ? 'ç¦ç”¨' : 'å¼€å¯';
            if (!confirm(`ç¡®å®šè¦${action}è¿™ä¸ªæˆ¿é—´å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                // ä½¿ç”¨æ›´æ–°æˆ¿é—´APIæ¥åˆ‡æ¢çŠ¶æ€
                const response = await fetch(`${API_BASE}/rooms/${roomId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify({
                        is_active: !currentStatus
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || `${action}æˆ¿é—´å¤±è´¥`);
                }
                
                showMessage(`æˆ¿é—´å·²${action}`, 'success');
                await loadRooms();
            } catch (error) {
                showMessage(`${action}æˆ¿é—´å¤±è´¥: ` + error.message, 'error');
            }
        }
        
        // åˆ é™¤æˆ¿é—´
        async function deleteRoom(roomId) {
            const isSuperAdmin = currentUser && currentUser.role === 'super_admin';
            
            if (!isSuperAdmin) {
                showMessage('æƒé™ä¸è¶³ï¼Œä»…è¶…çº§ç®¡ç†å‘˜å¯ä»¥åˆ é™¤æˆ¿é—´', 'error');
                return;
            }
            
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæˆ¿é—´å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/rooms/${roomId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json().catch(() => ({ detail: 'åˆ é™¤æˆ¿é—´å¤±è´¥' }));
                    throw new Error(error.detail || 'åˆ é™¤æˆ¿é—´å¤±è´¥');
                }
                
                showMessage('æˆ¿é—´å·²åˆ é™¤', 'success');
                await loadRooms();
            } catch (error) {
                showMessage('åˆ é™¤æˆ¿é—´å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // ä¿®æ”¹æˆ¿é—´
        async function editRoom(roomId) {
            try {
                // è·å–æˆ¿é—´ä¿¡æ¯
                const response = await fetch(`${API_BASE}/rooms/${roomId}`, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('è·å–æˆ¿é—´ä¿¡æ¯å¤±è´¥');
                }
                
                const room = await response.json();
                
                // å¼¹å‡ºä¿®æ”¹å¯¹è¯æ¡†
                const newRoomName = prompt('ä¿®æ”¹æˆ¿é—´åç§°ï¼ˆç•™ç©ºä¸ä¿®æ”¹ï¼‰:', room.room_name || '');
                if (newRoomName === null) {
                    return; // ç”¨æˆ·å–æ¶ˆ
                }
                
                const newMaxOccupants = prompt('ä¿®æ”¹æœ€å¤§äººæ•°ï¼ˆç•™ç©ºä¸ä¿®æ”¹ï¼Œå½“å‰: ' + room.max_occupants + 'ï¼‰:', room.max_occupants);
                if (newMaxOccupants === null) {
                    return; // ç”¨æˆ·å–æ¶ˆ
                }
                
                // æ„å»ºæ›´æ–°æ•°æ®
                const updateData = {};
                if (newRoomName !== '' && newRoomName !== room.room_name) {
                    updateData.room_name = newRoomName;
                }
                if (newMaxOccupants !== '' && parseInt(newMaxOccupants) !== room.max_occupants) {
                    updateData.max_occupants = parseInt(newMaxOccupants);
                }
                
                // å¦‚æœæ²¡æœ‰éœ€è¦æ›´æ–°çš„å†…å®¹
                if (Object.keys(updateData).length === 0) {
                    showMessage('æ²¡æœ‰éœ€è¦ä¿®æ”¹çš„å†…å®¹', 'info');
                    return;
                }
                
                // å‘é€æ›´æ–°è¯·æ±‚
                const updateResponse = await fetch(`${API_BASE}/rooms/${roomId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify(updateData)
                });
                
                if (!updateResponse.ok) {
                    const error = await updateResponse.json();
                    throw new Error(error.detail || 'ä¿®æ”¹æˆ¿é—´å¤±è´¥');
                }
                
                showMessage('æˆ¿é—´ä¿®æ”¹æˆåŠŸ', 'success');
                await loadRooms();
                
                // å¦‚æœä¿®æ”¹äº†æˆ¿é—´åç§°æˆ–æœ€å¤§äººæ•°ï¼Œæ›´æ–°è¡¨å•
                if (updateData.room_name) {
                    document.getElementById('room-name').value = updateData.room_name;
                }
                if (updateData.max_occupants) {
                    document.getElementById('max-occupants').value = updateData.max_occupants;
                }
                document.getElementById('qrcode-room-id').value = room.room_id;
            } catch (error) {
                showMessage('ä¿®æ”¹æˆ¿é—´å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // é€€å‡ºç™»å½•
        async function logout() {
            try {
                await fetch(`${API_BASE}/auth/logout`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
            } catch (error) {
                console.error('é€€å‡ºå¤±è´¥:', error);
            }
            
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            window.location.href = '/login';
        }
        
        // åˆå§‹åŒ–Socket.ioè¿æ¥
        function initSocket() {
            try {
                const socketIOUrl = window.location.origin.replace(/^http/, 'ws') + '/socket.io/';
                // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦æ ¹æ®å®é™…çš„Socket.ioå®¢æˆ·ç«¯åº“æ¥å®ç°
                // æš‚æ—¶åªæ˜¾ç¤ºè¿æ¥çŠ¶æ€
                document.getElementById('connection-status').textContent = 'å·²è¿æ¥';
                document.getElementById('connection-status').className = 'status-badge status-online';
            } catch (error) {
                console.error('Socketè¿æ¥å¤±è´¥:', error);
                document.getElementById('connection-status').textContent = 'æœªè¿æ¥';
                document.getElementById('connection-status').className = 'status-badge status-offline';
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', async () => {
            // åˆå§‹åŒ–ç§»åŠ¨ç«¯èœå•æŒ‰é’®
            updateMobileMenuButton();
            const token = getToken();
            if (!token) {
                showMessage('æœªç™»å½•ï¼Œæ­£åœ¨è·³è½¬åˆ°ç™»å½•é¡µé¢...', 'info');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 1500);
                return;
            }
            
            // ä¾æ¬¡åŠ è½½æ•°æ®ï¼Œå³ä½¿æŸä¸ªå¤±è´¥ä¹Ÿç»§ç»­åŠ è½½å…¶ä»–æ•°æ®
            try {
                await loadUserInfo();
            } catch (e) {
                console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', e);
            }
            
            try {
                await loadRooms();
            } catch (e) {
                console.error('åŠ è½½æˆ¿é—´åˆ—è¡¨å¤±è´¥:', e);
            }
            
            try {
                await loadDevices();
            } catch (e) {
                console.error('åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥:', e);
            }
            
            try {
                await loadStats();
            } catch (e) {
                console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', e);
            }
            
            // å¦‚æœæ˜¯ç®¡ç†å‘˜ï¼ŒåŠ è½½ç”¨æˆ·åˆ—è¡¨
            if (currentUser && (currentUser.is_admin || currentUser.role === 'super_admin')) {
                try {
                    await loadAllUsers();
                } catch (e) {
                    console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', e);
                }
            }
            
            // å¦‚æœæ˜¯è¶…çº§ç®¡ç†å‘˜ï¼ŒåŠ è½½é‚€è¯·ç åˆ—è¡¨
            if (currentUser && currentUser.role === 'super_admin') {
                try {
                    await loadInvitations();
                } catch (e) {
                    console.error('åŠ è½½é‚€è¯·ç åˆ—è¡¨å¤±è´¥:', e);
                }
            }
            
            
            // æ·»åŠ æœç´¢æ¡†ç›‘å¬å™¨
            const userSearchInput = document.getElementById('user-search');
            if (userSearchInput) {
                let searchTimeout;
                userSearchInput.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        if (currentUser && (currentUser.is_admin || currentUser.role === 'super_admin')) {
                            loadAllUsers();
                        }
                    }, 500); // å»¶è¿Ÿ500msæ‰§è¡Œæœç´¢
                });
            }
            
            try {
                initSocket();
            } catch (e) {
                console.error('åˆå§‹åŒ–Socketå¤±è´¥:', e);
            }
        });
    </script>
</body>
</html>
