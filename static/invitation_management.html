<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>é‚€è¯·ç ç®¡ç† - MOP</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico?v=20260112">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif; background: #f5f7fa; min-height: 100vh; display: flex; }
        .sidebar {
            width: 147px;
            min-width: 147px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.08);
        }
        .sidebar-title { padding: 0 12px 12px; font-size: 12px; color: rgba(255,255,255,0.7); }
        .sidebar-menu-item {
            display: flex; align-items: center; gap: 8px;
            padding: 10px 12px; cursor: pointer; transition: background 0.2s;
            color: white; text-decoration: none; font-size: 13px;
        }
        .sidebar-menu-item:hover { background: rgba(255,255,255,0.15); }
        .sidebar-menu-item.active { background: rgba(255,255,255,0.25); font-weight: 600; }
        .sidebar-menu-item-icon { font-size: 1em; }
        .main { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        .main-header { background: white; padding: 16px 20px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
        .main-title { font-size: 1.3em; color: #333; }
        .main-body { flex: 1; padding: 20px; overflow-x: auto; }
        .message { padding: 12px 20px; border-radius: 6px; margin-bottom: 16px; display: none; }
        .message-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .card { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); padding: 20px; }
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 14px; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal { background: white; border-radius: 12px; padding: 24px; width: 90%; max-width: 400px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .modal h3 { margin-bottom: 16px; color: #333; }
        .modal .form-group { margin-bottom: 14px; }
        .modal label { display: block; margin-bottom: 6px; font-size: 14px; color: #555; }
        .modal input { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .modal-actions { margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end; }
        .modal-actions .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 14px; }
        .btn-cancel { background: #e0e0e0; color: #333; }
        .btn-confirm { background: #667eea; color: white; }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-title">å·¦ä¾§èœå•</div>
        <a href="/static/dashboard.html" class="sidebar-menu-item"><span class="sidebar-menu-item-icon">ğŸ‘¤</span>ç”¨æˆ·ä¿¡æ¯</a>
        <a href="#" class="sidebar-menu-item" id="menu-change-pwd"><span class="sidebar-menu-item-icon">ğŸ”‘</span>ä¿®æ”¹å¯†ç </a>
        <a href="/static/devices.html" class="sidebar-menu-item"><span class="sidebar-menu-item-icon">ğŸ“±</span>è®¾å¤‡ç®¡ç†</a>
        <a href="/static/user_management.html" class="sidebar-menu-item"><span class="sidebar-menu-item-icon">ğŸ‘¥</span>ç”¨æˆ·ç®¡ç†</a>
        <a href="/static/invitation_management.html" class="sidebar-menu-item active"><span class="sidebar-menu-item-icon">ğŸ«</span>é‚€è¯·ç ç®¡ç†</a>
        <a href="/static/qrcode_settings.html" class="sidebar-menu-item"><span class="sidebar-menu-item-icon">âš™ï¸</span>æ‰«ç é…ç½®</a>
    </aside>
    <div class="main">
        <header class="main-header"><h1 class="main-title">é‚€è¯·ç ç®¡ç†</h1></header>
        <div class="main-body">
            <div id="messages"></div>
            <div class="card">
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="showCreateInvitationForm()">åˆ›å»ºé‚€è¯·ç </button>
                    <button class="btn btn-primary" onclick="loadInvitations()" style="margin-left: 10px;">åˆ·æ–°åˆ—è¡¨</button>
                </div>
                <div id="invitations-list"><p style="color:#999;text-align:center;padding:20px">ç‚¹å‡»ã€Œåˆ·æ–°åˆ—è¡¨ã€åŠ è½½</p></div>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="modal-change-pwd">
        <div class="modal">
            <h3>ä¿®æ”¹å¯†ç </h3>
            <div class="form-group"><label>æ—§å¯†ç </label><input type="password" id="pwd-old" placeholder="è¯·è¾“å…¥æ—§å¯†ç "></div>
            <div class="form-group"><label>æ–°å¯†ç </label><input type="password" id="pwd-new" placeholder="è‡³å°‘6ä½"></div>
            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="closeChangePwdModal()">å–æ¶ˆ</button>
                <button class="btn btn-confirm" onclick="submitChangePwd()">ç¡®å®š</button>
            </div>
        </div>
    </div>
    <script>
        function getApiBase() {
            const h = window.location.hostname, p = window.location.protocol;
            if (h === 'www.chat5202ol.xyz' || h === 'chat5202ol.xyz' || h === 'app.chat5202ol.xyz') return 'https://api.chat5202ol.xyz/api/v1';
            if (h === 'api.chat5202ol.xyz') return p + '//' + h + '/api/v1';
            return '/api/v1';
        }
        const API_BASE = getApiBase();
        let currentUser = null;
        function getToken() { return localStorage.getItem('access_token'); }
        async function apiRequest(url, options) {
            const token = getToken();
            if (!token) { showMessage('æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•', 'error'); setTimeout(() => { window.location.href = '/login'; }, 2000); throw new Error('æœªç™»å½•'); }
            options.headers = options.headers || {};
            options.headers['Authorization'] = 'Bearer ' + token;
            if (options.body && !options.headers['Content-Type']) options.headers['Content-Type'] = 'application/json';
            options.credentials = options.credentials || 'include';
            const res = await fetch(url, options);
            if (res.status === 401) { localStorage.removeItem('access_token'); localStorage.removeItem('refresh_token'); showMessage('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 'error'); setTimeout(() => { window.location.href = '/login'; }, 2000); throw new Error('ç™»å½•å·²è¿‡æœŸ'); }
            return res;
        }
        function showMessage(text, type) {
            const el = document.getElementById('messages');
            const m = document.createElement('div');
            m.className = 'message message-' + type;
            m.textContent = text;
            m.style.display = 'block';
            el.appendChild(m);
            setTimeout(() => { m.style.opacity = '0'; m.style.transition = 'opacity 0.3s'; setTimeout(() => m.remove(), 300); }, 5000);
        }
        async function loadUserInfo() {
            try {
                const token = getToken();
                if (!token) { showMessage('æœªç™»å½•', 'error'); setTimeout(() => { window.location.href = '/login'; }, 2000); return; }
                const res = await fetch(API_BASE + '/auth/me', { headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }, credentials: 'include' });
                if (!res.ok) { if (res.status === 401) { localStorage.removeItem('access_token'); showMessage('ç™»å½•å·²è¿‡æœŸ', 'error'); setTimeout(() => { window.location.href = '/login'; }, 2000); return; } throw new Error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥'); }
                currentUser = await res.json();
                const isSuper = currentUser && currentUser.role === 'super_admin';
                if (!isSuper) { showMessage('ä»…è¶…çº§ç®¡ç†å‘˜å¯è®¿é—®', 'error'); setTimeout(() => { window.location.href = '/static/dashboard.html'; }, 1500); return; }
            } catch (e) { console.error(e); showMessage('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥', 'error'); }
        }
        async function loadInvitations() {
            if (!(currentUser && currentUser.role === 'super_admin')) { showMessage('æƒé™ä¸è¶³', 'error'); return; }
            try {
                const res = await apiRequest(API_BASE + '/invitations/?limit=50', { method: 'GET' });
                if (!res.ok) throw new Error('è·å–é‚€è¯·ç åˆ—è¡¨å¤±è´¥');
                const data = await res.json();
                const codes = data.codes || data.invitations || [];
                const list = document.getElementById('invitations-list');
                if (!codes.length) { list.innerHTML = '<p style="color:#999;text-align:center;padding:20px">æš‚æ— é‚€è¯·ç </p>'; return; }
                list.innerHTML = '<div style="max-height:400px;overflow-y:auto">' + codes.map(inv => {
                    const code = (inv.code || '').replace(/"/g, '&quot;').replace(/</g, '&lt;');
                    return '<div style="padding:12px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:flex-start;gap:10px" data-inv-id="' + inv.id + '" data-inv-code="' + code + '"><div style="flex:1"><div style="margin-bottom:5px"><strong>' + (inv.code || '') + '</strong></div><div style="font-size:12px;color:#666">ä½¿ç”¨ ' + inv.used_count + '/' + inv.max_uses + ' | ' + (inv.is_active ? 'æœ‰æ•ˆ' : 'æ— æ•ˆ') + (inv.is_revoked ? ' | å·²æ’¤å›' : '') + '</div></div><div style="display:flex;gap:8px"><button class="btn btn-warning" style="padding:6px 12px;font-size:12px" onclick="revokeInvitation(' + inv.id + ')">æ’¤å›</button><button class="btn btn-danger" style="padding:6px 12px;font-size:12px" onclick="deleteInvitation(' + inv.id + ')">åˆ é™¤</button></div></div>';
                }).join('') + '</div>';
            } catch (e) {
                console.error('åŠ è½½é‚€è¯·ç å¤±è´¥', e);
                showMessage('åŠ è½½å¤±è´¥: ' + e.message, 'error');
                document.getElementById('invitations-list').innerHTML = '<p style="color:#e74c3c;text-align:center;padding:20px">åŠ è½½å¤±è´¥ï¼Œ<a href="javascript:loadInvitations()">é‡è¯•</a></p>';
            }
        }
        function showCreateInvitationForm() {
            const code = prompt('åˆ›å»ºé‚€è¯·ç \nè¾“å…¥é‚€è¯·ç ï¼ˆç•™ç©ºè‡ªåŠ¨ç”Ÿæˆï¼‰:');
            if (code === null) return;
            const maxUses = prompt('æœ€å¤§ä½¿ç”¨æ¬¡æ•°ï¼ˆé»˜è®¤1ï¼‰:') || '1';
            createInvitation({ code: code.trim() || null, max_uses: parseInt(maxUses) || 1 });
        }
        async function createInvitation(data) {
            try {
                const res = await fetch(API_BASE + '/invitations/create', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + getToken(), 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!res.ok) { const err = await res.json(); throw new Error(err.detail || 'åˆ›å»ºå¤±è´¥'); }
                showMessage('é‚€è¯·ç åˆ›å»ºæˆåŠŸ', 'success');
                loadInvitations();
            } catch (e) { showMessage(e.message || 'åˆ›å»ºå¤±è´¥', 'error'); }
        }
        async function revokeInvitation(id) {
            if (!confirm('ç¡®å®šè¦æ’¤å›è¯¥é‚€è¯·ç å—ï¼Ÿ')) return;
            try {
                const res = await fetch(API_BASE + '/invitations/' + id + '/revoke', { method: 'POST', headers: { 'Authorization': 'Bearer ' + getToken() } });
                if (!res.ok) throw new Error('æ’¤å›å¤±è´¥');
                showMessage('å·²æ’¤å›', 'success');
                loadInvitations();
            } catch (e) { showMessage(e.message || 'æ’¤å›å¤±è´¥', 'error'); }
        }
        async function deleteInvitation(id) {
            const row = document.querySelector('[data-inv-id="' + String(id) + '"]');
            const code = row ? (row.getAttribute('data-inv-code') || '').replace(/&quot;/g, '"') : ('#' + id);
            if (!confirm('ç¡®å®šè¦åˆ é™¤é‚€è¯·ç  "' + code + '" å—ï¼Ÿä¸å¯æ¢å¤ï¼')) return;
            try {
                const res = await fetch(API_BASE + '/invitations/' + id, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + getToken() } });
                if (!res.ok) { const err = await res.json().catch(() => ({})); throw new Error(err.detail || 'åˆ é™¤å¤±è´¥'); }
                showMessage('å·²åˆ é™¤', 'success');
                loadInvitations();
            } catch (e) { showMessage(e.message || 'åˆ é™¤å¤±è´¥', 'error'); }
        }
        document.getElementById('menu-change-pwd').addEventListener('click', function(e) { e.preventDefault(); document.getElementById('modal-change-pwd').classList.add('show'); document.getElementById('pwd-old').value = ''; document.getElementById('pwd-new').value = ''; });
        function closeChangePwdModal() { document.getElementById('modal-change-pwd').classList.remove('show'); }
        async function submitChangePwd() {
            const oldP = document.getElementById('pwd-old').value, newP = document.getElementById('pwd-new').value;
            if (!oldP || !newP) { showMessage('è¯·å¡«å†™æ—§å¯†ç å’Œæ–°å¯†ç ', 'error'); return; }
            if (newP.length < 6) { showMessage('æ–°å¯†ç è‡³å°‘6ä½', 'error'); return; }
            try {
                const res = await apiRequest(API_BASE + '/users/me/change-password', { method: 'POST', body: JSON.stringify({ old_password: oldP, new_password: newP }) });
                if (!res.ok) { const err = await res.json().catch(() => ({})); throw new Error(err.detail || 'ä¿®æ”¹å¤±è´¥'); }
                showMessage('å¯†ç å·²ä¿®æ”¹', 'success');
                closeChangePwdModal();
            } catch (e) { showMessage('ä¿®æ”¹å¯†ç å¤±è´¥: ' + (e.message || e), 'error'); }
        }
        window.addEventListener('DOMContentLoaded', async () => {
            if (!getToken()) { showMessage('æœªç™»å½•ï¼Œæ­£åœ¨è·³è½¬â€¦', 'info'); setTimeout(() => { window.location.href = '/login'; }, 1500); return; }
            await loadUserInfo();
            loadInvitations();
        });
    </script>
</body>
</html>
