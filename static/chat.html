<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>聊天 - MOP</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="/static/chat-styles.css">
</head>
<body>
    <script src="/static/socket.io.min.js?v=2"></script>
    <script src="/static/chat-auth.js"></script>
    <script src="/static/chat-storage.js"></script>
    <script src="/static/chat-core.js"></script>
    <script src="/static/chat-image.js"></script>
    <script src="/static/chat-image-loader.js"></script>
    <script src="/static/chat-file-dump.js"></script>
    <script src="/static/chat-ui.js"></script>
    <script src="/static/chat-messages-list.js"></script>
    <script src="/static/chat-messages-window.js"></script>
    <script src="/static/chat-messages.js"></script>
    <script src="/static/chat-friends.js"></script>
    <script src="/static/chat-settings.js"></script>
    <script src="/static/chat-calls.js"></script>
    <script src="/static/chat-media.js"></script>
    <script src="/static/chat-image-viewer.js"></script>
    <script src="/static/chat-init.js"></script>
    
    <div class="chat-window" id="chat-window">
        <div class="chat-window-header">
            <div class="chat-window-title" id="chat-window-title">💬 聊天</div>
            <button class="chat-window-close" onclick="ChatMessages.close()">✕ 关闭</button>
        </div>
        <div class="chat-messages-container" id="chat-messages-container">
            <div class="empty-state">
                <div class="empty-icon">💬</div>
                <div>加载消息中...</div>
            </div>
        </div>
        <div class="chat-input-area">
            <button class="chat-voice-btn" id="chat-voice-btn" title="按住说话">🎤</button>
            <textarea class="chat-input" id="chat-input" placeholder="输入消息..." rows="1"></textarea>
            <button class="chat-send-btn" id="chat-send-btn" onclick="ChatMessages.send()">发送</button>
            <button class="chat-more-btn" id="chat-more-btn" title="更多功能">+</button>
        </div>
        <div class="chat-more-menu" id="chat-more-menu">
            <div class="chat-more-item" onclick="ChatMedia.selectFromAlbum()">
                <div class="chat-more-item-icon">🖼️</div>
                <div class="chat-more-item-label">相册</div>
            </div>
            <div class="chat-more-item" onclick="ChatMedia.takePhoto()">
                <div class="chat-more-item-icon">📷</div>
                <div class="chat-more-item-label">拍照</div>
            </div>
            <div class="chat-more-item" onclick="ChatCalls.startVideoCall()">
                <div class="chat-more-item-icon">📹</div>
                <div class="chat-more-item-label">视频通话</div>
            </div>
            <div class="chat-more-item" onclick="ChatMedia.selectFile()">
                <div class="chat-more-item-icon">📁</div>
                <div class="chat-more-item-label">文件</div>
            </div>
        </div>
        <div class="voice-recording-hint" id="voice-recording-hint">松开手指，发送语音</div>
    </div>
    
    <div class="top-header" id="top-header">
        <h1 id="page-title">💬 消息</h1>
        <div class="header-actions">
            <input type="text" class="search-input" id="search-input" placeholder="搜索..." style="display: none;">
            <button class="search-btn" id="search-btn" onclick="ChatUI.toggleSearch()">🔍</button>
            <button class="add-friend-btn" id="add-friend-btn" onclick="ChatFriends.showAddModal()" style="display: none;">+ 添加</button>
        </div>
    </div>
    
    <div class="main-content">
        <div class="page active" id="messages-page">
            <ul class="message-list" id="message-list">
                <div class="empty-state">
                    <div class="empty-icon">💬</div>
                    <div>暂无消息</div>
                </div>
            </ul>
        </div>
        
        <div class="page" id="contacts-page">
            <ul class="friend-list" id="friend-list">
                <div class="empty-state">
                    <div class="empty-icon">👫</div>
                    <div>暂无好友</div>
                </div>
            </ul>
        </div>
        
        <div class="page" id="settings-page">
            <div class="settings-section">
                <h3>个人资料</h3>
                <div class="settings-item">
                    <span class="settings-label">用户名</span>
                    <span class="settings-value" id="settings-username">加载中...</span>
                </div>
                <div class="settings-item">
                    <span class="settings-label">手机号</span>
                    <span class="settings-value" id="settings-phone">加载中...</span>
                </div>
                <div class="settings-item">
                    <span class="settings-label">昵称</span>
                    <span class="settings-value" id="settings-nickname">加载中...</span>
                </div>
                <div class="settings-item">
                    <span class="settings-label">语言</span>
                    <span class="settings-value" id="settings-language">加载中...</span>
                </div>
            </div>
            
            <div class="settings-section">
                <h3>账户操作</h3>
                <div class="settings-item">
                    <span class="settings-label">修改密码</span>
                    <button class="btn-settings btn-primary" onclick="ChatSettings.showChangePasswordModal()">修改</button>
                </div>
                <div class="settings-item">
                    <span class="settings-label">退出账户</span>
                    <button class="btn-settings btn-danger" onclick="ChatSettings.logout()">退出</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="bottom-nav">
        <div class="nav-item active" onclick="ChatUI.switchPage('messages')">
            <div class="nav-icon">💬</div>
            <div class="nav-label">消息</div>
        </div>
        <div class="nav-item" onclick="ChatUI.switchPage('contacts')">
            <div class="nav-icon">👫</div>
            <div class="nav-label">联系人</div>
        </div>
        <div class="nav-item" onclick="ChatUI.switchPage('settings')">
            <div class="nav-icon">⚙️</div>
            <div class="nav-label">账户设置</div>
        </div>
    </div>
    
    <div class="modal" id="add-friend-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">搜索并添加好友</div>
                <button class="close-btn" onclick="ChatFriends.closeAddModal()">&times;</button>
            </div>
            <input type="text" class="search-box" id="friend-search-input" placeholder="输入手机号或用户名（精确匹配）" onkeydown="if(event.key==='Escape') ChatFriends.closeAddModal()">
            <div class="search-results" id="search-results">
                <div class="empty-search">输入手机号或用户名搜索</div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="change-password-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">修改密码</div>
                <button class="close-btn" onclick="ChatSettings.closeChangePasswordModal()">&times;</button>
            </div>
            <form id="change-password-form">
                <div class="form-group">
                    <label>旧密码</label>
                    <input type="password" id="old-password" required>
                </div>
                <div class="form-group">
                    <label>新密码</label>
                    <input type="password" id="new-password" required minlength="6">
                </div>
                <div class="form-group">
                    <label>确认新密码</label>
                    <input type="password" id="confirm-password" required minlength="6">
                </div>
                <button type="submit" class="btn-settings btn-primary" style="width: 100%; margin-top: 10px;">确认修改</button>
            </form>
        </div>
    </div>
    
    <div class="call-invitation-modal" id="call-invitation-modal">
        <div class="call-invitation-content">
            <div class="call-invitation-icon">📹</div>
            <div class="call-invitation-title" id="call-invitation-title">通话邀请</div>
            <div class="call-invitation-message" id="call-invitation-message">对方邀请您进入通话会议，可共享屏幕</div>
            <div class="call-invitation-buttons">
                <button class="call-invitation-btn accept" onclick="ChatCalls.acceptInvitation()">接受</button>
                <button class="call-invitation-btn reject" onclick="ChatCalls.rejectInvitation()">拒绝</button>
            </div>
        </div>
    </div>
    
    <div id="image-viewer-modal" class="image-viewer-modal" onclick="ChatImageViewer.close()">
        <div class="image-viewer-content" onclick="event.stopPropagation()">
            <button class="image-viewer-close" onclick="ChatImageViewer.close()" title="关闭">×</button>
            <img id="image-viewer-img" src="" alt="图片" />
        </div>
    </div>

    <!-- 视频通话内嵌层：结束会议后直接返回聊天，无新窗口 -->
    <div id="call-overlay" class="call-overlay" style="display: none;">
        <iframe id="call-overlay-iframe" class="call-overlay-iframe" title="视频通话"></iframe>
    </div>
</body>
</html>
