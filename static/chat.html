<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <title>èŠå¤© - MOP</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: #f5f7fa;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .top-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .top-header h1 {
            font-size: 1.2em;
            font-weight: 600;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .search-btn, .add-friend-btn {
            padding: 6px 12px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .search-btn:hover, .add-friend-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .search-input {
            display: none;
            padding: 6px 12px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 14px;
            width: 200px;
        }
        
        .search-input::placeholder {
            color: rgba(255,255,255,0.7);
        }
        
        .search-input.active {
            display: block;
        }
        
        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 80px; /* ä¸ºåº•éƒ¨å¯¼èˆªæ ç•™å‡ºç©ºé—´ */
        }
        
        /* é¡µé¢å®¹å™¨ */
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        /* æ¶ˆæ¯åˆ—è¡¨ */
        .message-list {
            list-style: none;
        }
        
        .message-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .message-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .message-info {
            flex: 1;
            min-width: 0;
        }
        
        .message-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            font-size: 16px;
        }
        
        .message-preview {
            font-size: 14px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .message-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
            margin-left: 15px;
        }
        
        .message-time {
            font-size: 12px;
            color: #999;
        }
        
        .unread-badge {
            background: #ff4444;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: 600;
            min-width: 18px;
            text-align: center;
        }
        
        /* å¥½å‹åˆ—è¡¨ */
        .friend-list {
            list-style: none;
        }
        
        .friend-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        
        .friend-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .friend-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .friend-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 20px;
        }
        
        .friend-details {
            flex: 1;
            min-width: 0;
        }
        
        .friend-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            font-size: 16px;
        }
        
        .friend-status {
            font-size: 12px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .status-dot.online {
            background: #28a745;
        }
        
        .status-dot.offline {
            background: #999;
        }
        
        .friend-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-small {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .btn-chat {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-chat:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }
        
        /* è´¦æˆ·è®¾ç½® */
        .settings-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .settings-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .settings-item {
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .settings-item:last-child {
            border-bottom: none;
        }
        
        .settings-label {
            color: #333;
            font-weight: 500;
        }
        
        .settings-value {
            color: #666;
            font-size: 14px;
        }
        
        .btn-settings {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        /* åº•éƒ¨å¯¼èˆªæ  */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 0;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            z-index: 100;
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 8px;
            transition: all 0.3s;
            color: #999;
        }
        
        .nav-item.active {
            color: #667eea;
        }
        
        .nav-icon {
            font-size: 24px;
        }
        
        .nav-label {
            font-size: 12px;
        }
        
        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        
        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .modal-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .close-btn:hover {
            background: #f0f0f0;
            color: #333;
        }
        
        .search-box {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 15px;
            transition: border-color 0.3s;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .search-results {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .user-item {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        
        .user-item:hover {
            background: #f8f9fa;
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        
        .user-meta {
            font-size: 0.85em;
            color: #666;
        }
        
        .user-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }
        
        .user-status.online {
            background: #28a745;
        }
        
        .user-status.offline {
            background: #999;
        }
        
        .user-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-add {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-add:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }
        
        .btn-add:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-pending {
            background: #ffc107;
            color: #333;
            cursor: default;
        }
        
        .btn-accepted {
            background: #28a745;
            color: white;
            cursor: default;
        }
        
        .empty-search {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        /* èŠå¤©çª—å£ */
        .chat-window {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 1000;
            flex-direction: column;
        }
        
        .chat-window.active {
            display: flex;
        }
        
        .chat-window-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .chat-window-title {
            font-size: 1.1em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chat-window-close {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .chat-window-close:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .chat-messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .chat-message {
            display: flex;
            flex-direction: column;
            max-width: 70%;
            animation: messageSlideIn 0.3s ease-out;
        }
        
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .chat-message.sent {
            align-self: flex-end;
            align-items: flex-end;
        }
        
        .chat-message.received {
            align-self: flex-start;
            align-items: flex-start;
        }
        
        .chat-message-bubble {
            padding: 10px 15px;
            border-radius: 18px;
            word-wrap: break-word;
            position: relative;
        }
        
        .chat-message.sent .chat-message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .chat-message.received .chat-message-bubble {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 4px;
        }
        
        .chat-message-time {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
            padding: 0 5px;
        }
        
        .chat-message-status {
            font-size: 11px;
            margin-top: 2px;
            padding: 0 5px;
        }
        
        .chat-message-status.read {
            color: #28a745;
        }
        
        .chat-message-status.sent {
            color: #999;
        }
        
        .chat-input-area {
            padding: 15px 20px;
            border-top: 1px solid #e0e0e0;
            background: white;
            display: flex;
            gap: 10px;
            align-items: flex-end;
            position: relative;
        }
        
        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            font-size: 14px;
            resize: none;
            max-height: 120px;
            font-family: inherit;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .chat-send-btn {
            padding: 10px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .chat-send-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }
        
        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* è¯­éŸ³æŒ‰é’®å’ŒåŠŸèƒ½æŒ‰é’® */
        .chat-voice-btn, .chat-more-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: #f0f0f0;
            color: #666;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            flex-shrink: 0;
        }
        
        .chat-voice-btn:hover, .chat-more-btn:hover {
            background: #e0e0e0;
            transform: scale(1.05);
        }
        
        .chat-voice-btn:active, .chat-more-btn:active {
            transform: scale(0.95);
        }
        
        .chat-voice-btn.recording {
            background: #ff4444;
            color: white;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }
        
        /* åŠŸèƒ½èœå• */
        .chat-more-menu {
            position: absolute;
            bottom: 70px;
            left: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 -2px 20px rgba(0,0,0,0.15);
            display: none;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            z-index: 1001;
            max-width: calc(100% - 40px);
        }
        
        .chat-more-menu.show {
            display: grid;
        }
        
        @media (max-width: 480px) {
            .chat-more-menu {
                grid-template-columns: repeat(4, 1fr);
                gap: 10px;
                padding: 12px;
            }
            
            .chat-more-item-icon {
                width: 45px;
                height: 45px;
                font-size: 20px;
            }
            
            .chat-more-item-label {
                font-size: 11px;
            }
        }
        
        .chat-more-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .chat-more-item:hover {
            background: #f5f5f5;
        }
        
        .chat-more-item-icon {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }
        
        .chat-more-item-label {
            font-size: 12px;
            color: #333;
        }
        
        /* è¯­éŸ³å½•åˆ¶æç¤º */
        .voice-recording-hint {
            position: absolute;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            display: none;
            z-index: 1002;
            font-size: 14px;
        }
        
        .voice-recording-hint.show {
            display: block;
        }
        
        .voice-recording-hint.recording {
            background: rgba(255,68,68,0.9);
        }
        
        /* é€šè¯é‚€è¯·å¼¹çª— */
        .call-invitation-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
        }
        
        .call-invitation-modal.show {
            display: flex;
        }
        
        .call-invitation-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            text-align: center;
        }
        
        .call-invitation-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .call-invitation-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }
        
        .call-invitation-message {
            font-size: 16px;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.5;
        }
        
        .call-invitation-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .call-invitation-btn {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .call-invitation-btn.accept {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .call-invitation-btn.accept:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .call-invitation-btn.reject {
            background: #f0f0f0;
            color: #666;
        }
        
        .call-invitation-btn.reject:hover {
            background: #e0e0e0;
        }
    </style>
</head>
<body>
    <!-- èŠå¤©çª—å£ -->
    <div class="chat-window" id="chat-window">
        <div class="chat-window-header">
            <div class="chat-window-title" id="chat-window-title">ğŸ’¬ èŠå¤©</div>
            <button class="chat-window-close" onclick="closeChatWindow()">âœ• å…³é—­</button>
        </div>
        <div class="chat-messages-container" id="chat-messages-container">
            <div class="empty-state">
                <div class="empty-icon">ğŸ’¬</div>
                <div>åŠ è½½æ¶ˆæ¯ä¸­...</div>
            </div>
        </div>
        <div class="chat-input-area">
            <button class="chat-voice-btn" id="chat-voice-btn" title="æŒ‰ä½è¯´è¯">ğŸ¤</button>
            <textarea class="chat-input" id="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1"></textarea>
            <button class="chat-send-btn" id="chat-send-btn" onclick="sendChatMessage()">å‘é€</button>
            <button class="chat-more-btn" id="chat-more-btn" title="æ›´å¤šåŠŸèƒ½">+</button>
        </div>
        <!-- åŠŸèƒ½èœå• -->
        <div class="chat-more-menu" id="chat-more-menu">
            <div class="chat-more-item" onclick="selectFromAlbum()">
                <div class="chat-more-item-icon">ğŸ–¼ï¸</div>
                <div class="chat-more-item-label">ç›¸å†Œ</div>
            </div>
            <div class="chat-more-item" onclick="takePhoto()">
                <div class="chat-more-item-icon">ğŸ“·</div>
                <div class="chat-more-item-label">æ‹ç…§</div>
            </div>
            <div class="chat-more-item" onclick="startVideoCall()">
                <div class="chat-more-item-icon">ğŸ“¹</div>
                <div class="chat-more-item-label">è§†é¢‘é€šè¯</div>
            </div>
            <div class="chat-more-item" onclick="selectFile()">
                <div class="chat-more-item-icon">ğŸ“</div>
                <div class="chat-more-item-label">æ–‡ä»¶</div>
            </div>
        </div>
        <!-- è¯­éŸ³å½•åˆ¶æç¤º -->
        <div class="voice-recording-hint" id="voice-recording-hint">æ¾å¼€æ‰‹æŒ‡ï¼Œå‘é€è¯­éŸ³</div>
    </div>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="top-header" id="top-header">
        <h1 id="page-title">ğŸ’¬ æ¶ˆæ¯</h1>
        <div class="header-actions">
            <input type="text" class="search-input" id="search-input" placeholder="æœç´¢..." style="display: none;">
            <button class="search-btn" id="search-btn" onclick="toggleSearch()">ğŸ”</button>
            <button class="add-friend-btn" id="add-friend-btn" onclick="showAddFriendModal()" style="display: none;">+ æ·»åŠ </button>
        </div>
    </div>
    
    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="main-content">
        <!-- æ¶ˆæ¯é¡µé¢ -->
        <div class="page active" id="messages-page">
            <ul class="message-list" id="message-list">
                <div class="empty-state">
                    <div class="empty-icon">ğŸ’¬</div>
                    <div>æš‚æ— æ¶ˆæ¯</div>
                </div>
            </ul>
        </div>
        
        <!-- è”ç³»äººé¡µé¢ -->
        <div class="page" id="contacts-page">
            <ul class="friend-list" id="friend-list">
                <div class="empty-state">
                    <div class="empty-icon">ğŸ‘«</div>
                    <div>æš‚æ— å¥½å‹</div>
                </div>
            </ul>
        </div>
        
        <!-- è´¦æˆ·è®¾ç½®é¡µé¢ -->
        <div class="page" id="settings-page">
            <div class="settings-section">
                <h3>ä¸ªäººèµ„æ–™</h3>
                <div class="settings-item">
                    <span class="settings-label">ç”¨æˆ·å</span>
                    <span class="settings-value" id="settings-username">åŠ è½½ä¸­...</span>
                </div>
                <div class="settings-item">
                    <span class="settings-label">æ‰‹æœºå·</span>
                    <span class="settings-value" id="settings-phone">åŠ è½½ä¸­...</span>
                </div>
                <div class="settings-item">
                    <span class="settings-label">æ˜µç§°</span>
                    <span class="settings-value" id="settings-nickname">åŠ è½½ä¸­...</span>
                </div>
                <div class="settings-item">
                    <span class="settings-label">è¯­è¨€</span>
                    <span class="settings-value" id="settings-language">åŠ è½½ä¸­...</span>
                </div>
            </div>
            
            <div class="settings-section">
                <h3>è´¦æˆ·æ“ä½œ</h3>
                <div class="settings-item">
                    <span class="settings-label">ä¿®æ”¹å¯†ç </span>
                    <button class="btn-settings btn-primary" onclick="showChangePasswordModal()">ä¿®æ”¹</button>
                </div>
                <div class="settings-item">
                    <span class="settings-label">é€€å‡ºè´¦æˆ·</span>
                    <button class="btn-settings btn-danger" onclick="logout()">é€€å‡º</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- åº•éƒ¨å¯¼èˆªæ  -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchPage('messages')">
            <div class="nav-icon">ğŸ’¬</div>
            <div class="nav-label">æ¶ˆæ¯</div>
        </div>
        <div class="nav-item" onclick="switchPage('contacts')">
            <div class="nav-icon">ğŸ‘«</div>
            <div class="nav-label">è”ç³»äºº</div>
        </div>
        <div class="nav-item" onclick="switchPage('settings')">
            <div class="nav-icon">âš™ï¸</div>
            <div class="nav-label">è´¦æˆ·è®¾ç½®</div>
        </div>
    </div>
    
    <!-- æ·»åŠ å¥½å‹æ¨¡æ€æ¡† -->
    <div class="modal" id="add-friend-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">æœç´¢å¹¶æ·»åŠ å¥½å‹</div>
                <button class="close-btn" onclick="closeAddFriendModal()">&times;</button>
            </div>
            <input type="text" class="search-box" id="friend-search-input" 
                   placeholder="è¾“å…¥æ‰‹æœºå·ã€ç”¨æˆ·åæˆ–æ˜µç§°æœç´¢..." 
                   onkeyup="handleSearchInput(event)">
            <div class="search-results" id="search-results">
                <div class="empty-search">è¾“å…¥å…³é”®è¯æœç´¢ç”¨æˆ·</div>
            </div>
        </div>
    </div>
    
    <!-- ä¿®æ”¹å¯†ç æ¨¡æ€æ¡† -->
    <div class="modal" id="change-password-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ä¿®æ”¹å¯†ç </div>
                <button class="close-btn" onclick="closeChangePasswordModal()">&times;</button>
            </div>
            <form id="change-password-form">
                <div class="form-group">
                    <label>æ—§å¯†ç </label>
                    <input type="password" id="old-password" required>
                </div>
                <div class="form-group">
                    <label>æ–°å¯†ç </label>
                    <input type="password" id="new-password" required minlength="6">
                </div>
                <div class="form-group">
                    <label>ç¡®è®¤æ–°å¯†ç </label>
                    <input type="password" id="confirm-password" required minlength="6">
                </div>
                <button type="submit" class="btn-settings btn-primary" style="width: 100%; margin-top: 10px;">ç¡®è®¤ä¿®æ”¹</button>
            </form>
        </div>
    </div>
    
    <!-- é€šè¯é‚€è¯·å¼¹çª— -->
    <div class="call-invitation-modal" id="call-invitation-modal">
        <div class="call-invitation-content">
            <div class="call-invitation-icon">ğŸ“¹</div>
            <div class="call-invitation-title" id="call-invitation-title">é€šè¯é‚€è¯·</div>
            <div class="call-invitation-message" id="call-invitation-message">å¯¹æ–¹é‚€è¯·æ‚¨è¿›å…¥é€šè¯ä¼šè®®ï¼Œå¯å…±äº«å±å¹•</div>
            <div class="call-invitation-buttons">
                <button class="call-invitation-btn accept" onclick="acceptCallInvitation()">æ¥å—</button>
                <button class="call-invitation-btn reject" onclick="rejectCallInvitation()">æ‹’ç»</button>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        // åŸŸåæ£€æŸ¥ï¼šchat.html åº”è¯¥åªåœ¨ log.chat5202ol.xyz ä½¿ç”¨
        const hostname = window.location.hostname;
        if (hostname !== 'log.chat5202ol.xyz' && hostname !== 'localhost' && hostname !== '127.0.0.1') {
            // å¦‚æœåœ¨ä¸»åŸŸåè®¿é—®ï¼Œé‡å®šå‘åˆ°åå°ç®¡ç†ç³»ç»Ÿ
            if (hostname === 'www.chat5202ol.xyz' || hostname === 'chat5202ol.xyz') {
                window.location.href = '/dashboard';
                throw new Error('Redirecting to dashboard');
            }
            // å…¶ä»–åŸŸåæç¤ºé”™è¯¯
            alert('å³æ—¶é€šè®¯åŠŸèƒ½åªèƒ½åœ¨ log.chat5202ol.xyz åŸŸåè®¿é—®');
            window.location.href = '/login';
            throw new Error('Invalid domain for chat');
        }
        
        // API åŸºç¡€è·¯å¾„ï¼šlog.chat5202ol.xyz ä½¿ç”¨è‡ªå·±çš„ API
        const API_BASE = '/api/v1';
        let socket = null;
        let currentUser = null;
        let currentPage = 'messages';
        let conversations = [];
        let friends = [];
        let currentChat = null; // {id: number, name: string, isRoom: boolean}
        let chatMessages = [];
        
        // è·å–Token
        function getToken() {
            return localStorage.getItem('access_token');
        }
        
        // åˆå§‹åŒ–
        async function init() {
            const token = getToken();
            if (!token) {
                window.location.href = '/login';
                return;
            }
            
            // åŠ è½½ç”¨æˆ·ä¿¡æ¯
            await loadUserInfo();
            
            // è¿æ¥Socket.io
            connectSocket();
            
            // åŠ è½½åˆå§‹æ•°æ®
            await loadMessages();
            await loadFriends();
        }
        
        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        async function loadUserInfo() {
            try {
                const token = getToken();
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
                }
                
                currentUser = await response.json();
                
                // æ›´æ–°è´¦æˆ·è®¾ç½®é¡µé¢
                document.getElementById('settings-username').textContent = currentUser.username || 'æœªè®¾ç½®';
                document.getElementById('settings-phone').textContent = currentUser.phone || 'æœªè®¾ç½®';
                document.getElementById('settings-nickname').textContent = currentUser.nickname || 'æœªè®¾ç½®';
                document.getElementById('settings-language').textContent = currentUser.language || 'zh_CN';
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                alert('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
                window.location.href = '/login';
            }
        }
        
        // è¿æ¥Socket.io
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;
        let reconnectTimeout = null;
        
        function connectSocket() {
            const token = getToken();
            if (!token) {
                console.error('æ— æ³•è¿æ¥ Socket.ioï¼šç¼ºå°‘ token');
                return;
            }
            
            console.log('æ­£åœ¨è¿æ¥ Socket.io...');
            
            // å¦‚æœå·²æœ‰è¿æ¥ï¼Œå…ˆæ–­å¼€
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            
            socket = io('/', {
                auth: { token },
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000,
                reconnectionAttempts: MAX_RECONNECT_ATTEMPTS,
                timeout: 20000
            });
            
            socket.on('connect', () => {
                console.log('âœ“ Socket.io è¿æ¥æˆåŠŸï¼ŒSocket ID:', socket.id);
                reconnectAttempts = 0;
                
                // æ¸…é™¤é‡è¿å®šæ—¶å™¨
                if (reconnectTimeout) {
                    clearTimeout(reconnectTimeout);
                    reconnectTimeout = null;
                }
            });
            
            socket.on('connected', (data) => {
                console.log('âœ“ æœåŠ¡å™¨ç¡®è®¤è¿æ¥æˆåŠŸ:', data);
            });
            
            socket.on('disconnect', (reason) => {
                console.log('âœ— Socket.io æ–­å¼€è¿æ¥ï¼ŒåŸå› :', reason);
                
                // å¦‚æœä¸æ˜¯ä¸»åŠ¨æ–­å¼€ï¼Œå°è¯•é‡è¿
                if (reason === 'io server disconnect') {
                    // æœåŠ¡å™¨ä¸»åŠ¨æ–­å¼€ï¼Œå¯èƒ½æ˜¯è®¤è¯å¤±è´¥ï¼Œä¸è‡ªåŠ¨é‡è¿
                    console.error('æœåŠ¡å™¨ä¸»åŠ¨æ–­å¼€è¿æ¥ï¼Œå¯èƒ½æ˜¯è®¤è¯å¤±è´¥');
                } else if (reason === 'io client disconnect') {
                    // å®¢æˆ·ç«¯ä¸»åŠ¨æ–­å¼€ï¼Œä¸é‡è¿
                    console.log('å®¢æˆ·ç«¯ä¸»åŠ¨æ–­å¼€è¿æ¥');
                } else {
                    // ç½‘ç»œé”™è¯¯ç­‰ï¼Œå°è¯•é‡è¿
                    if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                        reconnectAttempts++;
                        const delay = Math.min(1000 * reconnectAttempts, 5000);
                        console.log(`å°†åœ¨ ${delay}ms åå°è¯•é‡è¿ (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`);
                        reconnectTimeout = setTimeout(() => {
                            console.log('å°è¯•é‡æ–°è¿æ¥ Socket.io...');
                            connectSocket();
                        }, delay);
                    } else {
                        console.error('è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•°ï¼Œåœæ­¢é‡è¿');
                    }
                }
            });
            
            socket.on('connect_error', (error) => {
                console.error('âœ— Socket.io è¿æ¥é”™è¯¯:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.message);
            });
            
            socket.on('reconnect', (attemptNumber) => {
                console.log('âœ“ Socket.io é‡è¿æˆåŠŸï¼Œå°è¯•æ¬¡æ•°:', attemptNumber);
                reconnectAttempts = 0;
            });
            
            socket.on('reconnect_attempt', (attemptNumber) => {
                console.log('æ­£åœ¨å°è¯•é‡è¿ Socket.ioï¼Œå°è¯•æ¬¡æ•°:', attemptNumber);
            });
            
            socket.on('reconnect_error', (error) => {
                console.error('âœ— Socket.io é‡è¿é”™è¯¯:', error);
            });
            
            socket.on('reconnect_failed', () => {
                console.error('âœ— Socket.io é‡è¿å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§å°è¯•æ¬¡æ•°');
            });
            
            socket.on('message', (data) => {
                console.log('âœ“âœ“âœ“ æ”¶åˆ° message äº‹ä»¶:', data);
                console.log('æ¶ˆæ¯è¯¦æƒ…:', JSON.stringify(data, null, 2));
                handleNewMessage(data);
            });
            
            socket.on('notification', (data) => {
                console.log('æ”¶åˆ°é€šçŸ¥:', data);
                if (data.type === 'friend_request') {
                    loadFriends();
                }
            });
            
            socket.on('call_invitation', (data) => {
                console.log('âœ“âœ“âœ“ æ”¶åˆ°é€šè¯é‚€è¯·äº‹ä»¶:', data);
                console.log('é‚€è¯·æ•°æ®è¯¦æƒ…:', JSON.stringify(data, null, 2));
                console.log('å½“å‰é¡µé¢çŠ¶æ€ - currentChat:', currentChat);
                console.log('å½“å‰ç”¨æˆ·ID:', currentUser ? currentUser.id : 'æœªè®¾ç½®');
                
                if (!data) {
                    console.error('âœ— é‚€è¯·æ•°æ®ä¸ºç©º');
                    return;
                }
                
                // æ˜¾ç¤ºé‚€è¯·å¼¹çª—ï¼ˆæ— è®ºæ˜¯å¦åœ¨èŠå¤©çª—å£ï¼‰
                try {
                    console.log('å‡†å¤‡æ˜¾ç¤ºé‚€è¯·å¼¹çª—...');
                    showCallInvitation(data);
                    console.log('âœ“ é‚€è¯·å¼¹çª—å·²æ˜¾ç¤º');
                    
                    // å¦‚æœä¸åœ¨èŠå¤©çª—å£ï¼Œä¹Ÿå¯ä»¥æ˜¾ç¤ºä¸€ä¸ªé€šçŸ¥
                    if (!currentChat) {
                        console.log('å½“å‰ä¸åœ¨èŠå¤©çª—å£ï¼Œä½†é‚€è¯·å¼¹çª—å·²æ˜¾ç¤º');
                    }
                } catch (error) {
                    console.error('âœ— æ˜¾ç¤ºé‚€è¯·å¼¹çª—å¤±è´¥:', error);
                    console.error('é”™è¯¯å †æ ˆ:', error.stack);
                    alert('æ˜¾ç¤ºé€šè¯é‚€è¯·å¤±è´¥: ' + error.message);
                }
            });
            
            socket.on('call_invitation_sent', (data) => {
                console.log('âœ“ é€šè¯é‚€è¯·å‘é€ç¡®è®¤:', data);
            });
            
            socket.on('error', (error) => {
                console.error('âœ— Socket.io é”™è¯¯:', error);
                if (error.message) {
                    alert('Socket.io é”™è¯¯: ' + error.message);
                }
            });
        }
        
        // åˆ‡æ¢é¡µé¢
        function switchPage(page) {
            currentPage = page;
            
            // æ›´æ–°å¯¼èˆªæ 
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            // æ›´æ–°é¡µé¢æ˜¾ç¤º
            document.querySelectorAll('.page').forEach(p => {
                p.classList.remove('active');
            });
            
            // æ›´æ–°æ ‡é¢˜å’Œæ“ä½œæŒ‰é’®
            const titles = {
                'messages': 'ğŸ’¬ æ¶ˆæ¯',
                'contacts': 'ğŸ‘« è”ç³»äºº',
                'settings': 'âš™ï¸ è´¦æˆ·è®¾ç½®'
            };
            
            document.getElementById('page-title').textContent = titles[page] || 'MOP';
            
            // æ˜¾ç¤º/éšè—æœç´¢å’Œæ·»åŠ æŒ‰é’®
            const searchBtn = document.getElementById('search-btn');
            const addFriendBtn = document.getElementById('add-friend-btn');
            
            if (page === 'messages' || page === 'contacts') {
                searchBtn.style.display = 'block';
                addFriendBtn.style.display = 'block';
            } else {
                searchBtn.style.display = 'none';
                addFriendBtn.style.display = 'none';
            }
            
            // æ˜¾ç¤ºå¯¹åº”é¡µé¢
            document.getElementById(`${page}-page`).classList.add('active');
            
            // å¦‚æœæ˜¯è”ç³»äººé¡µé¢ï¼Œåˆ·æ–°å¥½å‹åˆ—è¡¨
            if (page === 'contacts') {
                loadFriends();
            }
        }
        
        // åˆ‡æ¢æœç´¢
        function toggleSearch() {
            const searchInput = document.getElementById('search-input');
            const searchBtn = document.getElementById('search-btn');
            
            if (searchInput.style.display === 'none') {
                searchInput.style.display = 'block';
                searchInput.focus();
                searchBtn.textContent = 'âœ•';
            } else {
                searchInput.style.display = 'none';
                searchInput.value = '';
                searchBtn.textContent = 'ğŸ”';
                // åˆ·æ–°å½“å‰é¡µé¢æ•°æ®
                if (currentPage === 'messages') {
                    loadMessages();
                } else if (currentPage === 'contacts') {
                    loadFriends();
                }
            }
        }
        
        // æœç´¢å¤„ç†
        let searchTimeout = null;
        document.getElementById('search-input').addEventListener('input', (e) => {
            const keyword = e.target.value.trim();
            
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                if (currentPage === 'messages') {
                    searchMessages(keyword);
                } else if (currentPage === 'contacts') {
                    searchFriends(keyword);
                }
            }, 300);
        });
        
        // åŠ è½½æ¶ˆæ¯åˆ—è¡¨
        async function loadMessages() {
            try {
                const token = getToken();
                const response = await fetch(`${API_BASE}/chat/conversations`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('åŠ è½½æ¶ˆæ¯åˆ—è¡¨å¤±è´¥');
                }
                
                const data = await response.json();
                conversations = data.conversations || [];
                
                renderMessages();
            } catch (error) {
                console.error('åŠ è½½æ¶ˆæ¯åˆ—è¡¨å¤±è´¥:', error);
                document.getElementById('message-list').innerHTML = '<div class="empty-state"><div>åŠ è½½å¤±è´¥</div></div>';
            }
        }
        
        // æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨
        function renderMessages() {
            const list = document.getElementById('message-list');
            
            if (conversations.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ’¬</div><div>æš‚æ— æ¶ˆæ¯</div></div>';
                return;
            }
            
            list.innerHTML = conversations.map(conv => {
                const name = conv.room_name || conv.user_nickname || `ç”¨æˆ·${conv.user_id || conv.room_id}`;
                const preview = conv.last_message || 'æš‚æ— æ¶ˆæ¯';
                const time = formatTime(conv.last_message_time);
                const unreadCount = conv.unread_count || 0;
                
                return `
                    <li class="message-item" onclick="openChat(${conv.room_id || conv.user_id}, '${escapeHtml(name)}', ${conv.room_id ? 'true' : 'false'})">
                        <div class="message-info">
                            <div class="message-name">${escapeHtml(name)}</div>
                            <div class="message-preview">${escapeHtml(preview)}</div>
                        </div>
                        <div class="message-meta">
                            ${unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : ''}
                            <div class="message-time">${time}</div>
                        </div>
                    </li>
                `;
            }).join('');
        }
        
        // æœç´¢æ¶ˆæ¯
        function searchMessages(keyword) {
            if (!keyword) {
                renderMessages();
                return;
            }
            
            const filtered = conversations.filter(conv => {
                const name = (conv.room_name || conv.user_nickname || '').toLowerCase();
                const preview = (conv.last_message || '').toLowerCase();
                return name.includes(keyword.toLowerCase()) || preview.includes(keyword.toLowerCase());
            });
            
            const list = document.getElementById('message-list');
            if (filtered.length === 0) {
                list.innerHTML = '<div class="empty-state"><div>æœªæ‰¾åˆ°åŒ¹é…çš„æ¶ˆæ¯</div></div>';
                return;
            }
            
            list.innerHTML = filtered.map(conv => {
                const name = conv.room_name || conv.user_nickname || `ç”¨æˆ·${conv.user_id || conv.room_id}`;
                const preview = conv.last_message || 'æš‚æ— æ¶ˆæ¯';
                const time = formatTime(conv.last_message_time);
                const unreadCount = conv.unread_count || 0;
                
                return `
                    <li class="message-item" onclick="openChat(${conv.room_id || conv.user_id}, '${escapeHtml(name)}', ${conv.room_id ? 'true' : 'false'})">
                        <div class="message-info">
                            <div class="message-name">${escapeHtml(name)}</div>
                            <div class="message-preview">${escapeHtml(preview)}</div>
                        </div>
                        <div class="message-meta">
                            ${unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : ''}
                            <div class="message-time">${time}</div>
                        </div>
                    </li>
                `;
            }).join('');
        }
        
        // æ‰“å¼€èŠå¤©çª—å£
        function openChat(id, name, isRoom) {
            currentChat = {
                id: id,
                name: name,
                isRoom: isRoom || false
            };
            
            // æ˜¾ç¤ºèŠå¤©çª—å£
            document.getElementById('chat-window').classList.add('active');
            document.getElementById('chat-window-title').textContent = `ğŸ’¬ ${escapeHtml(name)}`;
            
            // æ¸…ç©ºæ¶ˆæ¯åˆ—è¡¨
            chatMessages = [];
            document.getElementById('chat-messages-container').innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ’¬</div><div>åŠ è½½æ¶ˆæ¯ä¸­...</div></div>';
            
            // åŠ è½½å†å²æ¶ˆæ¯
            loadChatMessages();
            
            // ç»‘å®šè¾“å…¥æ¡†äº‹ä»¶
            const chatInput = document.getElementById('chat-input');
            chatInput.value = '';
            chatInput.focus();
            
            // å›è½¦å‘é€æ¶ˆæ¯
            chatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatMessage();
                }
            });
            
            // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦å’Œæ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                
                // æ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€
                const sendBtn = document.getElementById('chat-send-btn');
                sendBtn.disabled = !this.value.trim();
            });
            
            // åˆå§‹åŒ–æ—¶æ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€
            const sendBtn = document.getElementById('chat-send-btn');
            sendBtn.disabled = !chatInput.value.trim();
            
            // åˆå§‹åŒ–è¯­éŸ³å’ŒåŠŸèƒ½æŒ‰é’®
            initChatButtons();
        }
        
        // åˆå§‹åŒ–èŠå¤©æŒ‰é’®åŠŸèƒ½
        function initChatButtons() {
            const voiceBtn = document.getElementById('chat-voice-btn');
            const moreBtn = document.getElementById('chat-more-btn');
            const moreMenu = document.getElementById('chat-more-menu');
            const voiceHint = document.getElementById('voice-recording-hint');
            
            // è¯­éŸ³å½•åˆ¶ç›¸å…³å˜é‡
            let isRecording = false;
            let mediaRecorder = null;
            let audioChunks = [];
            let recordingStartTime = null;
            
            // è¯­éŸ³æŒ‰é’®äº‹ä»¶ï¼šæŒ‰ä½å¼€å§‹å½•åˆ¶ï¼Œæ¾å¼€å‘é€
            voiceBtn.addEventListener('touchstart', startVoiceRecording, { passive: false });
            voiceBtn.addEventListener('touchend', stopVoiceRecording, { passive: false });
            voiceBtn.addEventListener('mousedown', startVoiceRecording);
            voiceBtn.addEventListener('mouseup', stopVoiceRecording);
            voiceBtn.addEventListener('mouseleave', cancelVoiceRecording);
            
            // + æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            moreBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                moreMenu.classList.toggle('show');
            });
            
            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­åŠŸèƒ½èœå•
            document.addEventListener('click', function(e) {
                if (!moreMenu.contains(e.target) && e.target !== moreBtn) {
                    moreMenu.classList.remove('show');
                }
            });
            
            // å¼€å§‹è¯­éŸ³å½•åˆ¶
            async function startVoiceRecording(e) {
                e.preventDefault();
                e.stopPropagation();
                
                if (!currentChat) {
                    alert('è¯·å…ˆæ‰“å¼€èŠå¤©çª—å£');
                    return;
                }
                
                if (isRecording) return;
                
                try {
                    // è¯·æ±‚éº¦å…‹é£æƒé™
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    // åˆ›å»º MediaRecorder
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };
                    
                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        await sendVoiceMessage(audioBlob);
                        
                        // åœæ­¢æ‰€æœ‰éŸ³é¢‘è½¨é“
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorder.start();
                    isRecording = true;
                    recordingStartTime = Date.now();
                    
                    // æ›´æ–°UI
                    voiceBtn.classList.add('recording');
                    voiceHint.classList.add('show', 'recording');
                    voiceHint.textContent = 'æ­£åœ¨å½•éŸ³...';
                    
                } catch (error) {
                    console.error('æ— æ³•è®¿é—®éº¦å…‹é£:', error);
                    alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
                }
            }
            
            // åœæ­¢è¯­éŸ³å½•åˆ¶å¹¶å‘é€
            function stopVoiceRecording(e) {
                e.preventDefault();
                e.stopPropagation();
                
                if (!isRecording || !mediaRecorder) return;
                
                const recordingDuration = Date.now() - recordingStartTime;
                
                // å¦‚æœå½•åˆ¶æ—¶é—´å¤ªçŸ­ï¼ˆå°äº0.5ç§’ï¼‰ï¼Œå–æ¶ˆå‘é€
                if (recordingDuration < 500) {
                    cancelVoiceRecording();
                    return;
                }
                
                // åœæ­¢å½•åˆ¶
                mediaRecorder.stop();
                isRecording = false;
                
                // æ›´æ–°UI
                voiceBtn.classList.remove('recording');
                voiceHint.classList.remove('show', 'recording');
                voiceHint.textContent = 'æ¾å¼€æ‰‹æŒ‡ï¼Œå‘é€è¯­éŸ³';
            }
            
            // å–æ¶ˆè¯­éŸ³å½•åˆ¶
            function cancelVoiceRecording() {
                if (!isRecording || !mediaRecorder) return;
                
                try {
                    mediaRecorder.stop();
                } catch (e) {
                    console.error('åœæ­¢å½•åˆ¶å¤±è´¥:', e);
                }
                
                isRecording = false;
                audioChunks = [];
                
                // æ›´æ–°UI
                voiceBtn.classList.remove('recording');
                voiceHint.classList.remove('show', 'recording');
                voiceHint.textContent = 'æ¾å¼€æ‰‹æŒ‡ï¼Œå‘é€è¯­éŸ³';
            }
            
            // å‘é€è¯­éŸ³æ¶ˆæ¯
            async function sendVoiceMessage(audioBlob) {
                if (!currentChat || !socket) {
                    alert('èŠå¤©çª—å£æœªæ‰“å¼€æˆ–æœªè¿æ¥');
                    return;
                }
                
                try {
                    // å°†éŸ³é¢‘è½¬æ¢ä¸º base64
                    const reader = new FileReader();
                    reader.onloadend = async () => {
                        const base64Audio = reader.result.split(',')[1];
                        
                        const data = {
                            message: base64Audio,
                            type: 'voice'
                        };
                        
                        if (currentChat.isRoom) {
                            data.room_id = currentChat.id;
                        } else {
                            data.target_user_id = currentChat.id;
                        }
                        
                        socket.emit('send_message', data);
                        
                        // é‡æ–°åŠ è½½æ¶ˆæ¯
                        setTimeout(() => {
                            loadChatMessages();
                        }, 500);
                    };
                    
                    reader.readAsDataURL(audioBlob);
                    
                } catch (error) {
                    console.error('å‘é€è¯­éŸ³æ¶ˆæ¯å¤±è´¥:', error);
                    alert('å‘é€è¯­éŸ³æ¶ˆæ¯å¤±è´¥');
                }
            }
        }
        
        // å…³é—­èŠå¤©çª—å£
        function closeChatWindow() {
            document.getElementById('chat-window').classList.remove('active');
            currentChat = null;
            chatMessages = [];
            
            // åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨
            loadMessages();
        }
        
        // åŠ è½½èŠå¤©æ¶ˆæ¯
        async function loadChatMessages() {
            if (!currentChat) return;
            
            try {
                const token = getToken();
                const params = new URLSearchParams({
                    page: '1',
                    limit: '50'
                });
                
                if (currentChat.isRoom) {
                    params.append('room_id', currentChat.id);
                } else {
                    params.append('user_id', currentChat.id);
                }
                
                const response = await fetch(`${API_BASE}/chat/messages?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('åŠ è½½æ¶ˆæ¯å¤±è´¥');
                }
                
                const data = await response.json();
                // åç«¯è¿”å›çš„æ˜¯é™åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰ï¼Œéœ€è¦åè½¬æˆå‡åºï¼ˆæœ€æ—§çš„åœ¨é¡¶éƒ¨ï¼Œæœ€æ–°çš„åœ¨åº•éƒ¨ï¼‰
                chatMessages = (data.messages || []).reverse();
                
                renderChatMessages();
                
                // æ ‡è®°æ¶ˆæ¯ä¸ºå·²è¯»
                markChatMessagesAsRead();
            } catch (error) {
                console.error('åŠ è½½èŠå¤©æ¶ˆæ¯å¤±è´¥:', error);
                document.getElementById('chat-messages-container').innerHTML = '<div class="empty-state"><div>åŠ è½½æ¶ˆæ¯å¤±è´¥</div></div>';
            }
        }
        
        // æ¸²æŸ“èŠå¤©æ¶ˆæ¯
        function renderChatMessages() {
            const container = document.getElementById('chat-messages-container');
            
            if (chatMessages.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ’¬</div><div>æš‚æ— æ¶ˆæ¯ï¼Œå¼€å§‹èŠå¤©å§</div></div>';
                return;
            }
            
            container.innerHTML = chatMessages.map(msg => {
                const isSent = msg.sender_id === currentUser.id;
                const time = formatTime(msg.created_at);
                
                return `
                    <div class="chat-message ${isSent ? 'sent' : 'received'}" data-message-id="${msg.id}">
                        ${!isSent ? `<div style="font-size: 12px; color: #666; margin-bottom: 4px; padding: 0 5px;">${escapeHtml(msg.sender_nickname || `ç”¨æˆ·${msg.sender_id}`)}</div>` : ''}
                        <div class="chat-message-bubble">
                            <div>${escapeHtml(msg.message)}</div>
                        </div>
                        <div class="chat-message-time">${time}</div>
                        ${isSent ? `<div class="chat-message-status ${msg.is_read ? 'read' : 'sent'}">${msg.is_read ? 'å·²è¯»' : 'å·²å‘é€'}</div>` : ''}
                    </div>
                `;
            }).join('');
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            container.scrollTop = container.scrollHeight;
        }
        
        // å‘é€èŠå¤©æ¶ˆæ¯
        async function sendChatMessage() {
            if (!currentChat) {
                alert('è¯·å…ˆæ‰“å¼€èŠå¤©çª—å£');
                return;
            }
            
            // æ£€æŸ¥ Socket.io è¿æ¥çŠ¶æ€
            if (!socket) {
                console.error('Socket.io æœªåˆå§‹åŒ–');
                alert('Socket.io æœªè¿æ¥ï¼Œæ­£åœ¨å°è¯•é‡æ–°è¿æ¥...');
                connectSocket();
                return;
            }
            
            if (!socket.connected) {
                console.error('Socket.io æœªè¿æ¥ï¼Œå½“å‰çŠ¶æ€:', socket.connected);
                alert('Socket.io æœªè¿æ¥ï¼Œæ­£åœ¨å°è¯•é‡æ–°è¿æ¥...');
                connectSocket();
                return;
            }
            
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) {
                return;
            }
            
            // ç¦ç”¨è¾“å…¥
            input.disabled = true;
            document.getElementById('chat-send-btn').disabled = true;
            
            try {
                const data = {
                    message: message,
                    type: 'text'
                };
                
                if (currentChat.isRoom) {
                    data.room_id = currentChat.id;
                } else {
                    data.target_user_id = currentChat.id;
                }
                
                console.log('å‘é€æ¶ˆæ¯:', data);
                socket.emit('send_message', data);
                
                // ç›‘å¬å‘é€ç¡®è®¤
                socket.once('message_sent', (confirmData) => {
                    console.log('âœ“ æ¶ˆæ¯å‘é€ç¡®è®¤:', confirmData);
                });
                
                // ç›‘å¬é”™è¯¯
                socket.once('error', (error) => {
                    console.error('âœ— å‘é€æ¶ˆæ¯é”™è¯¯:', error);
                    alert('å‘é€æ¶ˆæ¯å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
                });
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                input.value = '';
                input.style.height = 'auto';
                
                // ç«‹å³æ˜¾ç¤ºæ¶ˆæ¯ï¼ˆä¹è§‚æ›´æ–°ï¼‰
                // é‡æ–°åŠ è½½æ¶ˆæ¯ï¼ˆæ˜¾ç¤ºåˆšå‘é€çš„æ¶ˆæ¯ï¼‰
                setTimeout(() => {
                    loadChatMessages();
                }, 500);
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                alert('å‘é€æ¶ˆæ¯å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
            } finally {
                input.disabled = false;
                document.getElementById('chat-send-btn').disabled = false;
                input.focus();
            }
        }
        
        // æ ‡è®°èŠå¤©æ¶ˆæ¯ä¸ºå·²è¯»
        async function markChatMessagesAsRead() {
            if (!currentChat || !socket) return;
            
            // æŸ¥æ‰¾æœªè¯»æ¶ˆæ¯ï¼ˆæ¥æ”¶è€…æ˜¯å½“å‰ç”¨æˆ·çš„æ¶ˆæ¯ï¼‰
            const unreadMessageIds = chatMessages
                .filter(msg => msg.receiver_id === currentUser.id && !msg.is_read)
                .map(msg => msg.id);
            
            if (unreadMessageIds.length === 0) return;
            
            try {
                // é€šè¿‡Socket.ioå‘é€å·²è¯»æ ‡è®°
                socket.emit('mark_message_read', {
                    message_ids: unreadMessageIds
                });
                
                // åŒæ—¶é€šè¿‡APIæ›´æ–°ï¼ˆç¡®ä¿æ•°æ®åº“åŒæ­¥ï¼‰
                const token = getToken();
                await fetch(`${API_BASE}/chat/messages/mark-read`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message_ids: unreadMessageIds })
                });
            } catch (error) {
                console.error('æ ‡è®°æ¶ˆæ¯å·²è¯»å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½å¥½å‹åˆ—è¡¨
        async function loadFriends() {
            try {
                const token = getToken();
                const response = await fetch(`${API_BASE}/friends/list?status_filter=accepted`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('åŠ è½½å¥½å‹åˆ—è¡¨å¤±è´¥');
                }
                
                const data = await response.json();
                friends = data.friends || [];
                
                renderFriends();
            } catch (error) {
                console.error('åŠ è½½å¥½å‹åˆ—è¡¨å¤±è´¥:', error);
                document.getElementById('friend-list').innerHTML = '<div class="empty-state"><div>åŠ è½½å¤±è´¥</div></div>';
            }
        }
        
        // æ¸²æŸ“å¥½å‹åˆ—è¡¨
        function renderFriends() {
            const list = document.getElementById('friend-list');
            
            if (friends.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ‘«</div><div>æš‚æ— å¥½å‹</div></div>';
                return;
            }
            
            list.innerHTML = friends.map(friend => {
                const name = friend.note || friend.nickname || friend.username || `ç”¨æˆ·${friend.user_id}`;
                const firstChar = name.charAt(0).toUpperCase();
                const isOnline = friend.is_online || false;
                
                return `
                    <li class="friend-item">
                        <div class="friend-info">
                            <div class="friend-avatar">${escapeHtml(firstChar)}</div>
                            <div class="friend-details">
                                <div class="friend-name">${escapeHtml(name)}</div>
                                <div class="friend-status">
                                    <span class="status-dot ${isOnline ? 'online' : 'offline'}"></span>
                                    ${isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿'}
                                </div>
                            </div>
                        </div>
                        <div class="friend-actions">
                            <button class="btn-small btn-chat" onclick="openChat(${friend.user_id}, '${escapeHtml(name)}', false)">èŠå¤©</button>
                        </div>
                    </li>
                `;
            }).join('');
        }
        
        // æœç´¢å¥½å‹
        function searchFriends(keyword) {
            if (!keyword) {
                renderFriends();
                return;
            }
            
            const filtered = friends.filter(friend => {
                const name = (friend.note || friend.nickname || friend.username || '').toLowerCase();
                return name.includes(keyword.toLowerCase());
            });
            
            const list = document.getElementById('friend-list');
            if (filtered.length === 0) {
                list.innerHTML = '<div class="empty-state"><div>æœªæ‰¾åˆ°åŒ¹é…çš„å¥½å‹</div></div>';
                return;
            }
            
            list.innerHTML = filtered.map(friend => {
                const name = friend.note || friend.nickname || friend.username || `ç”¨æˆ·${friend.user_id}`;
                const firstChar = name.charAt(0).toUpperCase();
                const isOnline = friend.is_online || false;
                
                return `
                    <li class="friend-item">
                        <div class="friend-info">
                            <div class="friend-avatar">${escapeHtml(firstChar)}</div>
                            <div class="friend-details">
                                <div class="friend-name">${escapeHtml(name)}</div>
                                <div class="friend-status">
                                    <span class="status-dot ${isOnline ? 'online' : 'offline'}"></span>
                                    ${isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿'}
                                </div>
                            </div>
                        </div>
                        <div class="friend-actions">
                            <button class="btn-small btn-chat" onclick="openChat(${friend.user_id}, '${escapeHtml(name)}', false)">èŠå¤©</button>
                        </div>
                    </li>
                `;
            }).join('');
        }
        
        // æ˜¾ç¤ºæ·»åŠ å¥½å‹æ¨¡æ€æ¡†
        function showAddFriendModal() {
            document.getElementById('add-friend-modal').classList.add('show');
            document.getElementById('friend-search-input').focus();
        }
        
        // å…³é—­æ·»åŠ å¥½å‹æ¨¡æ€æ¡†
        function closeAddFriendModal() {
            document.getElementById('add-friend-modal').classList.remove('show');
            document.getElementById('friend-search-input').value = '';
            document.getElementById('search-results').innerHTML = '<div class="empty-search">è¾“å…¥å…³é”®è¯æœç´¢ç”¨æˆ·</div>';
        }
        
        // å¤„ç†æœç´¢è¾“å…¥
        let friendSearchTimeout = null;
        async function handleSearchInput(event) {
            if (event.key === 'Escape') {
                closeAddFriendModal();
                return;
            }
            
            const keyword = event.target.value.trim();
            
            clearTimeout(friendSearchTimeout);
            friendSearchTimeout = setTimeout(async () => {
                if (keyword.length < 1) {
                    document.getElementById('search-results').innerHTML = '<div class="empty-search">è¾“å…¥å…³é”®è¯æœç´¢ç”¨æˆ·</div>';
                    return;
                }
                
                await searchUsers(keyword);
            }, 500);
        }
        
        // æœç´¢ç”¨æˆ·
        async function searchUsers(keyword) {
            const resultsContainer = document.getElementById('search-results');
            try {
                const token = getToken();
                resultsContainer.innerHTML = '<div class="empty-search">æœç´¢ä¸­...</div>';
                
                const response = await fetch(`${API_BASE}/friends/search?keyword=${encodeURIComponent(keyword)}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('æœç´¢ç”¨æˆ·å¤±è´¥');
                }
                
                const users = await response.json();
                renderSearchResults(users);
            } catch (error) {
                console.error('æœç´¢ç”¨æˆ·å¤±è´¥:', error);
                resultsContainer.innerHTML = `<div class="empty-search" style="color: #e74c3c;">æœç´¢å¤±è´¥ï¼š${escapeHtml(error.message)}</div>`;
            }
        }
        
        // æ¸²æŸ“æœç´¢ç»“æœ
        function renderSearchResults(users) {
            const container = document.getElementById('search-results');
            
            if (users.length === 0) {
                container.innerHTML = '<div class="empty-search">æœªæ‰¾åˆ°åŒ¹é…çš„ç”¨æˆ·</div>';
                return;
            }
            
            container.innerHTML = users.map(user => {
                let actionBtn = '';
                if (user.status === 'none') {
                    actionBtn = `<button class="btn-small btn-add" onclick="addFriend(${user.user_id})">æ·»åŠ </button>`;
                } else if (user.status === 'pending') {
                    actionBtn = `<button class="btn-small btn-pending" disabled>å¾…ç¡®è®¤</button>`;
                } else if (user.status === 'accepted') {
                    actionBtn = `<button class="btn-small btn-accepted" disabled>å·²æ˜¯å¥½å‹</button>`;
                } else if (user.status === 'blocked') {
                    actionBtn = `<button class="btn-small" disabled>å·²å±è”½</button>`;
                }
                
                return `
                    <div class="user-item">
                        <div class="user-info">
                            <div class="user-name">
                                <span class="user-status ${user.is_online ? 'online' : 'offline'}"></span>
                                ${escapeHtml(user.nickname || user.username || `ç”¨æˆ·${user.user_id}`)}
                            </div>
                            <div class="user-meta">
                                ${user.username ? `@${escapeHtml(user.username)}` : ''}
                                ${user.is_online ? '<span style="color: #28a745;">åœ¨çº¿</span>' : '<span style="color: #999;">ç¦»çº¿</span>'}
                            </div>
                        </div>
                        <div class="user-actions">
                            ${actionBtn}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // æ·»åŠ å¥½å‹
        async function addFriend(friendId) {
            try {
                const token = getToken();
                const response = await fetch(`${API_BASE}/friends/add`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ friend_id: friendId })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'æ·»åŠ å¥½å‹å¤±è´¥');
                }
                
                const result = await response.json();
                alert(result.message || 'å¥½å‹è¯·æ±‚å·²å‘é€');
                
                // é‡æ–°æœç´¢ä»¥æ›´æ–°çŠ¶æ€
                const keyword = document.getElementById('friend-search-input').value.trim();
                if (keyword) {
                    await searchUsers(keyword);
                }
                
                // åˆ·æ–°å¥½å‹åˆ—è¡¨
                await loadFriends();
            } catch (error) {
                console.error('æ·»åŠ å¥½å‹å¤±è´¥:', error);
                alert(error.message || 'æ·»åŠ å¥½å‹å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // æ˜¾ç¤ºä¿®æ”¹å¯†ç æ¨¡æ€æ¡†
        function showChangePasswordModal() {
            document.getElementById('change-password-modal').classList.add('show');
        }
        
        // å…³é—­ä¿®æ”¹å¯†ç æ¨¡æ€æ¡†
        function closeChangePasswordModal() {
            document.getElementById('change-password-modal').classList.remove('show');
            document.getElementById('change-password-form').reset();
        }
        
        // ä¿®æ”¹å¯†ç è¡¨å•æäº¤
        document.getElementById('change-password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const oldPassword = document.getElementById('old-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            if (newPassword !== confirmPassword) {
                alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('æ–°å¯†ç é•¿åº¦è‡³å°‘6ä½');
                return;
            }
            
            try {
                const token = getToken();
                const response = await fetch(`${API_BASE}/users/me/change-password`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        old_password: oldPassword,
                        new_password: newPassword
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'ä¿®æ”¹å¯†ç å¤±è´¥');
                }
                
                alert('å¯†ç ä¿®æ”¹æˆåŠŸ');
                closeChangePasswordModal();
            } catch (error) {
                console.error('ä¿®æ”¹å¯†ç å¤±è´¥:', error);
                alert(error.message || 'ä¿®æ”¹å¯†ç å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        });
        
        // é€€å‡ºç™»å½•
        async function logout() {
            if (!confirm('ç¡®å®šè¦é€€å‡ºè´¦æˆ·å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const token = getToken();
                await fetch(`${API_BASE}/auth/logout`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
            } catch (error) {
                console.error('é€€å‡ºå¤±è´¥:', error);
            }
            
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            window.location.href = '/login';
        }
        
        // å¤„ç†æ–°æ¶ˆæ¯
        function handleNewMessage(data) {
            console.log('æ”¶åˆ°æ–°æ¶ˆæ¯:', data);
            
            // ç»Ÿä¸€æ¶ˆæ¯æ ¼å¼ï¼šå…¼å®¹ from_user_id å’Œ sender_id
            const senderId = data.from_user_id || data.sender_id;
            const receiverId = data.receiver_id;
            const roomId = data.room_id;
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰èŠå¤©çª—å£çš„æ¶ˆæ¯
            if (currentChat) {
                let isCurrentChatMessage = false;
                
                if (currentChat.isRoom) {
                    // æˆ¿é—´æ¶ˆæ¯ï¼šæ£€æŸ¥ room_id
                    isCurrentChatMessage = roomId === currentChat.id;
                } else {
                    // ç‚¹å¯¹ç‚¹æ¶ˆæ¯ï¼š
                    // æƒ…å†µ1ï¼šå¯¹æ–¹å‘é€ç»™æˆ‘çš„æ¶ˆæ¯ï¼ˆsenderId === currentChat.id ä¸” receiverId === currentUser.idï¼‰
                    // æƒ…å†µ2ï¼šæˆ‘å‘é€ç»™å¯¹æ–¹çš„æ¶ˆæ¯ï¼ˆsenderId === currentUser.id ä¸” receiverId === currentChat.idï¼‰
                    const isFromOtherUser = senderId === currentChat.id && receiverId === currentUser.id;
                    const isFromMe = senderId === currentUser.id && receiverId === currentChat.id;
                    
                    isCurrentChatMessage = (isFromOtherUser || isFromMe) && !roomId;
                }
                
                if (isCurrentChatMessage) {
                    console.log('âœ“ æ¶ˆæ¯å±äºå½“å‰èŠå¤©çª—å£ï¼Œé‡æ–°åŠ è½½æ¶ˆæ¯');
                    // é‡æ–°åŠ è½½æ¶ˆæ¯
                    loadChatMessages();
                } else {
                    console.log('æ¶ˆæ¯ä¸å±äºå½“å‰èŠå¤©çª—å£ï¼Œè·³è¿‡æ˜¾ç¤ºã€‚å‘é€è€…:', senderId, 'æ¥æ”¶è€…:', receiverId, 'å½“å‰èŠå¤©ID:', currentChat.id);
                }
            } else {
                console.log('å½“å‰æ²¡æœ‰æ‰“å¼€çš„èŠå¤©çª—å£');
            }
            
            // åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨ï¼ˆæ›´æ–°æœªè¯»æ•°ç­‰ï¼‰
            loadMessages();
        }
        
        // å·¥å…·å‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatTime(timeStr) {
            if (!timeStr) return '';
            const date = new Date(timeStr);
            
            // æ ¼å¼åŒ–ä¸ºï¼š2026/01/31 21:15
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}/${month}/${day} ${hours}:${minutes}`;
        }
        
        // åŠŸèƒ½èœå•å¤„ç†å‡½æ•°
        function selectFromAlbum() {
            if (!currentChat) {
                alert('è¯·å…ˆæ‰“å¼€èŠå¤©çª—å£');
                return;
            }
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.multiple = false;
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    // å°†å›¾ç‰‡è½¬æ¢ä¸º base64
                    const reader = new FileReader();
                    reader.onloadend = async () => {
                        const base64Image = reader.result;
                        
                        const data = {
                            message: base64Image,
                            type: 'image'
                        };
                        
                        if (currentChat.isRoom) {
                            data.room_id = currentChat.id;
                        } else {
                            data.target_user_id = currentChat.id;
                        }
                        
                        if (socket) {
                            socket.emit('send_message', data);
                            setTimeout(() => {
                                loadChatMessages();
                            }, 500);
                        }
                    };
                    
                    reader.readAsDataURL(file);
                } catch (error) {
                    console.error('å‘é€å›¾ç‰‡å¤±è´¥:', error);
                    alert('å‘é€å›¾ç‰‡å¤±è´¥');
                }
            };
            
            input.click();
            
            // å…³é—­åŠŸèƒ½èœå•
            document.getElementById('chat-more-menu').classList.remove('show');
        }
        
        function takePhoto() {
            if (!currentChat) {
                alert('è¯·å…ˆæ‰“å¼€èŠå¤©çª—å£');
                return;
            }
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment'; // ä½¿ç”¨åç½®æ‘„åƒå¤´
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    // å°†å›¾ç‰‡è½¬æ¢ä¸º base64
                    const reader = new FileReader();
                    reader.onloadend = async () => {
                        const base64Image = reader.result;
                        
                        const data = {
                            message: base64Image,
                            type: 'image'
                        };
                        
                        if (currentChat.isRoom) {
                            data.room_id = currentChat.id;
                        } else {
                            data.target_user_id = currentChat.id;
                        }
                        
                        if (socket) {
                            socket.emit('send_message', data);
                            setTimeout(() => {
                                loadChatMessages();
                            }, 500);
                        }
                    };
                    
                    reader.readAsDataURL(file);
                } catch (error) {
                    console.error('å‘é€ç…§ç‰‡å¤±è´¥:', error);
                    alert('å‘é€ç…§ç‰‡å¤±è´¥');
                }
            };
            
            input.click();
            
            // å…³é—­åŠŸèƒ½èœå•
            document.getElementById('chat-more-menu').classList.remove('show');
        }
        
        // SHA256 å“ˆå¸Œå‡½æ•°ï¼ˆç”¨äºç”Ÿæˆç¡®å®šæ€§çš„æˆ¿é—´IDï¼‰
        async function sha256Hash(str) {
            const encoder = new TextEncoder();
            const data = encoder.encode(str);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }
        
        async function startVideoCall() {
            if (!currentChat) {
                alert('è¯·å…ˆæ‰“å¼€èŠå¤©çª—å£');
                return;
            }
            
            // å…³é—­åŠŸèƒ½èœå•
            document.getElementById('chat-more-menu').classList.remove('show');
            
            try {
                const token = getToken();
                if (!token) {
                    alert('è¯·å…ˆç™»å½•');
                    window.location.href = '/login';
                    return;
                }
                
                // ç”Ÿæˆæˆ¿é—´IDï¼ˆåŸºäºå½“å‰èŠå¤©IDï¼Œç¡®ä¿æ¯æ¬¡èŠå¤©ä½¿ç”¨åŒä¸€ä¸ªæˆ¿é—´ï¼‰
                // æˆ¿é—´IDæ ¼å¼å¿…é¡»æ˜¯ r-{8ä½16è¿›åˆ¶}ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨å“ˆå¸Œç”Ÿæˆç¡®å®šæ€§çš„æˆ¿é—´ID
                let roomId;
                if (currentChat.isRoom) {
                    // ç¾¤èŠï¼šåŸºäºæˆ¿é—´IDç”Ÿæˆå“ˆå¸Œ
                    const hash = await sha256Hash(`room-${currentChat.id}`);
                    roomId = `r-${hash.substring(0, 8)}`;
                } else {
                    // ç‚¹å¯¹ç‚¹èŠå¤©ï¼šåŸºäºä¸¤ä¸ªç”¨æˆ·IDç”Ÿæˆå“ˆå¸Œï¼Œç¡®ä¿é¡ºåºä¸€è‡´
                    const userId1 = currentUser.id;
                    const userId2 = currentChat.id;
                    const sortedIds = [userId1, userId2].sort((a, b) => a - b);
                    const hash = await sha256Hash(`chat-${sortedIds[0]}-${sortedIds[1]}`);
                    roomId = `r-${hash.substring(0, 8)}`;
                }
                
                // æˆ¿é—´åç§°
                const roomName = currentChat.isRoom 
                    ? `ç¾¤èŠè§†é¢‘é€šè¯ - ${currentChat.name}`
                    : `ä¸ ${currentChat.name} çš„è§†é¢‘é€šè¯`;
                
                // å…ˆå°è¯•åˆ›å»ºæˆ¿é—´ï¼ˆå¦‚æœå·²å­˜åœ¨ä¼šè¿”å›é”™è¯¯ï¼Œæˆ‘ä»¬å¿½ç•¥ï¼‰
                try {
                    const createResponse = await fetch(`${API_BASE}/rooms/create`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            room_id: roomId,
                            room_name: roomName,
                            max_occupants: 10
                        })
                    });
                    
                    if (!createResponse.ok) {
                        const errorData = await createResponse.json().catch(() => ({ detail: '' }));
                        // å¦‚æœæˆ¿é—´å·²å­˜åœ¨ï¼Œè¿™æ˜¯æ­£å¸¸çš„ï¼Œç»§ç»­åŠ å…¥
                        if (!errorData.detail || !errorData.detail.includes('å·²å­˜åœ¨')) {
                            console.log('åˆ›å»ºæˆ¿é—´å¤±è´¥ï¼Œå°è¯•åŠ å…¥ç°æœ‰æˆ¿é—´:', errorData.detail || '');
                        }
                    }
                } catch (e) {
                    // ç½‘ç»œé”™è¯¯æˆ–å…¶ä»–é”™è¯¯ï¼Œç»§ç»­å°è¯•åŠ å…¥ï¼ˆæˆ¿é—´å¯èƒ½å·²å­˜åœ¨ï¼‰
                    console.log('åˆ›å»ºæˆ¿é—´æ—¶å‡ºé”™ï¼Œç»§ç»­å°è¯•åŠ å…¥:', e.message);
                }
                
                // åŠ å…¥æˆ¿é—´è·å– JWT token
                const joinResponse = await fetch(`${API_BASE}/rooms/${roomId}/join`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        display_name: currentUser.nickname || currentUser.username || 'ç”¨æˆ·'
                    })
                });
                
                if (!joinResponse.ok) {
                    const errorData = await joinResponse.json().catch(() => ({ detail: 'åŠ å…¥æˆ¿é—´å¤±è´¥' }));
                    throw new Error(errorData.detail || 'åŠ å…¥æˆ¿é—´å¤±è´¥');
                }
                
                const joinData = await joinResponse.json();
                
                // æ„å»ºæˆ¿é—´ URL
                const roomPageUrl = joinData.room_url || 
                    `/room/${joinData.room_id}?jwt=${encodeURIComponent(joinData.jitsi_token)}&server=${encodeURIComponent(joinData.jitsi_server_url)}`;
                
                // å‘å¯¹æ–¹å‘é€é€šè¯é‚€è¯·ï¼ˆä»…ç‚¹å¯¹ç‚¹èŠå¤©ï¼‰
                if (!currentChat.isRoom) {
                    if (!socket) {
                        console.error('Socket.io æœªåˆå§‹åŒ–ï¼Œæ— æ³•å‘é€é€šè¯é‚€è¯·');
                        alert('Socket.io æœªåˆå§‹åŒ–ï¼Œé€šè¯é‚€è¯·å¯èƒ½æ— æ³•å‘é€');
                    } else if (!socket.connected) {
                        console.error('Socket.io è¿æ¥æœªå»ºç«‹ï¼Œæ— æ³•å‘é€é€šè¯é‚€è¯·');
                        alert('Socket.io è¿æ¥æœªå»ºç«‹ï¼Œé€šè¯é‚€è¯·å¯èƒ½æ— æ³•å‘é€ã€‚è¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
                    } else {
                        const invitationData = {
                            target_user_id: currentChat.id,
                            room_id: roomId,
                            room_url: roomPageUrl,
                            jitsi_token: joinData.jitsi_token,
                            jitsi_server_url: joinData.jitsi_server_url,
                            caller_name: currentUser.nickname || currentUser.username || 'ç”¨æˆ·'
                        };
                        
                        console.log('å‘é€é€šè¯é‚€è¯·:', invitationData);
                        
                        try {
                            console.log('å‡†å¤‡å‘é€é€šè¯é‚€è¯·ï¼Œç›®æ ‡ç”¨æˆ·ID:', currentChat.id);
                            console.log('å½“å‰Socketè¿æ¥çŠ¶æ€:', socket.connected);
                            console.log('å½“å‰ç”¨æˆ·ID:', currentUser.id);
                            
                            socket.emit('call_invitation', invitationData);
                            console.log('âœ“ é€šè¯é‚€è¯·äº‹ä»¶å·²å‘é€åˆ°æœåŠ¡å™¨');
                            
                            // è®¾ç½®è¶…æ—¶æ£€æŸ¥ï¼Œå¦‚æœ5ç§’å†…æ²¡æœ‰æ”¶åˆ°ç¡®è®¤ï¼Œæç¤ºç”¨æˆ·
                            const timeoutId = setTimeout(() => {
                                console.warn('âš  5ç§’å†…æœªæ”¶åˆ°æœåŠ¡å™¨ç¡®è®¤ï¼Œé‚€è¯·å¯èƒ½æœªé€è¾¾');
                            }, 5000);
                            
                            // ç›‘å¬ç¡®è®¤ï¼Œæ”¶åˆ°åæ¸…é™¤è¶…æ—¶
                            const confirmHandler = (data) => {
                                clearTimeout(timeoutId);
                                console.log('âœ“ æ”¶åˆ°æœåŠ¡å™¨ç¡®è®¤:', data);
                                socket.off('call_invitation_sent', confirmHandler);
                            };
                            
                            socket.on('call_invitation_sent', confirmHandler);
                            
                            // ç›‘å¬é”™è¯¯
                            const errorHandler = (error) => {
                                clearTimeout(timeoutId);
                                console.error('âœ— æ”¶åˆ°æœåŠ¡å™¨é”™è¯¯:', error);
                                alert('å‘é€é€šè¯é‚€è¯·å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
                                socket.off('error', errorHandler);
                            };
                            
                            socket.once('error', errorHandler);
                            
                        } catch (error) {
                            console.error('âœ— å‘é€é€šè¯é‚€è¯·äº‹ä»¶å¤±è´¥:', error);
                            alert('å‘é€é€šè¯é‚€è¯·å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
                        }
                    }
                }
                
                // åœ¨æ–°çª—å£æ‰“å¼€è§†é¢‘é€šè¯æˆ¿é—´
                window.open(roomPageUrl, '_blank', 'width=1200,height=800');
                
            } catch (error) {
                console.error('å¯åŠ¨è§†é¢‘é€šè¯å¤±è´¥:', error);
                alert('å¯åŠ¨è§†é¢‘é€šè¯å¤±è´¥: ' + (error.message || 'ç½‘ç»œé”™è¯¯'));
            }
        }
        
        function selectFile() {
            if (!currentChat) {
                alert('è¯·å…ˆæ‰“å¼€èŠå¤©çª—å£');
                return;
            }
            
            const input = document.createElement('input');
            input.type = 'file';
            input.multiple = false;
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    // å°†æ–‡ä»¶è½¬æ¢ä¸º base64
                    const reader = new FileReader();
                    reader.onloadend = async () => {
                        const base64File = reader.result;
                        
                        const data = {
                            message: base64File,
                            type: 'file',
                            file_name: file.name,
                            file_size: file.size,
                            file_type: file.type
                        };
                        
                        if (currentChat.isRoom) {
                            data.room_id = currentChat.id;
                        } else {
                            data.target_user_id = currentChat.id;
                        }
                        
                        if (socket) {
                            socket.emit('send_message', data);
                            setTimeout(() => {
                                loadChatMessages();
                            }, 500);
                        }
                    };
                    
                    reader.readAsDataURL(file);
                } catch (error) {
                    console.error('å‘é€æ–‡ä»¶å¤±è´¥:', error);
                    alert('å‘é€æ–‡ä»¶å¤±è´¥');
                }
            };
            
            input.click();
            
            // å…³é—­åŠŸèƒ½èœå•
            document.getElementById('chat-more-menu').classList.remove('show');
        }
        
        // é€šè¯é‚€è¯·ç›¸å…³å˜é‡
        let currentCallInvitation = null;
        
        // æ˜¾ç¤ºé€šè¯é‚€è¯·å¼¹çª—
        function showCallInvitation(data) {
            console.log('=== showCallInvitation å¼€å§‹æ‰§è¡Œ ===');
            console.log('æ¥æ”¶åˆ°çš„æ•°æ®:', data);
            
            if (!data) {
                console.error('showCallInvitation: æ•°æ®ä¸ºç©º');
                return;
            }
            
            // ä¿å­˜é‚€è¯·æ•°æ®
            currentCallInvitation = data;
            console.log('é‚€è¯·æ•°æ®å·²ä¿å­˜åˆ° currentCallInvitation');
            
            // è·å– DOM å…ƒç´ 
            const modal = document.getElementById('call-invitation-modal');
            const title = document.getElementById('call-invitation-title');
            const message = document.getElementById('call-invitation-message');
            
            console.log('DOM å…ƒç´ æ£€æŸ¥:');
            console.log('  - modal:', modal ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°');
            console.log('  - title:', title ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°');
            console.log('  - message:', message ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°');
            
            if (!modal) {
                console.error('showCallInvitation: æ‰¾ä¸åˆ°å¼¹çª—å…ƒç´  #call-invitation-modal');
                alert('æ‰¾ä¸åˆ°é‚€è¯·å¼¹çª—å…ƒç´ ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }
            
            if (!title) {
                console.error('showCallInvitation: æ‰¾ä¸åˆ°æ ‡é¢˜å…ƒç´  #call-invitation-title');
                return;
            }
            
            // æ›´æ–°é‚€è¯·ä¿¡æ¯
            const callerName = data.caller_name || 'å¯¹æ–¹';
            title.textContent = `${callerName}é‚€è¯·æ‚¨è¿›å…¥é€šè¯`;
            console.log('æ ‡é¢˜å·²æ›´æ–°:', title.textContent);
            
            // ç¡®ä¿æ¶ˆæ¯æ–‡æœ¬æ­£ç¡®
            if (message) {
                message.textContent = 'å¯¹æ–¹é‚€è¯·æ‚¨è¿›å…¥é€šè¯ä¼šè®®ï¼Œå¯å…±äº«å±å¹•';
            }
            
            // æ˜¾ç¤ºå¼¹çª—
            console.log('æ˜¾ç¤ºå¼¹çª—å‰çš„çŠ¶æ€:');
            console.log('  - modal.style.display:', modal.style.display);
            console.log('  - modal.classList:', Array.from(modal.classList));
            
            modal.classList.add('show');
            
            console.log('æ˜¾ç¤ºå¼¹çª—åçš„çŠ¶æ€:');
            console.log('  - modal.classList:', Array.from(modal.classList));
            console.log('  - æ˜¯å¦åŒ…å« show:', modal.classList.contains('show'));
            
            // å¼ºåˆ¶è®¾ç½®æ˜¾ç¤ºï¼ˆå¦‚æœ CSS ç±»æ²¡æœ‰ç”Ÿæ•ˆï¼‰
            if (!modal.classList.contains('show')) {
                console.warn('CSS ç±»æ·»åŠ å¤±è´¥ï¼Œå¼ºåˆ¶è®¾ç½® display');
                modal.style.display = 'flex';
            } else {
                // ç¡®ä¿æ ·å¼æ­£ç¡®åº”ç”¨
                const computedStyle = window.getComputedStyle(modal);
                console.log('è®¡ç®—åçš„æ ·å¼:');
                console.log('  - display:', computedStyle.display);
                console.log('  - visibility:', computedStyle.visibility);
                console.log('  - opacity:', computedStyle.opacity);
                
                if (computedStyle.display === 'none') {
                    console.warn('è®¡ç®—åçš„ display ä»ä¸º noneï¼Œå¼ºåˆ¶è®¾ç½®ä¸º flex');
                    modal.style.display = 'flex';
                }
            }
            
            console.log('=== showCallInvitation æ‰§è¡Œå®Œæˆ ===');
        }
        
        // æ¥å—é€šè¯é‚€è¯·
        async function acceptCallInvitation() {
            if (!currentCallInvitation) {
                return;
            }
            
            const invitation = currentCallInvitation;
            currentCallInvitation = null;
            
            // å…³é—­å¼¹çª—
            document.getElementById('call-invitation-modal').classList.remove('show');
            
            try {
                const token = getToken();
                if (!token) {
                    alert('è¯·å…ˆç™»å½•');
                    window.location.href = '/login';
                    return;
                }
                
                // å¦‚æœå·²ç»æœ‰æˆ¿é—´URLï¼Œç›´æ¥è·³è½¬
                if (invitation.room_url) {
                    window.open(invitation.room_url, '_blank', 'width=1200,height=800');
                    return;
                }
                
                // å¦åˆ™ï¼ŒåŠ å…¥æˆ¿é—´è·å–JWT token
                const joinResponse = await fetch(`${API_BASE}/rooms/${invitation.room_id}/join`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        display_name: currentUser.nickname || currentUser.username || 'ç”¨æˆ·'
                    })
                });
                
                if (!joinResponse.ok) {
                    const errorData = await joinResponse.json().catch(() => ({ detail: 'åŠ å…¥æˆ¿é—´å¤±è´¥' }));
                    throw new Error(errorData.detail || 'åŠ å…¥æˆ¿é—´å¤±è´¥');
                }
                
                const joinData = await joinResponse.json();
                
                // æ„å»ºæˆ¿é—´ URL
                const roomPageUrl = joinData.room_url || 
                    `/room/${joinData.room_id}?jwt=${encodeURIComponent(joinData.jitsi_token)}&server=${encodeURIComponent(joinData.jitsi_server_url)}`;
                
                // åœ¨æ–°çª—å£æ‰“å¼€è§†é¢‘é€šè¯æˆ¿é—´
                window.open(roomPageUrl, '_blank', 'width=1200,height=800');
                
            } catch (error) {
                console.error('æ¥å—é€šè¯é‚€è¯·å¤±è´¥:', error);
                alert('æ¥å—é€šè¯é‚€è¯·å¤±è´¥: ' + (error.message || 'ç½‘ç»œé”™è¯¯'));
            }
        }
        
        // æ‹’ç»é€šè¯é‚€è¯·
        function rejectCallInvitation() {
            const invitation = currentCallInvitation;
            currentCallInvitation = null;
            document.getElementById('call-invitation-modal').classList.remove('show');
            
            // å¯é€‰ï¼šé€šçŸ¥å¯¹æ–¹å·²æ‹’ç»ï¼ˆå¦‚æœéœ€è¦ï¼‰
            if (socket && invitation) {
                socket.emit('call_invitation_response', {
                    room_id: invitation.room_id,
                    accepted: false
                });
            }
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modals = ['add-friend-modal', 'change-password-modal', 'call-invitation-modal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    if (modalId === 'add-friend-modal') {
                        closeAddFriendModal();
                    } else if (modalId === 'change-password-modal') {
                        closeChangePasswordModal();
                    } else if (modalId === 'call-invitation-modal') {
                        rejectCallInvitation();
                    }
                }
            });
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
