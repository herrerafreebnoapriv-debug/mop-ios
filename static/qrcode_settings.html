<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>æ‰«ç è®¾ç½® - MOP</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico?v=20260112">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            display: flex;
        }
        .sidebar {
            width: 147px;
            min-width: 147px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.08);
        }
        .sidebar-title { padding: 0 12px 12px; font-size: 12px; color: rgba(255,255,255,0.7); }
        .sidebar-menu-item {
            display: flex; align-items: center; gap: 8px;
            padding: 10px 12px; cursor: pointer; transition: background 0.2s;
            color: white; text-decoration: none; font-size: 13px;
        }
        .sidebar-menu-item:hover { background: rgba(255,255,255,0.15); }
        .sidebar-menu-item.active { background: rgba(255,255,255,0.25); font-weight: 600; }
        .sidebar-menu-item-icon { font-size: 1em; }
        .main { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        .main-header {
            background: white; padding: 20px 24px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }
        .main-title { font-size: 1.4em; color: #333; }
        .main-body { flex: 1; padding: 24px; overflow-x: auto; }
        .message { padding: 12px 20px; border-radius: 6px; margin-bottom: 16px; display: none; }
        .message-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .message-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .cards-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            align-items: start;
        }
        .cards-row.auth-only { grid-template-columns: 1fr; }
        @media (max-width: 900px) { .cards-row, .cards-row.auth-only { grid-template-columns: 1fr; } }
        .card {
            background: white; border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            padding: 24px; margin-bottom: 0;
        }
        .card h2 { font-size: 1.2em; margin-bottom: 16px; color: #333; display: flex; align-items: center; gap: 8px; }
        .btn { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-size: 14px; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-cancel { background: #e0e0e0; color: #333; }
        .btn-confirm { background: #667eea; color: white; }
        .modal-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.5); z-index: 1000;
            align-items: center; justify-content: center;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: white; border-radius: 12px; padding: 24px;
            width: 90%; max-width: 400px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .modal h3 { margin-bottom: 16px; color: #333; }
        .modal .form-group { margin-bottom: 14px; }
        .modal label { display: block; margin-bottom: 6px; font-size: 14px; color: #555; }
        .modal input { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .modal-actions { margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end; }
        .modal-actions .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 14px; }
        #auth-qr-wrap { text-align: center; padding: 24px; min-height: 200px; }
        #auth-qr-wrap img { max-width: 256px; height: auto; border: 1px solid #eee; border-radius: 8px; }
        #auth-qr-hint { font-size: 13px; color: #666; margin-top: 12px; }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-title">å·¦ä¾§èœå•</div>
        <a href="/static/dashboard.html" class="sidebar-menu-item"><span class="sidebar-menu-item-icon">ğŸ‘¤</span>ç”¨æˆ·ä¿¡æ¯</a>
        <a href="#" class="sidebar-menu-item" id="menu-change-pwd"><span class="sidebar-menu-item-icon">ğŸ”‘</span>ä¿®æ”¹å¯†ç </a>
        <a href="/static/devices.html" class="sidebar-menu-item"><span class="sidebar-menu-item-icon">ğŸ“±</span>è®¾å¤‡ç®¡ç†</a>
        <a href="/static/user_management.html" class="sidebar-menu-item"><span class="sidebar-menu-item-icon">ğŸ‘¥</span>ç”¨æˆ·ç®¡ç†</a>
        <a href="/static/invitation_management.html" class="sidebar-menu-item"><span class="sidebar-menu-item-icon">ğŸ«</span>é‚€è¯·ç ç®¡ç†</a>
        <a href="/static/qrcode_settings.html" class="sidebar-menu-item active"><span class="sidebar-menu-item-icon">âš™ï¸</span>æ‰«ç é…ç½®</a>
    </aside>
    <div class="main">
        <header class="main-header">
            <h1 class="main-title">æ‰«ç è®¾ç½®</h1>
        </header>
        <div class="main-body">
            <div id="messages"></div>

            <div class="cards-row auth-only">
                <!-- æ‰«ç é…ç½®ï¼ˆä»…è¶…çº§ç®¡ç†å‘˜ï¼‰ -->
                <div class="card" id="qrcode-config-card" style="display: none;">
                    <h2><span>âš™ï¸</span> æ‰«ç é…ç½®</h2>
                    <button class="btn btn-primary" onclick="loadQRCodeConfigs()" style="margin-bottom: 12px;">åˆ·æ–°é…ç½®</button>
                    <div id="qrcode-configs-list" style="max-height: 400px; overflow-y: auto; background: #f8f9fa; border-radius: 6px; padding: 10px;">
                        <p style="color: #999; text-align: center; padding: 10px; font-size: 12px;">ç‚¹å‡»ã€Œåˆ·æ–°é…ç½®ã€åŠ è½½</p>
                    </div>
                </div>

                <!-- ç”ŸæˆäºŒç»´ç ï¼šç”¨äºå®¢æˆ·ç«¯æ‰«ç æˆæƒ -->
                <div class="card">
                    <h2><span>ğŸ“±</span> ç”ŸæˆäºŒç»´ç ï¼ˆç”¨äºå®¢æˆ·ç«¯æ‰«ç æˆæƒï¼‰</h2>
                    <p id="auth-qr-desc" style="color: #666; font-size: 14px; margin-bottom: 16px;">æ‰‹æœºAPPé¦–æ¬¡ä½¿ç”¨äºŒç»´ç æˆæƒæ‰èƒ½ç™»å½•</p>
                    <div id="auth-qr-wrap">
                        <button class="btn btn-primary" onclick="generateAuthQR()">ç”ŸæˆæˆæƒäºŒç»´ç </button>
                    </div>
                    <p id="auth-qr-hint" style="display: none;">äºŒç»´ç  5 åˆ†é’Ÿå†…æœ‰æ•ˆï¼Œè¯·ä½¿ç”¨å®¢æˆ·ç«¯æ‰«æã€‚</p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-change-pwd">
        <div class="modal">
            <h3>ä¿®æ”¹å¯†ç </h3>
            <div class="form-group">
                <label>æ—§å¯†ç </label>
                <input type="password" id="pwd-old" placeholder="è¯·è¾“å…¥æ—§å¯†ç ">
            </div>
            <div class="form-group">
                <label>æ–°å¯†ç </label>
                <input type="password" id="pwd-new" placeholder="è‡³å°‘6ä½">
            </div>
            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="closeChangePwdModal()">å–æ¶ˆ</button>
                <button class="btn btn-confirm" onclick="submitChangePwd()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <script>
        function getApiBase() {
            const h = window.location.hostname, p = window.location.protocol;
            if (h === 'www.chat5202ol.xyz' || h === 'chat5202ol.xyz' || h === 'app.chat5202ol.xyz') return 'https://api.chat5202ol.xyz/api/v1';
            if (h === 'api.chat5202ol.xyz') return p + '//' + h + '/api/v1';
            return '/api/v1';
        }
        const API_BASE = getApiBase();
        let currentUser = null;
        let authQrObjectUrl = null;

        function getToken() { return localStorage.getItem('access_token'); }

        async function apiRequest(url, options = {}) {
            const token = getToken();
            if (!token) {
                showMessage('æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•', 'error');
                setTimeout(() => { window.location.href = '/login'; }, 2000);
                throw new Error('æœªç™»å½•');
            }
            options.headers = options.headers || {};
            options.headers['Authorization'] = 'Bearer ' + token;
            if (options.body && !options.headers['Content-Type']) options.headers['Content-Type'] = 'application/json';
            options.credentials = options.credentials || 'include';
            const res = await fetch(url, options);
            if (res.status === 401) {
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                showMessage('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                setTimeout(() => { window.location.href = '/login'; }, 2000);
                throw new Error('ç™»å½•å·²è¿‡æœŸ');
            }
            return res;
        }

        function showMessage(text, type) {
            const el = document.getElementById('messages');
            const m = document.createElement('div');
            m.className = 'message message-' + type;
            m.textContent = text;
            m.style.display = 'block';
            el.appendChild(m);
            setTimeout(() => { m.style.opacity = '0'; m.style.transition = 'opacity 0.3s'; setTimeout(() => m.remove(), 300); }, 5000);
        }

        async function loadUserInfo() {
            try {
                const token = getToken();
                if (!token) { showMessage('æœªç™»å½•', 'error'); setTimeout(() => { window.location.href = '/login'; }, 2000); return; }
                const res = await fetch(API_BASE + '/auth/me', {
                    headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                    credentials: 'include'
                });
                if (!res.ok) {
                    if (res.status === 401) { localStorage.removeItem('access_token'); showMessage('ç™»å½•å·²è¿‡æœŸ', 'error'); setTimeout(() => { window.location.href = '/login'; }, 2000); return; }
                    throw new Error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
                }
                currentUser = await res.json();
                const isSuperAdmin = currentUser && currentUser.role === 'super_admin';
                const qc = document.getElementById('qrcode-config-card');
                const row = document.querySelector('.cards-row');
                if (qc) qc.style.display = isSuperAdmin ? 'block' : 'none';
                if (row) { row.classList.toggle('auth-only', !isSuperAdmin); }
                if (isSuperAdmin) loadQRCodeConfigs();
            } catch (e) {
                console.error(e);
                showMessage('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥', 'error');
            }
        }

        async function generateAuthQR() {
            const wrap = document.getElementById('auth-qr-wrap');
            const hint = document.getElementById('auth-qr-hint');
            if (authQrObjectUrl) { URL.revokeObjectURL(authQrObjectUrl); authQrObjectUrl = null; }
            hint.style.display = 'none';
            wrap.innerHTML = '<p style="color: #999;">ç”Ÿæˆä¸­...</p>';
            try {
                const res = await apiRequest(API_BASE + '/qrcode/auth', { method: 'GET' });
                if (!res.ok) {
                    let errorMsg = 'ç”Ÿæˆå¤±è´¥';
                    try {
                        const errData = await res.json();
                        errorMsg = errData.detail || errData.message || `HTTP ${res.status}`;
                    } catch (parseErr) {
                        errorMsg = `HTTP ${res.status}: ${res.statusText}`;
                    }
                    throw new Error(errorMsg);
                }
                const blob = await res.blob();
                if (!blob || blob.size === 0) throw new Error('è¿”å›çš„å›¾ç‰‡æ•°æ®ä¸ºç©º');
                authQrObjectUrl = URL.createObjectURL(blob);
                wrap.innerHTML = '<img id="auth-qr-img" src="' + authQrObjectUrl + '" alt="æˆæƒäºŒç»´ç "><br><button class="btn btn-primary" onclick="generateAuthQR()" style="margin-top: 12px;">é‡æ–°ç”Ÿæˆ</button>';
                hint.style.display = 'block';
            } catch (e) {
                console.error('ç”ŸæˆæˆæƒäºŒç»´ç å¤±è´¥:', e);
                wrap.innerHTML = '<p style="color: #e74c3c;">ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•</p><button class="btn btn-primary" onclick="generateAuthQR()" style="margin-top: 12px;">é‡è¯•</button>';
                showMessage('ç”Ÿæˆå¤±è´¥: ' + (e.message || 'è¯·é‡è¯•'), 'error');
            }
        }

        async function loadQRCodeConfigs() {
            const isSuperAdmin = currentUser && currentUser.role === 'super_admin';
            if (!isSuperAdmin) { showMessage('ä»…è¶…çº§ç®¡ç†å‘˜å¯ç®¡ç†æ‰«ç é…ç½®', 'error'); return; }
            const list = document.getElementById('qrcode-configs-list');
            if (!list) return;
            list.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">åŠ è½½ä¸­...</div>';
            try {
                const res = await apiRequest(API_BASE + '/admin/system-configs', { method: 'GET' });
                if (!res.ok) throw new Error('è·å–é…ç½®å¤±è´¥');
                const data = await res.json();
                const configs = (data.configs || []).filter(c => c.config_key && c.config_key.startsWith('qrcode.'));
                const names = { 'qrcode.max_scans': 'æœ€å¤§æ‰«ç æ¬¡æ•°', 'qrcode.encrypted_enabled': 'åŠ å¯†æ¨¡å¼', 'qrcode.plain_enabled': 'æ˜æ–‡æ¨¡å¼' };
                const filtered = configs.filter(c => c.config_key !== 'qrcode.plain_max_scans' && c.config_key !== 'qrcode.encrypted_max_scans');
                if (!filtered.length) { list.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">æš‚æ— é…ç½®</p>'; return; }
                list.innerHTML = '<div style="max-height: 400px; overflow-y: auto;">' + filtered.map(c => {
                    const isBool = c.config_key.includes('_enabled');
                    const isNum = c.config_key === 'qrcode.max_scans' || c.config_key.includes('_max_scans');
                    const val = c.config_value || '';
                    const name = names[c.config_key] || c.config_key;
                    return '<div style="padding: 8px; border-bottom: 1px solid #ddd; font-size: 12px;">' +
                        '<strong style="color: #333;">' + name + '</strong>' +
                        (isBool ? '<label style="display:flex;align-items:center;gap:6px;margin-top:6px;cursor:pointer;">' +
                            '<input type="checkbox" ' + (val.toLowerCase() === 'true' ? 'checked' : '') + ' onchange="updateQRCodeConfig(\'' + c.config_key + '\', this.checked ? \'true\' : \'false\')">' +
                            '<span>' + (val.toLowerCase() === 'true' ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨') + '</span></label>' :
                        isNum ? '<div style="display:flex;gap:4px;align-items:center;margin-top:6px;">' +
                            '<input type="number" id="cfg-' + c.config_key + '" value="' + val + '" min="0" style="width:60px;padding:4px;">' +
                            '<button class="btn btn-primary" style="padding:4px 10px;font-size:12px;" onclick="updateQRCodeConfig(\'' + c.config_key + '\', document.getElementById(\'cfg-' + c.config_key + '\').value)">ä¿å­˜</button></div>' +
                            '<span style="font-size:10px;color:#666;">0=ä¸é™åˆ¶</span>' :
                        '<div style="display:flex;gap:6px;margin-top:6px;"><input type="text" id="cfg-' + c.config_key + '" value="' + val + '" style="flex:1;padding:4px 8px;">' +
                            '<button class="btn btn-primary" style="padding:4px 10px;font-size:12px;" onclick="updateQRCodeConfig(\'' + c.config_key + '\', document.getElementById(\'cfg-' + c.config_key + '\').value)">ä¿å­˜</button></div>') +
                        '</div>';
                }).join('') + '</div>';
            } catch (e) {
                console.error(e);
                list.innerHTML = '<p style="color: #e74c3c; text-align: center; padding: 20px;">åŠ è½½å¤±è´¥: ' + (e.message || '') + '</p>';
            }
        }

        async function updateQRCodeConfig(key, value) {
            try {
                const res = await apiRequest(API_BASE + '/admin/system-configs/' + encodeURIComponent(key), {
                    method: 'PUT',
                    body: JSON.stringify({ config_value: value })
                });
                if (!res.ok) throw new Error('æ›´æ–°å¤±è´¥');
                showMessage('å·²ä¿å­˜', 'success');
                loadQRCodeConfigs();
            } catch (e) {
                showMessage('æ›´æ–°å¤±è´¥: ' + (e.message || ''), 'error');
            }
        }

        document.getElementById('menu-change-pwd').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('modal-change-pwd').classList.add('show');
            document.getElementById('pwd-old').value = '';
            document.getElementById('pwd-new').value = '';
        });

        function closeChangePwdModal() { document.getElementById('modal-change-pwd').classList.remove('show'); }

        async function submitChangePwd() {
            const oldP = document.getElementById('pwd-old').value;
            const newP = document.getElementById('pwd-new').value;
            if (!oldP || !newP) { showMessage('è¯·å¡«å†™æ—§å¯†ç å’Œæ–°å¯†ç ', 'error'); return; }
            if (newP.length < 6) { showMessage('æ–°å¯†ç è‡³å°‘6ä½', 'error'); return; }
            try {
                const res = await apiRequest(API_BASE + '/users/me/change-password', {
                    method: 'POST',
                    body: JSON.stringify({ old_password: oldP, new_password: newP })
                });
                if (!res.ok) { const err = await res.json().catch(() => ({})); throw new Error(err.detail || 'ä¿®æ”¹å¤±è´¥'); }
                showMessage('å¯†ç å·²ä¿®æ”¹', 'success');
                closeChangePwdModal();
            } catch (e) { showMessage('ä¿®æ”¹å¯†ç å¤±è´¥: ' + (e.message || e), 'error'); }
        }

        window.addEventListener('DOMContentLoaded', async () => {
            if (!getToken()) {
                showMessage('æœªç™»å½•ï¼Œæ­£åœ¨è·³è½¬...', 'info');
                setTimeout(() => { window.location.href = '/login'; }, 1500);
                return;
            }
            await loadUserInfo();
        });
    </script>
</body>
</html>
