# Socket.io å³æ—¶é€šè®¯åŸŸåæ¶æ„åˆ†æ

## ğŸ“Š å½“å‰æ¶æ„

### ç°æœ‰åŸŸåé…ç½®
- **api.chat5202ol.xyz** - API æœåŠ¡ï¼ˆåŒ…å« Socket.io `/socket.io/`ï¼‰
- **www.chat5202ol.xyz** - PCç«¯ç½‘é¡µç‰ˆ
- **app.chat5202ol.xyz** - ç§»åŠ¨ç«¯åº”ç”¨

### Socket.io é›†æˆæ–¹å¼
- è·¯å¾„ï¼š`/socket.io/`
- é›†æˆåœ¨ä¸» FastAPI åº”ç”¨ä¸­
- ä¸ REST API å…±äº«åŒä¸€åŸŸåå’Œç«¯å£

---

## ğŸ¤” æ˜¯å¦éœ€è¦å•ç‹¬åŸŸåï¼Ÿ

### âŒ **ä¸éœ€è¦å•ç‹¬åŸŸåï¼ˆæ¨èï¼‰**

**ç†ç”±ï¼š**

#### 1. **æ¶æ„ç®€å•**
- âœ… Socket.io ä¸ REST API å…±äº«åŒä¸€åç«¯æœåŠ¡
- âœ… ç»Ÿä¸€è®¤è¯æœºåˆ¶ï¼ˆJWT Tokenï¼‰
- âœ… ç»Ÿä¸€ CORS é…ç½®
- âœ… ç»Ÿä¸€æ—¥å¿—å’Œç›‘æ§

#### 2. **æ€§èƒ½è¶³å¤Ÿ**
- âœ… WebSocket è¿æ¥æœ¬èº«æ˜¯é«˜æ•ˆçš„
- âœ… å½“å‰ç”¨æˆ·è§„æ¨¡ä¸‹ï¼Œå•æœåŠ¡å™¨è¶³å¤Ÿ
- âœ… æ— éœ€é¢å¤–çš„è´Ÿè½½å‡è¡¡å¤æ‚åº¦

#### 3. **è¿ç»´ç®€å•**
- âœ… åªéœ€ç®¡ç†ä¸€ä¸ªåŸŸåå’Œ SSL è¯ä¹¦
- âœ… ç»Ÿä¸€çš„ Nginx é…ç½®
- âœ… ç»Ÿä¸€çš„ç›‘æ§å’Œæ—¥å¿—

#### 4. **æˆæœ¬ä½**
- âœ… æ— éœ€é¢å¤–çš„åŸŸåå’Œè¯ä¹¦
- âœ… æ— éœ€é¢å¤–çš„æœåŠ¡å™¨èµ„æº

#### 5. **ç¬¦åˆå½“å‰æ¶æ„**
- âœ… ä¸ Spec.txt ä¸­çš„"ç«¯-ç½‘-äº‘"æ¶æ„ä¸€è‡´
- âœ… Socket.io ä½œä¸º"å¢å¼ºå‹å³æ—¶é€šè®¯"ï¼Œé›†æˆåœ¨ä¸»åç«¯ä¸­

---

## âš ï¸ ä½•æ—¶éœ€è¦å•ç‹¬åŸŸåï¼Ÿ

### ä»¥ä¸‹æƒ…å†µè€ƒè™‘å•ç‹¬åŸŸåï¼š

#### 1. **å¤§è§„æ¨¡éƒ¨ç½²ï¼ˆ10ä¸‡+ å¹¶å‘è¿æ¥ï¼‰**
- éœ€è¦ç‹¬ç«‹çš„ WebSocket æœåŠ¡å™¨é›†ç¾¤
- éœ€è¦ä¸“é—¨çš„è´Ÿè½½å‡è¡¡
- éœ€è¦ CDN åŠ é€Ÿ

**å½“å‰æƒ…å†µï¼š** âŒ ä¸é€‚ç”¨ï¼ˆç§æœ‰åŒ–éƒ¨ç½²ï¼Œç”¨æˆ·è§„æ¨¡æœ‰é™ï¼‰

#### 2. **å®‰å…¨éš”ç¦»éœ€æ±‚**
- éœ€è¦å°†å³æ—¶é€šè®¯æœåŠ¡å®Œå…¨éš”ç¦»
- éœ€è¦ç‹¬ç«‹çš„é˜²ç«å¢™è§„åˆ™
- éœ€è¦ç‹¬ç«‹çš„ DDoS é˜²æŠ¤

**å½“å‰æƒ…å†µï¼š** âŒ ä¸é€‚ç”¨ï¼ˆå·²æœ‰ JWT è®¤è¯å’Œ CORS ä¿æŠ¤ï¼‰

#### 3. **å¤šç§Ÿæˆ·æ¶æ„**
- ä¸åŒç§Ÿæˆ·ä½¿ç”¨ä¸åŒçš„å³æ—¶é€šè®¯æœåŠ¡
- éœ€è¦åŸŸåçº§åˆ«çš„éš”ç¦»

**å½“å‰æƒ…å†µï¼š** âŒ ä¸é€‚ç”¨ï¼ˆå•ç§Ÿæˆ·ç§æœ‰åŒ–éƒ¨ç½²ï¼‰

#### 4. **åˆè§„è¦æ±‚**
- æŸäº›åœ°åŒºè¦æ±‚å³æ—¶é€šè®¯æœåŠ¡ç‹¬ç«‹éƒ¨ç½²
- éœ€è¦ç‹¬ç«‹çš„å®¡è®¡æ—¥å¿—

**å½“å‰æƒ…å†µï¼š** âŒ ä¸é€‚ç”¨ï¼ˆå·²æœ‰ç»Ÿä¸€æ—¥å¿—ï¼‰

---

## âœ… æ¨èæ–¹æ¡ˆï¼šä½¿ç”¨ç°æœ‰åŸŸå

### æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  api.chat5202ol.xyz                    â”‚
â”‚  (FastAPI + Socket.io)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  /api/v1/*          â†’ REST API          â”‚
â”‚  /socket.io/*       â†’ WebSocket         â”‚
â”‚  /static/*          â†’ é™æ€æ–‡ä»¶          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘                    â†‘
         â”‚                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ www.chat5202ol  â”‚  â”‚ app.chat5202ol   â”‚
â”‚ (PC Web)        â”‚  â”‚ (Mobile Web)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Nginx é…ç½®ç¤ºä¾‹

```nginx
# api.chat5202ol.xyz - API å’Œ Socket.io æœåŠ¡
server {
    listen 443 ssl http2;
    server_name api.chat5202ol.xyz;
    
    ssl_certificate /etc/nginx/certs/fullchain.pem;
    ssl_certificate_key /etc/nginx/certs/privkey.pem;
    
    # REST API
    location /api/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # Socket.io WebSocket
    location /socket.io/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_read_timeout 86400;  # 24å°æ—¶
    }
    
    # é™æ€æ–‡ä»¶
    location /static/ {
        proxy_pass http://127.0.0.1:8000;
    }
}

# www.chat5202ol.xyz - PCç«¯ç½‘é¡µç‰ˆ
server {
    listen 443 ssl http2;
    server_name www.chat5202ol.xyz;
    
    ssl_certificate /etc/nginx/certs/fullchain.pem;
    ssl_certificate_key /etc/nginx/certs/privkey.pem;
    
    # å‰ç«¯é¡µé¢
    root /var/www/mop/static;
    index index.html;
    
    # API ä»£ç†åˆ° api.chat5202ol.xyz
    location /api/ {
        proxy_pass https://api.chat5202ol.xyz;
    }
    
    # Socket.io ä»£ç†åˆ° api.chat5202ol.xyz
    location /socket.io/ {
        proxy_pass https://api.chat5202ol.xyz;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host api.chat5202ol.xyz;
        proxy_read_timeout 86400;
    }
}
```

---

## ğŸ”§ ä¼˜åŒ–å»ºè®®ï¼ˆæ— éœ€å•ç‹¬åŸŸåï¼‰

### 1. **WebSocket è¿æ¥ä¼˜åŒ–**

**å½“å‰é…ç½®ï¼š**
```python
# app/core/socketio.py
sio = socketio.AsyncServer(
    async_mode='asgi',
    cors_allowed_origins=settings.SOCKETIO_CORS_ORIGINS.split(","),
    logger=True,
    engineio_logger=True
)
```

**ä¼˜åŒ–å»ºè®®ï¼š**
- âœ… ä¿æŒå½“å‰é…ç½®
- âœ… ç¡®ä¿ Nginx WebSocket é…ç½®æ­£ç¡®
- âœ… è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´

### 2. **è¿æ¥æ•°é™åˆ¶**

å¦‚æœéœ€è¦é™åˆ¶è¿æ¥æ•°ï¼Œå¯ä»¥åœ¨ Socket.io é…ç½®ä¸­æ·»åŠ ï¼š

```python
sio = socketio.AsyncServer(
    async_mode='asgi',
    cors_allowed_origins=settings.SOCKETIO_CORS_ORIGINS.split(","),
    max_http_buffer_size=1e6,  # 1MB
    ping_timeout=60,
    ping_interval=25,
    logger=True,
    engineio_logger=True
)
```

### 3. **è´Ÿè½½å‡è¡¡ï¼ˆæœªæ¥æ‰©å±•ï¼‰**

å¦‚æœæœªæ¥éœ€è¦æ‰©å±•ï¼Œå¯ä»¥ä½¿ç”¨ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Nginx LB   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”
   â”‚       â”‚
â”Œâ”€â”€â–¼â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”
â”‚ API1â”‚ â”‚ API2â”‚
â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜
```

**æ³¨æ„ï¼š** Socket.io éœ€è¦ sticky sessionï¼ˆä¼šè¯ç²˜æ€§ï¼‰ï¼Œç¡®ä¿åŒä¸€ç”¨æˆ·çš„è¿æ¥æ€»æ˜¯è·¯ç”±åˆ°åŒä¸€æœåŠ¡å™¨ã€‚

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| æ–¹æ¡ˆ | è¿æ¥å»¶è¿Ÿ | è¿ç»´å¤æ‚åº¦ | æˆæœ¬ | æ‰©å±•æ€§ |
|------|---------|-----------|------|--------|
| **å…±äº«åŸŸå** | â­â­â­â­â­ ä½ | â­â­â­â­â­ ç®€å• | â­â­â­â­â­ ä½ | â­â­â­â­ ä¸­ç­‰ |
| **å•ç‹¬åŸŸå** | â­â­â­â­ ä¸­ç­‰ | â­â­â­ å¤æ‚ | â­â­â­ ä¸­ç­‰ | â­â­â­â­â­ é«˜ |

---

## ğŸ¯ æœ€ç»ˆå»ºè®®

### âœ… **ä½¿ç”¨ç°æœ‰åŸŸå `api.chat5202ol.xyz`**

**ç†ç”±ï¼š**
1. âœ… æ¶æ„ç®€å•ï¼Œç¬¦åˆå½“å‰éœ€æ±‚
2. âœ… æ€§èƒ½è¶³å¤Ÿï¼Œæ— éœ€é¢å¤–ä¼˜åŒ–
3. âœ… è¿ç»´ç®€å•ï¼Œç»Ÿä¸€ç®¡ç†
4. âœ… æˆæœ¬ä½ï¼Œæ— éœ€é¢å¤–èµ„æº
5. âœ… ç¬¦åˆ Spec.txt æ¶æ„è®¾è®¡

### ğŸ“ é…ç½®è¦ç‚¹

1. **Nginx WebSocket é…ç½®**
   - ç¡®ä¿ `proxy_set_header Upgrade` å’Œ `Connection` æ­£ç¡®
   - è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ï¼ˆ24å°æ—¶ï¼‰

2. **CORS é…ç½®**
   - åœ¨ `.env` ä¸­é…ç½® `SOCKETIO_CORS_ORIGINS`
   - åŒ…å«æ‰€æœ‰å‰ç«¯åŸŸå

3. **SSL è¯ä¹¦**
   - ä½¿ç”¨ Let's Encrypt å…è´¹è¯ä¹¦
   - ç¡®ä¿ WebSocket è¿æ¥ä½¿ç”¨ WSSï¼ˆå®‰å…¨ï¼‰

4. **ç›‘æ§**
   - ç›‘æ§ WebSocket è¿æ¥æ•°
   - ç›‘æ§æ¶ˆæ¯å‘é€é¢‘ç‡
   - è®¾ç½®å‘Šè­¦é˜ˆå€¼

---

## ğŸ”® æœªæ¥æ‰©å±•æ–¹æ¡ˆ

å¦‚æœæœªæ¥éœ€è¦æ‰©å±•ï¼Œå¯ä»¥è€ƒè™‘ï¼š

### æ–¹æ¡ˆ Aï¼šå­åŸŸååˆ†ç¦»ï¼ˆæ— éœ€æ–°åŸŸåï¼‰
```
ws-api.chat5202ol.xyz  â†’ Socket.io ä¸“ç”¨
api.chat5202ol.xyz     â†’ REST API ä¸“ç”¨
```

### æ–¹æ¡ˆ Bï¼šè·¯å¾„åˆ†ç¦»ï¼ˆæœ€ç®€å•ï¼‰
```
api.chat5202ol.xyz/socket.io/  â†’ Socket.io
api.chat5202ol.xyz/api/v1/     â†’ REST API
```

### æ–¹æ¡ˆ Cï¼šç‹¬ç«‹æœåŠ¡å™¨ï¼ˆå¤§è§„æ¨¡ï¼‰
```
socket.chat5202ol.xyz  â†’ ç‹¬ç«‹çš„ Socket.io æœåŠ¡å™¨é›†ç¾¤
api.chat5202ol.xyz     â†’ REST API æœåŠ¡å™¨
```

---

## ğŸ“Œ æ€»ç»“

**å½“å‰é˜¶æ®µï¼š** âŒ **ä¸éœ€è¦å•ç‹¬åŸŸå**

**æ¨èæ¶æ„ï¼š**
- Socket.io ä¸ REST API å…±äº« `api.chat5202ol.xyz`
- é€šè¿‡è·¯å¾„åŒºåˆ†ï¼š`/socket.io/` å’Œ `/api/v1/`
- ç»Ÿä¸€çš„è®¤è¯ã€CORSã€æ—¥å¿—å’Œç›‘æ§

**æœªæ¥æ‰©å±•ï¼š** å¦‚æœç”¨æˆ·è§„æ¨¡è¾¾åˆ° 10ä¸‡+ å¹¶å‘è¿æ¥ï¼Œå†è€ƒè™‘ç‹¬ç«‹åŸŸåå’ŒæœåŠ¡å™¨é›†ç¾¤ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2026-01-12  
**é€‚ç”¨é¡¹ç›®**: MOP å³æ—¶é€šè®¯æ¶æ„å†³ç­–
