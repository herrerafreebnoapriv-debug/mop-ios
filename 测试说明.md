# API测试说明

## 当前状态

已完成3个API模块的实现：
1. ✅ 用户管理 API (`/api/v1/users`)
2. ✅ 邀请码管理 API (`/api/v1/invitations`)  
3. ✅ 后台管理 API (`/api/v1/admin`)

## 已修复的问题

1. ✅ 密码验证兼容性（支持bcrypt直接哈希和passlib哈希）
2. ✅ JWT token的sub字段类型（字符串转整数）
3. ✅ datetime时区问题（统一使用UTC并移除时区信息）

## 测试步骤

### 步骤1: 启动服务器
**功能**: 启动FastAPI后端服务器，监听8000端口

**命令**:
```bash
python -m uvicorn app.main:app --host 127.0.0.1 --port 8000 --reload
```

**或者使用**:
```bash
start_demo.bat
```

**等待**: 服务器启动需要5-10秒，看到 "Application startup complete" 表示启动成功

---

### 步骤2: 运行测试脚本
**功能**: 自动测试所有新实现的API端点，包括：
- 用户管理API（列表、详情、更新、删除）
- 邀请码管理API（创建、验证、撤回、使用情况）
- 后台管理API（统计、用户管理、设备管理、封杀、地图、消息）

**命令**:
```bash
python scripts/test_new_apis_zh.py
```

**测试流程**:
1. 检查服务器连接
2. 登录管理员账户获取token
3. 测试用户管理API
4. 测试邀请码管理API
5. 测试后台管理API
6. 汇总测试结果

---

## 测试账户

### 管理员账户
- 用户名: `zhanan089`
- 密码: `zn666@`
- 用途: 测试所有管理功能

### 测试用户账户
- 用户名: `zn6666`
- 密码: `zn6666`
- 用途: 测试普通用户功能

---

## 预期结果

如果所有测试通过，应该看到：
```
[通过] 获取用户列表
[通过] 获取用户详情
[通过] 更新用户信息
[通过] 创建邀请码
[通过] 获取邀请码列表
[通过] 验证邀请码
[通过] 获取系统统计
[通过] 管理员获取用户
[通过] 管理员获取设备
[通过] 获取地图打点
[通过] 发送系统消息

[成功] 所有测试通过！
```

---

## 如果测试失败

1. **服务器连接失败**: 确认服务器已启动
2. **登录失败**: 运行 `python scripts/create_test_accounts.py` 创建账户
3. **401未授权**: 检查token是否正确传递
4. **500服务器错误**: 查看服务器窗口的错误日志

---

## 手动测试

也可以访问 Swagger UI 进行手动测试：
```
http://127.0.0.1:8000/docs
```

在Swagger UI中：
1. 点击 `/api/v1/auth/login` 端点
2. 使用管理员账户登录
3. 复制返回的 `access_token`
4. 点击右上角 "Authorize" 按钮
5. 输入 `Bearer <你的token>`
6. 然后可以测试其他需要认证的API
