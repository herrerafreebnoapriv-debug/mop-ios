# 完整测试流程说明

## 📋 测试准备

### 步骤1: 确认数据库运行
**功能**: 确认PostgreSQL和Redis容器正在运行

**命令**:
```bash
docker ps
```

**预期结果**: 应该看到 `mop_postgres` 和 `mop_redis` 两个容器状态为 "Up"

---

### 步骤2: 确认数据库迁移完成
**功能**: 确保数据库表结构是最新的（包括新增的invitation_codes表）

**命令**:
```bash
alembic upgrade head
```

**预期结果**: 显示 "Running upgrade ... -> ..." 表示迁移成功

---

### 步骤3: 确认测试账户存在
**功能**: 确认管理员账户和测试用户账户已创建

**命令**:
```bash
python scripts/create_test_accounts.py
```

**预期结果**: 显示两个账户创建成功或已存在

---

## 🚀 启动服务器

### 步骤4: 启动FastAPI服务器
**功能**: 启动后端API服务器，监听8000端口，支持热重载

**方法1 - 使用批处理文件**:
```bash
start_demo.bat
```

**方法2 - 手动启动**:
```bash
python -m uvicorn app.main:app --host 127.0.0.1 --port 8000 --reload
```

**等待时间**: 服务器启动需要5-15秒

**确认启动成功**: 
- 看到 "Application startup complete" 消息
- 或者访问 http://127.0.0.1:8000/health 返回200状态码

---

## 🧪 运行测试

### 步骤5: 运行完整API测试脚本
**功能**: 自动测试所有已实现的API端点（包括新增模块）

**命令**:
```bash
python scripts/test_all_apis_complete.py
```

**测试内容**:
1. **用户认证测试**:
   - 管理员登录
   - Token 获取

2. **数据载荷API测试**:
   - 切换数据收集开关
   - 上传敏感数据
   - 获取数据载荷列表

3. **二维码API测试**:
   - 生成加密二维码
   - 验证二维码
   - 获取房间二维码

4. **Jitsi房间API测试**:
   - 创建房间
   - 获取房间信息
   - 设置最大人数
   - 加入房间（获取JWT）
   - 获取房间参与者

5. **Socket.io集成信息**:
   - 功能说明
   - 连接地址和认证方式

**预期结果**: 所有测试显示 "✅ [通过]"

### 步骤5.1: 运行原有测试脚本（可选）
**功能**: 测试用户管理、邀请码和后台管理API

**命令**:
```bash
python scripts/test_new_apis_zh.py
```

---

## 📊 测试结果说明

### 如果所有测试通过
```
[成功] 所有测试通过！

提示：
  - 可以访问 http://127.0.0.1:8000/docs 查看完整的API文档
  - 所有API都已集成多语言支持
  - 管理员账户可以访问所有管理功能
```

### 如果部分测试失败

**常见问题**:

1. **服务器连接失败**
   - 检查服务器是否已启动
   - 检查8000端口是否被占用
   - 查看服务器窗口的错误日志

2. **登录失败**
   - 运行 `python scripts/create_test_accounts.py` 重新创建账户
   - 确认账户密码正确

3. **401未授权错误**
   - 检查token是否正确传递
   - 确认服务器已重启（代码修改后需要重启）

4. **500服务器错误**
   - 查看服务器窗口的详细错误信息
   - 检查数据库连接是否正常
   - 确认数据库迁移已运行

---

## 🔍 手动测试（Swagger UI）

### 步骤6: 访问API文档
**功能**: 通过Web界面手动测试API

**地址**: http://127.0.0.1:8000/docs

**使用步骤**:
1. 打开浏览器访问上述地址
2. 找到 `/api/v1/auth/login` 端点
3. 点击 "Try it out"
4. 输入管理员账户信息:
   - username: `zhanan089`
   - password: `zn666@`
5. 点击 "Execute"
6. 复制返回的 `access_token`
7. 点击页面右上角的 "Authorize" 按钮
8. 输入 `Bearer <你的token>`
9. 现在可以测试其他需要认证的API了

---

## 📝 测试检查清单

### 基础检查
- [ ] 数据库容器运行正常
- [ ] 数据库迁移已完成
- [ ] 测试账户已创建
- [ ] 服务器启动成功
- [ ] 健康检查端点返回200

### API功能测试
- [ ] 管理员登录成功
- [ ] 用户管理API测试通过
- [ ] 邀请码管理API测试通过
- [ ] 后台管理API测试通过
- [ ] 数据载荷API测试通过
- [ ] 二维码API测试通过
- [ ] Jitsi房间API测试通过

### Socket.io测试
- [ ] Socket.io连接地址可访问（ws://127.0.0.1:8000/socket.io/）
- [ ] WebSocket连接测试（需要客户端工具）

---

## 💡 提示

- 服务器在新窗口中运行，可以看到实时日志
- 如果修改了代码，服务器会自动重载（--reload模式）
- 所有API都支持多语言，可以通过 `Accept-Language` 请求头切换语言
- 管理员账户可以访问所有管理功能，普通用户只能访问自己的数据
