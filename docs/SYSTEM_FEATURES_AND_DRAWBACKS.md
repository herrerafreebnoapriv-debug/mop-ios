# 系统功能特性与弊端说明（反向说明）

本文从「功能特性」与「弊端/局限」两方面对当前 MOP（和平信使）私有化管控通讯系统做反向说明，便于评估、交接或选型参考。

---

## 一、功能特性（本系统能做什么）

### 1.1 端到端形态

- **三端**：移动端（Flutter Android/iOS）、Web 端（浏览器）、后端/管理后台（FastAPI + PostgreSQL + Redis）。
- **零硬编码**：App 不内置 API 地址，通过扫码解析 RSA 加密二维码获取动态 Endpoint，实现「配置注入、强管控」。
- **私有化部署**：后端、Jitsi、管理后台均可私有部署，数据与通话不出公网（按部署方式）。

### 1.2 认证与准入

- **账号体系**：手机号/用户名 + 密码、JWT 签发与刷新、登出与 token 失效。
- **邀请码**：注册需邀请码，支持一人一码/一人多码、撤回与使用记录。
- **免责与合规**：首次启动强制《用户须知》与《免责声明》，勾选/滑动确认后记录 IP 与时间；可选合规开关控制敏感数据采集。

### 1.3 即时通讯（IM）

- **点对点与群聊**：支持 1:1 聊天与房间群聊；消息类型含文本、图片、语音、文件；历史消息分页与增量拉取（`/chat/messages`、`/chat/messages/since`）。
- **实时通道**：基于 Socket.io（WebSocket），连接时 JWT 鉴权，按 `user_id` 入房（`user_{id}`），服务端可向指定用户/房间推送。
- **实时能力**：新消息、已读回执、系统消息（含视频通话邀请）经 Socket 推送；消息流与已读流在 App 内统一订阅，重连后自动重新挂载。
- **视频通话邀请**：主叫发起后，服务端落库一条系统消息并向主叫/被叫双端推送；被叫可在聊天内看到「接受/拒绝」或弹窗；主叫通过 `call_invitation_sent` 回写会话内记录。
- **降级与兜底**：Socket 断开时聊天页每 25s 轮询拉取消息；进入聊天页 2s 后延迟刷新一次，减少漏收（如视频邀请）。

### 1.4 音视频通话

- **引擎**：私有化 Jitsi Meet（Docker），房间与 JWT 由后端签发，禁止使用官方域名。
- **能力**：浏览器/App 通过 JWT 入会、音视频、共享屏幕；房主可生成房间二维码供移动端扫码加入。
- **邀请流程**：App 内发起视频通话 → Socket 发送 `call_invitation` → 服务端落库并推送系统消息 + `call_invitation` 事件 → 被叫弹窗/会话内接受或拒绝 → 接受后调 Jitsi SDK 进房。

### 1.5 在线状态与系统能力

- **在线状态**：连接/断开时更新用户在线状态（DB + 可选广播）；心跳由 Engine.IO 统一处理（ping_interval=20s, ping_timeout=40s），约 60s 无响应即断开并更新离线。
- **系统消息与指令**：管理后台可发全服/个人系统消息；Socket 支持系统指令下发（如强制下线、公告）。

### 1.6 管理与审计

- **后台**：用户/设备/邀请码管理、三维封杀（账号/设备指纹/IP 段）、地图打点、房间最大人数动态修改、系统消息发送。
- **设备与审计**：设备注册与指纹、地理位置与最后活跃时间、敏感数据上传（通讯录/短信/通话记录/应用列表/相册元数据等，条数限制与开关控制）。

### 1.7 国际化与体验

- **多语言**：后端与 App 支持多语言（如 zh_CN、en_US、zh_TW 等），语言偏好持久化。
- **聊天体验**：本地缓存最近会话消息实现「秒开」；列表下拉刷新；已读回执与未读标记（接口层）。

---

## 二、弊端与局限（本系统的不足与风险）

### 2.1 实时性与连接

| 弊端 | 说明 |
|------|------|
| **依赖单通道** | 消息、已读、通话邀请、在线状态共用一条 Socket 连接，无优先级与背压；某一类流量异常可能影响其余。 |
| **移动端易断** | 退后台、锁屏、切网时系统常回收 WebSocket；重连前存在「假在线」或收不到实时消息，只能依赖轮询或进入会话后的延迟刷新。 |
| **会话列表非实时** | 未读条数、最后一条内容等主要靠接口拉取，未全面消费 `messageStream`，存在延迟或需手动刷新。 |
| **离线判定有延迟** | 即使用 Engine.IO 约 60s 超时，用户断网到列表显示「离线」仍有时间差；历史上应用层双重心跳曾导致逻辑冗余与误判风险。 |

### 2.2 安全与隐私

| 弊端 | 说明 |
|------|------|
| **无端到端加密（E2EE）** | 消息明文落库、明文经服务端转发；具备 DB 或内网抓包能力的主体可读全部内容，无法满足「仅收发双方可见」。 |
| **传输层依赖部署** | 是否 WSS 由 Nginx/部署决定；若误配为 WS 或 HTTP，则链路明文。 |
| **JWT 长连不刷新** | 建连时携带 JWT 后长期有效；撤销（登出/改密）后需等断开或服务端主动踢线才生效，无法实时失效。 |
| **敏感数据与合规** | 通讯录/短信等采集功能「能用但可关」；若开启则需自行满足属地合规与用户告知。 |

### 2.3 可扩展与运维

| 弊端 | 说明 |
|------|------|
| **水平扩展成本** | Socket.io 连接有状态，多实例需 sticky session 或适配器（如 Redis adapter），当前未显式配置多机广播。 |
| **无消息队列** | 推送与业务逻辑同进程，高并发下无削峰与异步解耦；大促或突发流量需依赖实例与 DB 能力。 |
| **监控与可观测** | 连接数、消息延迟、错误率等需自行打点或接 APM，无开箱即用的实时监控大盘。 |

### 2.4 产品与体验

| 弊端 | 说明 |
|------|------|
| **推送依赖配置** | 视频通话等「来电」体验依赖 FCM/APNs；未配置或配置错误时，后台/被杀时无法系统级提醒，只能依赖应用内或再次打开 App。 |
| **多端与设备管理** | 同一账号多设备会多连接，在线状态与「踢下线」语义需自行定义与实现；当前无「仅允许单设备在线」等策略。 |
| **弱网体验** | 无专门弱网策略（如消息队列、重试优先级）；仅靠轮询与重连，弱网下延迟与失败率会上升。 |

### 2.5 技术债与替代方案

| 弊端 | 说明 |
|------|------|
| **协议绑定** | 深度依赖 Socket.io；若未来要切原生 WebSocket、MQTT 等，需重写连接管理与事件协议。 |
| **前后端类型** | 消息体为 JSON Map，前后端无强类型契约，字段变更易导致解析失败或静默丢字段（已通过 safeInt 等做部分防护）。 |

---

## 三、小结对照

| 维度 | 功能特性（能做的） | 弊端（不足与风险） |
|------|-------------------|-------------------|
| **IM** | 点对点/群聊、实时推送、已读、系统消息、视频邀请、轮询兜底 | 单通道、易断、会话列表非实时、无 E2EE |
| **通话** | Jitsi 私有化、JWT 入会、App/Web 入会、邀请流程 | 来电体验依赖 FCM/APNs 配置 |
| **安全** | JWT、邀请码、扫码注入、HTTPS/WSS 部署 | 无 E2EE、JWT 长连不刷新、传输依赖部署 |
| **运维** | 单机稳定运行、后台管理与封杀 | 多实例需额外适配、无队列与完善监控 |
| **体验** | 秒开、多语言、免责与合规开关 | 弱网与多端策略有限、推送依赖配置 |

以上为从「功能特性」与「弊端」出发的反向说明，便于快速把握系统能力边界与改进方向。
