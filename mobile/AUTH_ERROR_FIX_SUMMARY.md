# æ³¨å†Œå’Œç™»å½•é”™è¯¯æç¤ºä¿®å¤æ€»ç»“

**æ—¥æœŸ**: 2026-01-16  
**çŠ¶æ€**: âœ… å·²ä¿®å¤

## ğŸ› é—®é¢˜æè¿°

1. **æ³¨å†Œå¤±è´¥**ï¼šæç¤º"æ³¨å†Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥ä¿¡æ¯"ï¼Œæ²¡æœ‰æ˜¾ç¤ºåç«¯è¿”å›çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯
2. **ç™»å½•å¤±è´¥**ï¼šæç¤º"ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç "ï¼Œæ²¡æœ‰æ˜¾ç¤ºåç«¯è¿”å›çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯

## ğŸ” é—®é¢˜åŸå› 

1. **`ApiService._executeRequest()` æ–¹æ³•**ï¼š
   - åªå¤„ç† `statusCode == 200` çš„æƒ…å†µ
   - å¯¹äºé”™è¯¯å“åº”ï¼ˆ400, 401, 403 ç­‰ï¼‰ï¼Œç›´æ¥è¿”å› `null`
   - æ²¡æœ‰æå–åç«¯è¿”å›çš„é”™è¯¯è¯¦æƒ…ï¼ˆ`detail` å­—æ®µï¼‰

2. **`AuthApiService` çš„é”™è¯¯å¤„ç†**ï¼š
   - `catch` å—ç›´æ¥è¿”å› `null`ï¼Œä¸¢å¤±äº†é”™è¯¯ä¿¡æ¯
   - æ²¡æœ‰å°†å¼‚å¸¸ä¼ é€’ç»™è°ƒç”¨è€…

3. **`AuthProvider` çš„é”™è¯¯å¤„ç†**ï¼š
   - å½“ `result == null` æ—¶ï¼Œæ˜¾ç¤ºé€šç”¨çš„é”™è¯¯æç¤º
   - æ²¡æœ‰æ˜¾ç¤ºåç«¯è¿”å›çš„å…·ä½“é”™è¯¯ä¿¡æ¯

4. **ç™»å½• API æ ¼å¼é—®é¢˜**ï¼š
   - åç«¯ä½¿ç”¨ `OAuth2PasswordRequestForm`ï¼Œéœ€è¦ `application/x-www-form-urlencoded` æ ¼å¼
   - ç§»åŠ¨ç«¯å‘é€çš„æ˜¯ JSON æ ¼å¼ï¼Œå¯èƒ½å¯¼è‡´è¯·æ±‚å¤±è´¥

## âœ… ä¿®å¤å†…å®¹

### 1. ä¿®å¤ `ApiService._executeRequest()` é”™è¯¯å¤„ç†

**ä¿®æ”¹æ–‡ä»¶**: `/opt/mop/mobile/lib/services/api/api_service.dart`

**ä¿®å¤å†…å®¹**:
- æ·»åŠ äº†é”™è¯¯å“åº”å¤„ç†é€»è¾‘
- ä»å“åº”ä¸­æå– `detail`ã€`message` æˆ– `error` å­—æ®µ
- æŠ›å‡ºåŒ…å«è¯¦ç»†é”™è¯¯ä¿¡æ¯çš„å¼‚å¸¸
- å¤„ç† `DioException`ï¼Œæå–ç½‘ç»œé”™è¯¯ä¿¡æ¯

**å…³é”®ä»£ç **:
```dart
// å¤„ç†é”™è¯¯å“åº”
if (response.statusCode != null && response.statusCode! >= 400) {
  String errorMessage = 'è¯·æ±‚å¤±è´¥';
  if (response.data is Map) {
    final errorData = response.data as Map<String, dynamic>;
    // FastAPI é”™è¯¯æ ¼å¼ï¼š{"detail": "é”™è¯¯ä¿¡æ¯"}
    if (errorData.containsKey('detail')) {
      errorMessage = errorData['detail'].toString();
    }
    // ...
  }
  throw Exception(errorMessage);
}
```

### 2. ä¿®å¤ `AuthApiService` é”™è¯¯ä¼ é€’

**ä¿®æ”¹æ–‡ä»¶**: `/opt/mop/mobile/lib/services/api/auth_api_service.dart`

**ä¿®å¤å†…å®¹**:
- `login()` å’Œ `register()` æ–¹æ³•åœ¨ `catch` å—ä¸­ä½¿ç”¨ `rethrow` è€Œä¸æ˜¯è¿”å› `null`
- ç¡®ä¿å¼‚å¸¸èƒ½å¤Ÿä¼ é€’åˆ°è°ƒç”¨è€…

**å…³é”®ä»£ç **:
```dart
} catch (e) {
  // é‡æ–°æŠ›å‡ºå¼‚å¸¸ï¼Œè®©è°ƒç”¨è€…å¯ä»¥è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
  rethrow;
}
```

### 3. ä¿®å¤ `AuthProvider` é”™è¯¯æ˜¾ç¤º

**ä¿®æ”¹æ–‡ä»¶**: `/opt/mop/mobile/lib/providers/auth_provider.dart`

**ä¿®å¤å†…å®¹**:
- åœ¨ `catch` å—ä¸­æå–é”™è¯¯ä¿¡æ¯
- å»æ‰ "Exception: " å‰ç¼€ï¼Œç›´æ¥æ˜¾ç¤ºé”™è¯¯å†…å®¹
- å¦‚æœé”™è¯¯ä¿¡æ¯ä¸ºç©ºï¼Œæ‰æ˜¾ç¤ºé»˜è®¤æç¤º

**å…³é”®ä»£ç **:
```dart
} catch (e) {
  // æå–é”™è¯¯ä¿¡æ¯ï¼ˆå»æ‰ "Exception: " å‰ç¼€ï¼‰
  String errorMsg = e.toString();
  if (errorMsg.startsWith('Exception: ')) {
    errorMsg = errorMsg.substring(11);
  }
  _errorMessage = errorMsg.isNotEmpty ? errorMsg : 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç ';
  // ...
}
```

### 4. ä¿®å¤ç™»å½• API è¯·æ±‚æ ¼å¼

**ä¿®æ”¹æ–‡ä»¶**: 
- `/opt/mop/mobile/lib/services/api/api_service.dart`
- `/opt/mop/mobile/lib/services/api/auth_api_service.dart`

**ä¿®å¤å†…å®¹**:
- åœ¨ `ApiService.post()` æ–¹æ³•ä¸­æ·»åŠ  `isFormData` å‚æ•°
- å½“ `isFormData = true` æ—¶ï¼Œä½¿ç”¨ `application/x-www-form-urlencoded` æ ¼å¼
- `AuthApiService.login()` æ–¹æ³•è®¾ç½® `isFormData: true`

**å…³é”®ä»£ç **:
```dart
// ApiService.post()
if (isFormData) {
  return _dio.post(
    '$baseUrl$path',
    data: data,
    options: Options(
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      contentType: Headers.formUrlEncodedContentType,
    ),
  );
}

// AuthApiService.login()
final response = await _apiService.post(
  '/auth/login',
  data: {
    'username': phoneOrUsername,
    'password': password,
  },
  isFormData: true,  // æ ‡è®°ä¸º form-urlencoded
);
```

## ğŸ“‹ åç«¯é”™è¯¯å“åº”æ ¼å¼

FastAPI åœ¨é”™è¯¯æ—¶è¿”å›çš„æ ¼å¼ï¼š
```json
{
  "detail": "é”™è¯¯ä¿¡æ¯"
}
```

å¸¸è§é”™è¯¯ä¿¡æ¯ï¼š
- æ³¨å†Œï¼š
  - `"é‚€è¯·ç ä¸ºå¿…å¡«é¡¹"`
  - `"æ‰‹æœºå·å·²å­˜åœ¨"`
  - `"ç”¨æˆ·åå·²å­˜åœ¨"`
  - `"é‚€è¯·ç æ— æ•ˆ"`
  - `"é‚€è¯·ç å·²è¿‡æœŸ"`
  - `"é‚€è¯·ç ä½¿ç”¨æ¬¡æ•°å·²è¾¾ä¸Šé™"`
- ç™»å½•ï¼š
  - `"ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"`
  - `"è¯·å…ˆåŒæ„ç”¨æˆ·é¡»çŸ¥å’Œå…è´£å£°æ˜"`

## âœ… ä¿®å¤åçš„æ•ˆæœ

1. **æ³¨å†Œå¤±è´¥æ—¶**ï¼š
   - æ˜¾ç¤ºåç«¯è¿”å›çš„å…·ä½“é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚"æ‰‹æœºå·å·²å­˜åœ¨"ã€"é‚€è¯·ç æ— æ•ˆ"ç­‰ï¼‰
   - ä¸å†æ˜¾ç¤ºé€šç”¨çš„"æ³¨å†Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥ä¿¡æ¯"

2. **ç™»å½•å¤±è´¥æ—¶**ï¼š
   - æ˜¾ç¤ºåç«¯è¿”å›çš„å…·ä½“é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚"ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"ã€"è¯·å…ˆåŒæ„ç”¨æˆ·é¡»çŸ¥å’Œå…è´£å£°æ˜"ç­‰ï¼‰
   - ä¸å†æ˜¾ç¤ºé€šç”¨çš„"ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç "

3. **ç½‘ç»œé”™è¯¯æ—¶**ï¼š
   - æ˜¾ç¤ºå…·ä½“çš„ç½‘ç»œé”™è¯¯ä¿¡æ¯ï¼ˆå¦‚"è¿æ¥è¶…æ—¶"ã€"ç½‘ç»œè¿æ¥å¤±è´¥"ç­‰ï¼‰

## ğŸ”„ æµ‹è¯•å»ºè®®

1. **æµ‹è¯•æ³¨å†Œé”™è¯¯**ï¼š
   - ä½¿ç”¨å·²å­˜åœ¨çš„æ‰‹æœºå·æ³¨å†Œ â†’ åº”æ˜¾ç¤º"æ‰‹æœºå·å·²å­˜åœ¨"
   - ä½¿ç”¨å·²å­˜åœ¨çš„ç”¨æˆ·åæ³¨å†Œ â†’ åº”æ˜¾ç¤º"ç”¨æˆ·åå·²å­˜åœ¨"
   - ä½¿ç”¨æ— æ•ˆçš„é‚€è¯·ç æ³¨å†Œ â†’ åº”æ˜¾ç¤º"é‚€è¯·ç æ— æ•ˆ"
   - ä¸å¡«å†™é‚€è¯·ç æ³¨å†Œ â†’ åº”æ˜¾ç¤º"é‚€è¯·ç ä¸ºå¿…å¡«é¡¹"

2. **æµ‹è¯•ç™»å½•é”™è¯¯**ï¼š
   - ä½¿ç”¨é”™è¯¯çš„ç”¨æˆ·å/å¯†ç  â†’ åº”æ˜¾ç¤º"ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"
   - ä½¿ç”¨æœªåŒæ„å…è´£å£°æ˜çš„è´¦å·ç™»å½• â†’ åº”æ˜¾ç¤º"è¯·å…ˆåŒæ„ç”¨æˆ·é¡»çŸ¥å’Œå…è´£å£°æ˜"

3. **æµ‹è¯•ç½‘ç»œé”™è¯¯**ï¼š
   - æ–­å¼€ç½‘ç»œåå°è¯•ç™»å½•/æ³¨å†Œ â†’ åº”æ˜¾ç¤ºç½‘ç»œé”™è¯¯ä¿¡æ¯

## ğŸ“ ç›¸å…³æ–‡ä»¶

- `/opt/mop/mobile/lib/services/api/api_service.dart` - API æœåŠ¡åŸºç±»
- `/opt/mop/mobile/lib/services/api/auth_api_service.dart` - è®¤è¯ API æœåŠ¡
- `/opt/mop/mobile/lib/providers/auth_provider.dart` - è®¤è¯çŠ¶æ€ç®¡ç†
