# Jitsi Meet 私有化部署配置
# Docker 自建 Jitsi Meet 集群
# 版本锁定：latest-9242（与 VERSIONS.md 保持一致）

version: '3.8'

services:
  # Jitsi Web 前端
  jitsi_web:
    # 使用稳定版本（Jitsi 官方使用 stable 标签）
    image: jitsi/web:stable
    container_name: jitsi_web
    restart: unless-stopped
    ports:
      - "${JITSI_HTTP_PORT:-8080}:80"
      - "${JITSI_HTTPS_PORT:-8443}:443"
    volumes:
      - ${JITSI_CONFIG_DIR:-/opt/jitsi-meet-cfg}/web:/config:Z
      - ${JITSI_CONFIG_DIR:-/opt/jitsi-meet-cfg}/web/letsencrypt:/etc/letsencrypt:Z
      - ${JITSI_CONFIG_DIR:-/opt/jitsi-meet-cfg}/web/crontabs:/var/spool/cron/crontabs:Z
    environment:
      - ENABLE_AUTH=${JITSI_ENABLE_AUTH:-1}
      - ENABLE_GUESTS=${JITSI_ENABLE_GUESTS:-0}
      - ENABLE_LETSENCRYPT=${JITSI_ENABLE_LETSENCRYPT:-0}
      - ENABLE_HTTP_REDIRECT=${JITSI_ENABLE_HTTP_REDIRECT:-0}
      - ENABLE_TRANSCRIPTIONS=${JITSI_ENABLE_TRANSCRIPTIONS:-0}
      - DISABLE_HTTPS=${JITSI_DISABLE_HTTPS:-0}
      - JICOFO_AUTH_USER=${JITSI_JICOFO_AUTH_USER:-focus}
      - LETSENCRYPT_DOMAIN=${JITSI_LETSENCRYPT_DOMAIN:-}
      - LETSENCRYPT_EMAIL=${JITSI_LETSENCRYPT_EMAIL:-}
      - PUBLIC_URL=${JITSI_PUBLIC_URL:-http://localhost:8080}
      - TZ=Asia/Shanghai
    networks:
      - jitsi_meet
    depends_on:
      - jitsi_prosody
      - jitsi_jicofo

  # Prosody XMPP 服务器
  jitsi_prosody:
    image: jitsi/prosody:stable
    container_name: jitsi_prosody
    restart: unless-stopped
    ports:
      - "${JITSI_XMPP_PORT:-5222}:5222"
      - "${JITSI_XMPP_INTERNAL_PORT:-5347}:5347"
    volumes:
      - ${JITSI_CONFIG_DIR:-/opt/jitsi-meet-cfg}/prosody:/config:Z
    environment:
      - AUTH_TYPE=${JITSI_AUTH_TYPE:-jwt}
      - ENABLE_AUTH=${JITSI_ENABLE_AUTH:-1}
      - ENABLE_GUESTS=${JITSI_ENABLE_GUESTS:-0}
      - ENABLE_IDENTITY_VERIFICATION=${JITSI_ENABLE_IDENTITY_VERIFICATION:-false}
      - XMPP_DOMAIN=${JITSI_XMPP_DOMAIN:-meet.jitsi}
      - XMPP_AUTH_DOMAIN=${JITSI_XMPP_AUTH_DOMAIN:-auth.meet.jitsi}
      - XMPP_GUEST_DOMAIN=${JITSI_XMPP_GUEST_DOMAIN:-guest.meet.jitsi}
      - XMPP_MUC_DOMAIN=${JITSI_XMPP_MUC_DOMAIN:-muc.meet.jitsi}
      - XMPP_INTERNAL_MUC_DOMAIN=${JITSI_XMPP_INTERNAL_MUC_DOMAIN:-internal-muc.meet.jitsi}
      - XMPP_MODULES=${JITSI_XMPP_MODULES:-}
      - XMPP_MUC_MODULES=${JITSI_XMPP_MUC_MODULES:-}
      - XMPP_INTERNAL_MUC_MODULES=${JITSI_XMPP_INTERNAL_MUC_MODULES:-}
      - XMPP_RECORDER_DOMAIN=${JITSI_XMPP_RECORDER_DOMAIN:-recorder.meet.jitsi}
      - JICOFO_COMPONENT_SECRET=${JITSI_JICOFO_COMPONENT_SECRET}
      - JICOFO_AUTH_USER=${JITSI_JICOFO_AUTH_USER:-focus}
      - JICOFO_AUTH_PASSWORD=${JITSI_JICOFO_AUTH_PASSWORD}
      - JVB_AUTH_USER=${JITSI_JVB_AUTH_USER:-jvb}
      - JVB_AUTH_PASSWORD=${JITSI_JVB_AUTH_PASSWORD}
      - JWT_APP_ID=${JITSI_JWT_APP_ID}
      - JWT_APP_SECRET=${JITSI_JWT_APP_SECRET}
      - JWT_ACCEPTED_ISSUERS=${JITSI_JWT_ACCEPTED_ISSUERS:-${JITSI_JWT_APP_ID}}
      - JWT_ACCEPTED_AUDIENCES=${JITSI_JWT_ACCEPTED_AUDIENCES:-${JITSI_PUBLIC_URL}}
      - JWT_ASAP_KEYSERVER=${JITSI_JWT_ASAP_KEYSERVER:-}
      - JWT_ALLOW_EMPTY=${JITSI_JWT_ALLOW_EMPTY:-false}
      - JWT_AUTH_TYPE=${JITSI_JWT_AUTH_TYPE:-token}
      - JWT_TOKEN_AUTH_MODULE=${JITSI_JWT_TOKEN_AUTH_MODULE:-token_verification}
      - LOG_LEVEL=${JITSI_LOG_LEVEL:-INFO}
      - TZ=Asia/Shanghai
    networks:
      - jitsi_meet

  # Jitsi Videobridge
  jitsi_jvb:
    image: jitsi/jvb:stable
    container_name: jitsi_jvb
    restart: unless-stopped
    ports:
      - "${JITSI_JVB_PORT:-10000}:10000/udp"
      - "${JITSI_JVB_TCP_PORT:-4443}:4443/tcp"
    volumes:
      - ${JITSI_CONFIG_DIR:-/opt/jitsi-meet-cfg}/jvb:/config:Z
    environment:
      - DOCKER_HOST_ADDRESS=${JITSI_DOCKER_HOST_ADDRESS:-}
      - XMPP_AUTH_DOMAIN=${JITSI_XMPP_AUTH_DOMAIN:-auth.meet.jitsi}
      - XMPP_INTERNAL_MUC_DOMAIN=${JITSI_XMPP_INTERNAL_MUC_DOMAIN:-internal-muc.meet.jitsi}
      - XMPP_SERVER=${JITSI_XMPP_SERVER:-jitsi_prosody}
      - JVB_AUTH_USER=${JITSI_JVB_AUTH_USER:-jvb}
      - JVB_AUTH_PASSWORD=${JITSI_JVB_AUTH_PASSWORD}
      - JVB_BREWERY_MUC=${JITSI_JVB_BREWERY_MUC:-jvbbrewery}
      - JVB_PORT=${JITSI_JVB_PORT:-10000}
      - JVB_TCP_HARVESTER_DISABLED=${JITSI_JVB_TCP_HARVESTER_DISABLED:-false}
      - JVB_TCP_PORT=${JITSI_JVB_TCP_PORT:-4443}
      - JVB_STUN_SERVERS=${JITSI_JVB_STUN_SERVERS:-meet-jit-si-turnrelay.jitsi.net:443}
      - JVB_ENABLE_APIS=${JITSI_JVB_ENABLE_APIS:-rest,xmpp}
      - JVB_WS_DOMAIN=${JITSI_JVB_WS_DOMAIN:-}
      - JVB_WS_SERVER_ID=${JITSI_JVB_WS_SERVER_ID:-}
      - LOG_LEVEL=${JITSI_LOG_LEVEL:-INFO}
      - TZ=Asia/Shanghai
    networks:
      - jitsi_meet
    depends_on:
      - jitsi_prosody

  # Jitsi Conference Focus
  jitsi_jicofo:
    image: jitsi/jicofo:stable
    container_name: jitsi_jicofo
    restart: unless-stopped
    volumes:
      - ${JITSI_CONFIG_DIR:-/opt/jitsi-meet-cfg}/jicofo:/config:Z
    environment:
      - ENABLE_AUTH=${JITSI_ENABLE_AUTH:-1}
      - XMPP_DOMAIN=${JITSI_XMPP_DOMAIN:-meet.jitsi}
      - XMPP_AUTH_DOMAIN=${JITSI_XMPP_AUTH_DOMAIN:-auth.meet.jitsi}
      - XMPP_INTERNAL_MUC_DOMAIN=${JITSI_XMPP_INTERNAL_MUC_DOMAIN:-internal-muc.meet.jitsi}
      - XMPP_SERVER=${JITSI_XMPP_SERVER:-jitsi_prosody}
      - JICOFO_COMPONENT_SECRET=${JITSI_JICOFO_COMPONENT_SECRET}
      - JICOFO_AUTH_USER=${JITSI_JICOFO_AUTH_USER:-focus}
      - JICOFO_AUTH_PASSWORD=${JITSI_JICOFO_AUTH_PASSWORD}
      - JICOFO_RESERVATION_REST_BASE_URL=${JITSI_JICOFO_RESERVATION_REST_BASE_URL:-}
      - JVB_BREWERY_MUC=${JITSI_JVB_BREWERY_MUC:-jvbbrewery}
      - JIGASI_BREWERY_MUC=${JITSI_JIGASI_BREWERY_MUC:-jigasibrewery}
      - JIGASI_SIP_URI=${JITSI_JIGASI_SIP_URI:-}
      - HOST=${JITSI_XMPP_DOMAIN:-meet.jitsi}
      - XMPP_MUC_DOMAIN=${JITSI_XMPP_MUC_DOMAIN:-muc.meet.jitsi}
      - ENABLE_SCTP=${JITSI_ENABLE_SCTP:-false}
      - TZ=Asia/Shanghai
    networks:
      - jitsi_meet
    depends_on:
      - jitsi_prosody

networks:
  jitsi_meet:
    driver: bridge
